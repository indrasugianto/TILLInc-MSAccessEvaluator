Option Compare Text
Dim TheOperator(1 To 49)
Dim TheOperand(1 To 49)
Global Billapp, g_BeforeUpdate As Variant, g_CurrentRev As String, g_ThisForm As String, g_Passes
Global g_ApplicationNumber, g_JobForm As String
Global g_SelectedRecord, g_Scroll, g_Count, g_ElapsedTime, g_ElapsedTimer, g_deletedItem
Global g_Facets As Variant
Global g_EndPointX As Double, g_ConnectRemotely As Boolean
Global g_EndPointY As Double
Global g_CenterPointX As Double
Global g_CenterPointY As Double
Global g_IntermediatePointX As Double
Global g_IntermediatePointY As Double
Global g_Degrees As Double, g_Date As Date, g_StatusBarMessage, g_theOfficeCost As Currency, g_theShopCost As Currency, g_theInstallCost As Currency
Global px(1 To 3) As Double
Global py(1 To 3) As Double
Global pz(1 To 3) As Double
Global g_Echo, g_EchoFix, g_updatingActivity
Global g_Password, g_Pieces, g_AppName, g_TheAppName, g_CNCCount, g_LastKey
Global g_PasswordName, g_ThisCondition
Global g_delete As Boolean, g_TheDate As Date, g_FormatCount, g_deleteKey
Declare PtrSafe Function GetUserName& Lib "advapi32.dll" Alias "GetUserNameA" (ByVal lpbuffer As String, nsize As Long)



Public Const MAX_WSADescription As Long = 256
Public Const MAX_WSASYSStatus As Long = 128
Public Const ERROR_SUCCESS       As Long = 0
Public Const WS_VERSION_REQD     As Long = &H101
Public Const WS_VERSION_MAJOR    As Long = WS_VERSION_REQD \ &H100 And &HFF&
Public Const WS_VERSION_MINOR    As Long = WS_VERSION_REQD And &HFF&
Public Const MIN_SOCKETS_REQD    As Long = 1
Public Const SOCKET_ERROR        As Long = -1

Public Type HOSTENT
   hName      As Long
   hAliases   As Long
   hAddrType  As Integer
   hLen       As Integer
   hAddrList  As Long
End Type

Public Type WSADATA
   wVersion      As Integer
   wHighVersion  As Integer
   szDescription(0 To MAX_WSADescription)   As Byte
   szSystemStatus(0 To MAX_WSASYSStatus)    As Byte
   wMaxSockets   As Integer
   wMaxUDPDG     As Integer
   dwVendorInfo  As Long
End Type

Public Declare PtrSafe Function WSAGetLastError Lib "wsock32" () As Long

Public Declare PtrSafe Function WSAStartup Lib "wsock32" _
  (ByVal wVersionRequired As Long, _
   lpWSADATA As WSADATA) As Long
   
Public Declare PtrSafe Function WSACleanup Lib "wsock32" () As Long

Public Declare PtrSafe Function gethostname Lib "wsock32" _
  (ByVal szHost As String, _
   ByVal dwHostLen As Long) As Long
   
Public Declare PtrSafe Function gethostbyname Lib "wsock32" _
  (ByVal szHost As String) As Long
   
Public Declare PtrSafe Sub CopyMemory Lib "kernel32" _
   Alias "RtlMoveMemory" _
  (hpvDest As Any, _
   ByVal hpvSource As Long, _
   ByVal cbCopy As Long)

   
 'Option Explicit
''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
' Copyright ï¿½1996-2006 VBnet, Randy Birch, All Rights Reserved.
' Some pages may also contain other copyrights by the author.
''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
' Distribution: You can freely use this code in your own
'               applications, but you may not reproduce
'               or publish this code on any web site,
'               online service, or distribute as source
'               on any media without express permission.
''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
'Private Const ERROR_SUCCESS         As Long = 0
Private Const MAX_DOMAIN_NAME_LEN   As Long = 128
Private Const MAX_HOSTNAME_LEN      As Long = 128
Private Const MAX_SCOPE_ID_LEN      As Long = 256

Private Type IP_ADDRESS_STRING
    IpAddr(0 To 15)  As Byte
End Type

Private Type IP_MASK_STRING
    IpMask(0 To 15)  As Byte
End Type

Private Type IP_ADDR_STRING
    dwNext     As Long
    IpAddress  As IP_ADDRESS_STRING
    IpMask     As IP_MASK_STRING
    dwContext  As Long
End Type

Private Type FIXED_INFO
  HostName(0 To (MAX_HOSTNAME_LEN + 3))         As Byte
  DomainName(0 To (MAX_DOMAIN_NAME_LEN + 3))    As Byte
  CurrentDnsServer   As IP_ADDR_STRING
  DnsServerList      As IP_ADDR_STRING
  NodeType           As Long
  ScopeId(0 To (MAX_SCOPE_ID_LEN + 3))          As Byte
  EnableRouting      As Long
  EnableProxy        As Long
  EnableDns          As Long
End Type

Private Declare PtrSafe Function GetNetworkParams Lib "iphlpapi.dll" _
  (pFixedInfo As Any, _
   pOutBufLen As Long) As Long
Private Const MAX_ADAPTER_NAME_LENGTH         As Long = 256
Private Const MAX_ADAPTER_DESCRIPTION_LENGTH  As Long = 128
Private Const MAX_ADAPTER_ADDRESS_LENGTH      As Long = 8




Private Type IP_ADAPTER_INFO
  dwNext                As Long
  ComboIndex            As Long  'reserved
  sAdapterName(0 To (MAX_ADAPTER_NAME_LENGTH + 3))        As Byte
  sDescription(0 To (MAX_ADAPTER_DESCRIPTION_LENGTH + 3)) As Byte
  dwAddressLength       As Long
  sIPAddress(0 To (MAX_ADAPTER_ADDRESS_LENGTH - 1))       As Byte
  dwIndex               As Long
  uType                 As Long
  uDhcpEnabled          As Long
  CurrentIpAddress      As Long
  IpAddressList         As IP_ADDR_STRING
  GatewayList           As IP_ADDR_STRING
  DhcpServer            As IP_ADDR_STRING
  bHaveWins             As Long
  PrimaryWinsServer     As IP_ADDR_STRING
  SecondaryWinsServer   As IP_ADDR_STRING
  LeaseObtained         As Long
  LeaseExpires          As Long
End Type

Private Declare PtrSafe Function GetAdaptersInfo Lib "iphlpapi.dll" _
  (pTcpTable As Any, _
   pdwSize As Long) As Long
Private Const WSADescription_Len As Long = 256
Private Const WSASYS_Status_Len As Long = 128
Private Const IP_SUCCESS As Long = 0
Private Const AF_INET As Long = 2



  


Private Declare PtrSafe Function inet_addr Lib "wsock32" _
  (ByVal s As String) As Long

Private Declare PtrSafe Function gethostbyaddr Lib "wsock32" _
  (haddr As Long, _
   ByVal hnlen As Long, _
   ByVal addrtype As Long) As Long


   
Private Declare PtrSafe Function lstrlen Lib "kernel32" _
   Alias "lstrlenA" _
  (lpString As Any) As Long


Public Declare PtrSafe Function GetSystemMetrics32 Lib "User32" _
    Alias "GetSystemMetrics" (ByVal nIndex As Long) As Long



   

   
Private Declare PtrSafe Function URLDownloadToFile Lib "urlmon" _
   Alias "URLDownloadToFileA" _
  (ByVal pCaller As Long, _
   ByVal szURL As String, _
   ByVal szFileName As String, _
   ByVal dwReserved As Long, _
   ByVal lpfnCB As Long) As Long
   
Private Declare PtrSafe Function DeleteUrlCacheEntry Lib "Wininet.dll" _
   Alias "DeleteUrlCacheEntryA" _
  (ByVal lpszUrlName As String) As Long
      
Private Declare PtrSafe Function lstrlenW Lib "kernel32" _
  (ByVal lpString As Long) As Long

Private Const ENUM_CURRENT_SETTINGS As Long = -1
Private Const DISPLAY_DEVICE_ATTACHED_TO_DESKTOP As Long = &H1
Private Const CCHDEVICENAME As Long = 32
Private Const CCHFORMNAME As Long = 32

Private Type DISPLAY_DEVICE
  cb As Long
  DeviceName As String * CCHDEVICENAME
  DeviceString As String * 128
  StateFlags As Long
  DeviceID As String * 128
  DeviceKey As String * 128
End Type

Private Type DEVMODE
  dmDeviceName As String * CCHDEVICENAME
  dmSpecVersion As Integer
  dmDriverVersion As Integer
  dmSize As Integer
  dmDriverExtra As Integer
  dmFields As Long
  dmOrientation As Integer
  dmPaperSize As Integer
  dmPaperLength As Integer
  dmPaperWidth As Integer
  dmScale As Integer
  dmCopies As Integer
  dmDefaultSource As Integer
  dmPrintQuality As Integer
  dmColor As Integer
  dmDuplex As Integer
  dmYResolution As Integer
  dmTTOption As Integer
  dmCollate As Integer
  dmFormName As String * CCHFORMNAME
  dmLogPixels As Integer
  dmBitsPerPel As Long
  dmPelsWidth As Long
  dmPelsHeight As Long
  dmDisplayFlags As Long
  dmDisplayFrequency As Long
End Type

Private Declare PtrSafe Function EnumDisplayDevices Lib "user32.dll" Alias "EnumDisplayDevicesA" (ByVal lpDevice As String, ByVal iDevNum As Long, ByRef lpDisplayDevice As DISPLAY_DEVICE, ByVal dwFlags As Long) As Long
Private Declare PtrSafe Function EnumDisplaySettings Lib "user32.dll" Alias "EnumDisplaySettingsA" (ByVal lpszDeviceName As String, ByVal iModeNum As Long, ByRef lpDevMode As DEVMODE) As Long


Private Sub Form_Load()

   Command1.Caption = "Get Public IP"
   
   Text1.Text = LocalIPAddress()
   Text2.Text = ""
   
End Sub


Private Sub Command1_Click()

   Text2.Text = GetPublicIP()
   
End Sub



Private Function GetPublicIP()

   Dim sSourceUrl As String
   Dim sLocalFile As String
   Dim hfile As Long
   Dim buff As String
   Dim pos1 As Long
   Dim pos2 As Long
   
   'MsgBox ("http://www.whatismyip.com/automation/n09230945.asp")
   
  'site returning IP address
   sSourceUrl = "http://www.dslreports.com/whois" '"http://www.whatismyip.com/automation/n09230945.asp" '"http://vbnet.mvps.org/resources/tools/getpublicip.shtml"
   sLocalFile = "c:\access\ip.txt"
   
  'ensure this file does not exist in the cache
   Call DeleteUrlCacheEntry(sSourceUrl)

  'download the public IP file,
  'read into a buffer and delete
   If DownloadFile(sSourceUrl, sLocalFile) Then
   
      hfile = FreeFile
      
      Open sLocalFile For Input As #hfile
         buff = Input$(LOF(hfile), hfile)
      Close #hfile


     'look for the IP line
      'pos1 = InStr(buff, "var ip =")
    
     'if found,
      'If pos1 Then
   
        'get position of first and last single
        'quotes around address (e.g. '11.22.33.44')
         pos1 = InStr(pos1 + 1, buff, "'", vbTextCompare) + 1
         pos2 = InStr(pos1 + 1, buff, "'", vbTextCompare) '- 1
      
        'return the IP address
         GetPublicIP = buff 'Mid$(buff, pos1, pos2 - pos1)

      'Else
      
         'GetPublicIP = "(unable to parse IP)"
      
      'End If  'pos1
      
      Kill sLocalFile
   
   Else
      
      GetPublicIP = "(unable to access shtml page)"
      
   End If  'DownloadFile
   
End Function


Private Function DownloadFile(ByVal sURL As String, _
                             ByVal sLocalFile As String) As Boolean
   
   DownloadFile = URLDownloadToFile(0, sURL, sLocalFile, 0, 0) = ERROR_SUCCESS
   
End Function


Public Function LocalIPAddress() As String
   
   Dim cbRequired As Long
   Dim buff() As Byte
   Dim ptr1 As Long
   Dim sIPAddr As String
   Dim Adapter As IP_ADAPTER_INFO
   
   Call GetAdaptersInfo(ByVal 0&, cbRequired)

   If cbRequired > 0 Then
    
      ReDim buff(0 To cbRequired - 1) As Byte
      
      If GetAdaptersInfo(buff(0), cbRequired) = ERROR_SUCCESS Then
      
        'get a pointer to the data stored in buff()
         ''''ptr1 = VarPtr(buff(0))

         Do While (ptr1 <> 0)
         
           'copy the data from the pointer to the
           'first adapter into the IP_ADAPTER_INFO type
            CopyMemory Adapter, ByVal ptr1, LenB(Adapter)
         
            With Adapter
                       
              'the DHCP IP address is in the
              'IpAddress.IpAddr member
                 
               sIPAddr = TrimNull(StrConv(.IpAddressList.IpAddress.IpAddr, vbUnicode))
                  
               If Len(sIPAddr) > 0 Then Exit Do

               ptr1 = .dwNext
                              
            End With  'With Adapter
            
        'ptr1 is 0 when (no more adapters)
         Loop  'Do While (ptr1 <> 0)

      End If  'If GetAdaptersInfo
   End If  'If cbRequired > 0

  'return any string found
   LocalIPAddress = sIPAddr
   
End Function


Private Function TrimNull(startstr As String) As String

   ''''TrimNull = Left$(startstr, lstrlenW(StrPtr(startstr)))
   
End Function
  
  
  

  
Private Function SocketsInitialize() As Boolean

   Dim WSAD As WSADATA
   
   SocketsInitialize = WSAStartup(WS_VERSION_REQD, WSAD) = IP_SUCCESS
    
End Function


Private Sub SocketsCleanup()
   
   If WSACleanup() <> 0 Then
       MsgBox "Windows Sockets error occurred in Cleanup.", vbExclamation
   End If
    
End Sub


Private Function GetHostNameFromIP(ByVal sAddress As String) As String

   Dim ptrHosent As Long
   Dim hAddress As Long
   Dim nbytes As Long
   
   If SocketsInitialize() Then

     'convert string address to long
      hAddress = inet_addr(sAddress)
      
      If hAddress <> SOCKET_ERROR Then
         
        'obtain a pointer to the HOSTENT structure
        'that contains the name and address
        'corresponding to the given network address.
         ptrHosent = gethostbyaddr(hAddress, 4, AF_INET)
   
         If ptrHosent <> 0 Then
         
           'convert address and
           'get resolved hostname
            CopyMemory ptrHosent, ByVal ptrHosent, 4
            nbytes = lstrlen(ByVal ptrHosent)
         
            If nbytes > 0 Then
               sAddress = Space$(nbytes)
               CopyMemory ByVal sAddress, ByVal ptrHosent, nbytes
               GetHostNameFromIP = sAddress
            End If
         
         Else
            MsgBox "Call to gethostbyaddr failed."
         End If 'If ptrHosent
      
      SocketsCleanup
      
      Else
         MsgBox "String passed is an invalid IP."
      End If 'If hAddress
   
   Else
      MsgBox "Sockets failed to initialize."
   End If  'If SocketsInitialize
      
End Function
   
   


   
Private Function DhcpServerAddress() As String
   
  'api vars
   Dim cbRequired  As Long
   Dim buff()      As Byte
   Dim Adapter     As IP_ADAPTER_INFO
   Dim AdapterStr  As IP_ADDR_STRING
    
  'working vars
   Dim ptr1        As Long
   Dim ptr2        As Long
   Dim sIPAddr     As String
   Dim found       As Boolean
   
   Call GetAdaptersInfo(ByVal 0&, cbRequired)

   If cbRequired > 0 Then
    
      ReDim buff(0 To cbRequired - 1) As Byte
      
      If GetAdaptersInfo(buff(0), cbRequired) = ERROR_SUCCESS Then
      
        'get a pointer to the data stored in buff()
         ''''ptr1 = VarPtr(buff(0))

         Do While (ptr1 <> 0) And (found = False)
         
           'copy the data from the pointer to the
           'first adapter into the IP_ADAPTER_INFO type
            CopyMemory Adapter, ByVal ptr1, LenB(Adapter)
         
            With Adapter
         
               If .uDhcpEnabled Then
  
                 'the DHCP info is in the DhcpServer
                 'member of IP_ADAPTER_INFO. This is
                 'in the IP_ADDR_STRING format, so
                 'it needs to be copied to the
                 'IP_ADDR_STRING type
                  ''''ptr2 = VarPtr(.DhcpServer)
               
                 'again, the IP_ADDR_STRING type has a
                 'dwNext member, indicating that more
                 'than one DHCP server may be listed,
                 'so another loop is needed
                  Do While (ptr2 <> 0)
               
                     CopyMemory AdapterStr, ByVal ptr2, LenB(AdapterStr)
                  
                     With AdapterStr
                  
                       'the IP address of the DHCP
                       'server for this adapter.
                        sIPAddr = TrimNull(StrConv(.IpAddress.IpAddr, vbUnicode))
                     
                       'if something returned, exit the loop
                       'by setting a flag
                        If Len(sIPAddr) > 0 Then
                           found = True
                           Exit Do
                        End If
                  
                       'check for another server
                        ptr2 = .dwNext
                  
                     End With  'With AdapterStr
                  Loop  'Do While (ptr2 <> 0)
            
               End If  'If .uDhcpEnabled
               
              'check for another adapter
               ptr1 = .dwNext
               
            End With  'With Adapter
            
        'ptr1 is 0 when (no more adapters)
         Loop  'Do While (ptr1 <> 0)

      End If  'If GetAdaptersInfo
   End If  'If cbRequired > 0

  'return any string found
   DhcpServerAddress = sIPAddr
   
End Function

Public Function ExportComponentCosts()

'EchoOff
'On Error GoTo 0
g_StopExecution = False
If InStr(Screen.ActiveForm.Name, "Master") <> 0 Then
    Form_ProductList.StopExecution.Visible = True
Else
    Forms!PartsList!StopExecution.Visible = True
End If
SetMyDB
Dim sequenceNo As String, i As Integer, ii As Integer, ActivityName As String
TheCount = 0: theErrors = 0
'''g_theShopCost = Variable("Shop hrly cost estimate")
Settings.FindFirst "Instr(RateUnits,'Minute')<>0"
'If InStr(Screen.ActiveForm.Name, "Master") <> 0 Then
    'g_theShopCost = Settings!RateAmountAlternate * 60
'Else
    'If InStr(Forms!PartsList!ProcessAlternate, "Alternate") <> 0 Then
        'g_theShopCost = Settings!RateAmountAlternate * 60
    'Else
        'g_theShopCost = Settings!RateAmount * 60
    'End If
'End If
Dim ProcessCost As Currency, MaterialCost As Currency, theLaborCost As Currency
Dim addSet As DAO.Recordset, estimateSet As DAO.Recordset, activitySet As DAO.Recordset, componentSet As DAO.Recordset, descriptionSet As DAO.Recordset
If IsNull(Form_ProductList.JobName) Then MsgBox "Select a job": Exit Function


GoTo skipOver
Set estimateSet = mydb.OpenRecordset("Select * from [Estimates] where ImportParts=True and Job=" & Form_ProductList.JobName, dbOpenDynaset, dbSeeChanges)
If estimateSet.RecordCount <> 0 Then
    With estimateSet
        .MoveLast
        StatusBarMessage "Clearing " & .RecordCount & " components of imports"
        DoEvents
        .MoveFirst
        Do Until .EOF
            If g_StopExecution Then
                g_StopExecution = False
                StatusBarMessage " "
                If InStr(Screen.ActiveForm.Name, "Master") <> 0 Then
                    Form_ProductList.StopExecution.Visible = False
                Else
                    Forms!PartsList!StopExecution.Visible = False
                End If
                StatusBarMessage "Stopped execution"
                Exit Function
            End If
            StatusBarMessage "Clearing imports from " & SQLResult("Select Component from Components where key =" & !Component)
            DoEvents
            For i = 0 To .Fields.Count - 1
                If .Fields(i).Name = "Material" Then
                    .Edit
                    .Fields(i).Value = Null
                    .Update
                End If
                If .Fields(i).Name = "Inventory" Then
                    .Edit
                    .Fields(i).Value = Null
                    .Update
                End If
                If InStr(.Fields(i).Name, "Import") <> 0 And InStr(.Fields(i).Name, "Parts") = 0 Then
                    If .Fields(i).Value <> 0 Then
                        .Edit
                        .Fields(i).Value = 0
                        .Update
                        sequenceNo = Right(.Fields(i).Name, Len(.Fields(i).Name) - 6)
                        For ii = 0 To .Fields.Count - 1
                            If .Fields(ii).Name = sequenceNo Or .Fields(ii).Name = sequenceNo & "cost" Then
                                TheCount = TheCount + 1
                                .Edit
                                .Fields(ii).Value = Null
                                .Update
                            End If
                        Next ii
                    End If
                End If
            Next i
           .MoveNext
        Loop
    End With
End If
StatusBarMessage "Cleared " & TheCount & " component imports"
DoEvents
'ErrorLogClear
skipOver:
'Set addSet = mydb.OpenRecordset("Select * from [>Part List] where nnez(ProcessComponent)<>0 and nnez(ProductList)=" & Form_ProductList.ProductListName & " Order by ProcessComponent, nnez(ProcessActivity) asc", dbOpenSnapshot, dbSeeChanges)
Set addSet = mydb.OpenRecordset("SELECT * from [>Part List] WHERE nnez(ProductList)='" & Form_ProductList.ProductListName & "' and nnez(ProcessActivity)=0 and nnez(ProcessCost)<>0", dbOpenSnapshot, dbSeeChanges)
If addSet.RecordCount <> 0 Then
    'If MessageYesNo("Item " & addSet!ItemNumber & " process cost without process activity.  Continue export?") = "No" Then GoTo StopExecution
    ErrorLogEntry ("Item " & addSet!ItemNumber & " process cost without process activity")
End If

'Set addSet = mydb.OpenRecordset("SELECT * from [>Part List] WHERE nnez(ProductList)='" & Form_ProductList.ProductListName & "' and nnez(ProcessActivity)<>0 and nnez(ProcessCost)=0", dbOpenSnapshot, dbSeeChanges)
'If addSet.RecordCount <> 0 Then
    'If MessageYesNo("Item " & addSet!ItemNumber & " process activity without process cost") = "No" Then GoTo StopExecution
    'ErrorLogEntry ("Item " & addSet!ItemNumber & " process activity without process cost")
'End If
Set addSet = mydb.OpenRecordset("SELECT [>Part List].* FROM [>Product Lists] INNER JOIN [>Part List] ON [>Product Lists].Key = nnez([>Part List].ProductList) WHERE [>Product Lists].Job=" & [Forms]![productlistmaster]![ProductListControl]![JobName] & " AND [>Product Lists].IncludeInEstimate=True AND nnez(ProcessComponent)<>0 Order by ProcessComponent, nnez(ProcessActivity) asc", dbOpenSnapshot, dbSeeChanges)
If addSet.RecordCount = 0 Then
    MsgBox "Item " & addSet!ItemNumber & " process activity without process cost"
    GoTo StopExecution
End If
addSet.MoveLast
theEOF = addSet.RecordCount
addSet.MoveFirst
TheCount = 1
lastComponent = addSet!ProcessComponent
lastactivity = NNEZ(addSet!ProcessActivity)
'If lastactivity = 0 Then MsgBox ""

GoSub getComponent
Do Until addSet.EOF
    If g_StopExecution Then
StopExecution:
        g_StopExecution = False
        StatusBarMessage " "
        If InStr(Screen.ActiveForm.Name, "Master") <> 0 Then
            Form_ProductList.StopExecution.Visible = False
        Else
            Forms!PartsList!StopExecution.Visible = False
        End If
        StatusBarMessage "Stopped execution"
        Exit Function
    End If
    If TheCount = theEOF Or NNEZ(lastactivity) <> NNEZ(addSet!ProcessActivity) Or lastComponent <> addSet!ProcessComponent Then
exportComponent:
        If TheCount = theEOF Then
            ProcessCost = ProcessCost + NNEZ(addSet!ProcessCost)
            MaterialCost = MaterialCost + NNEZ(addSet!MaterialCost)
        End If
        estimateSet.Edit
        For i = 0 To estimateSet.Fields.Count - 1
            If NNEZ(lastactivity) <> 0 And ProcessCost <> 0 Then
                If estimateSet.Fields(i).Name = activitySet!Sequence Then
                    'estimateSet.Fields(i) = ProcessCost / theLaborCost '(activitySet!LaborRate + activitySet!Overhead), 2)
                    estimateSet.Fields(i) = NNEZ(estimateSet.Fields(i)) + Round(ProcessCost / theLaborCost, 3) '(activitySet!LaborRate + activitySet!Overhead), 2)
                    If estimateSet.Fields(i) = 0 Then estimateSet.Fields(i) = 0.001 'Round(ProcessCost / (activitySet!LaborRate + activitySet!Overhead), 3)
                End If
                If estimateSet.Fields(i).Name = activitySet!Sequence & "Cost" Then
                    estimateSet.Fields(i) = NNEZ(estimateSet.Fields(i)) + Round(ProcessCost, 2)
                End If
                If estimateSet.Fields(i).Name = "Import" & activitySet!Sequence Then
                    estimateSet.Fields(i) = True
                End If
            End If
            If NNEZ(MaterialCost) <> 0 Then
                If estimateSet.Fields(i).Name = "Inventory" Then
                    estimateSet.Fields(i).Value = NNEZ(estimateSet.Fields(i).Value) + Round(MaterialCost, 2)
                End If
                If estimateSet.Fields(i).Name = "ImportInventory" Then
                    estimateSet.Fields(i).Value = True
                End If
            End If
        Next i
        estimateSet.Update
        If NNEZ(lastactivity) = 0 And ProcessCost <> 0 Then
            ErrorLogEntry "Missing Component " & componentSet!Component & " Activity for Process cost of " & Format(ProcessCost, "$#,#.00")
            theErrors = theErrors + 1
            TotalProcessMissing = TotalProcessMissing + ProcessCost
        End If
        ProcessCost = 0
        MaterialCost = 0
        StatusBarMessage "Exporting " & componentSet!Component & " " & ActivityName
        DoEvents
        lastactivity = NNEZ(addSet!ProcessActivity)
        If NNEZ(lastactivity) <> 0 Then
            Set activitySet = mydb.OpenRecordset("select *  from [Activity] where Key=" & lastactivity, dbOpenSnapshot, dbSeeChanges)
            ActivityName = activitySet!Description
            ActivityCategory = activitySet!Charge
            If activitySet!Charge = "Project" Then
                theLaborCost = g_theOfficeCost
            ElseIf activitySet!Charge = "Installation" Then
                theLaborCost = g_theInstallCost
            Else
                theLaborCost = g_theShopCost
            End If
        Else
            ActivityName = "no Activity"
            theLaborCost = g_theShopCost
        End If
        'Pause 1
    End If
    If lastComponent <> addSet!ProcessComponent Then
        lastComponent = addSet!ProcessComponent
        lastactivity = NNEZ(addSet!ProcessActivity)
        GoSub getComponent
    End If
    ProcessCost = ProcessCost + NNEZ(addSet!ProcessCost)
    MaterialCost = MaterialCost + NNEZ(addSet!MaterialCost)
    TheCount = TheCount + 1
    addSet.MoveNext
Loop
exitExportComponent:
ProcessCost = 0
MaterialCost = 0
If TotalProcessMissing <> 0 Then ErrorLogEntry "Missing total Component Activity Process cost of " & Format(TotalProcessMissing, "$#,#.00")
'Activities with no component
Set addSet = mydb.OpenRecordset("Select * from [>Part List] where nnez(ProcessComponent)=0 and nnez(ProcessActivity)<>0 and nnez(ProductList)=" & Form_ProductList.ProductListName & " Order by ProcessActivity", dbOpenSnapshot, dbSeeChanges)
Set componentSet = mydb.OpenRecordset("select *  from [Components] where Component='None'", dbOpenSnapshot, dbSeeChanges)
If addSet.RecordCount <> 0 Then
    With addSet
    lastactivity = !ProcessActivity
    Set activitySet = mydb.OpenRecordset("select *  from [Activity] where Key=" & lastactivity, dbOpenSnapshot, dbSeeChanges)
    ProcessCost = 0
    Do Until .EOF
        If !ProcessActivity = lastactivity Then
            ProcessCost = ProcessCost + NNEZ(!ProcessCost)
        Else
exportActivity:
            If ProcessCost <> 0 Then
                StatusBarMessage "Exporting to E app " & componentSet!Component & " " & activitySet!Description
                DoEvents
                
                'check for PL component to merge first
                Set estimateSet = mydb.OpenRecordset("Select * from [Estimates] where ImportPL=True and Description is null and Component=" & componentSet!Key & " and Job=" & Form_ProductList.JobName, dbOpenDynaset, dbSeeChanges)
                If estimateSet.RecordCount = 0 Then
                    Set estimateSet = mydb.OpenRecordset("Select * from [Estimates] where ImportParts=True and Component=" & componentSet!Key & " and Job=" & Form_ProductList.JobName, dbOpenDynaset, dbSeeChanges)
                End If
                
                
                
                If estimateSet.RecordCount = 0 Then
                    estimateSet.AddNew
                    estimateSet!Job = Form_ProductList.JobName
                    estimateSet!Component = componentSet!Key
                    estimateSet!Sequence = componentSet!Sequence
                    estimateSet!ImportParts = True
                    estimateSet.Update
                    estimateSet.MoveLast
                ElseIf estimateSet.RecordCount <> 1 Then
                    estimateSet.MoveFirst
                    Do Until estimateSet.EOF
                        Set descriptionSet = mydb.OpenRecordset("Select * from [Estimates] where ImportParts=True and Component=" & componentSet!Key & " and Description='" & estimateSet!Description & "' and Job=" & Form_ProductList.JobName, dbOpenSnapshot, dbSeeChanges)
                        If descriptionSet.RecordCount <> 1 Then
                            MsgBox "Export was canceled because there are more than one " & componentSet!Component & " " & estimateSet!Description & " Part List Import components in the estimate.": Exit Function
                        End If
                        estimateSet.MoveNext
                    Loop
                Else
                    estimateSet.Edit
                    estimateSet!ImportParts = True
                    estimateSet.Update
                    End If
                For i = 0 To estimateSet.Fields.Count - 1
                    If estimateSet.Fields(i).Name = activitySet!Sequence Then
                        estimateSet.Edit
                        estimateSet!ImportParts = True
                        estimateSet.Fields(i) = NNEZ(estimateSet.Fields(i)) + Round(ProcessCost / theLaborCost, 3) '(activitySet!LaborRate + activitySet!Overhead), 2)
                        If estimateSet.Fields(i) = 0 Then estimateSet.Fields(i) = 0.01 'Round(ProcessCost / (activitySet!LaborRate + activitySet!Overhead), 3)
                        'If estimateSet.Fields(i) = 0 Then estimateSet.Fields(i) = Round(ProcessCost / g_theshopCost, 4) '(activitySet!LaborRate + activitySet!Overhead), 4)
                        estimateSet.Update
                    End If
                    If estimateSet.Fields(i).Name = activitySet!Sequence & "Cost" Then
                        estimateSet.Edit
                        estimateSet.Fields(i) = NNEZ(estimateSet.Fields(i)) + ProcessCost
                        estimateSet.Update
                    End If
                    If estimateSet.Fields(i).Name = "Import" & activitySet!Sequence Then
                        estimateSet.Edit
                        estimateSet.Fields(i) = True
                        estimateSet.Update
                    End If
                Next i
                ProcessCost = 0
            End If
            If addSet.EOF Then GoTo exitExportActivity
            lastactivity = !ProcessActivity
            Set activitySet = mydb.OpenRecordset("select *  from [Activity] where Key=" & lastactivity, dbOpenSnapshot, dbSeeChanges)
        End If
        .MoveNext
    Loop
    End With
End If
GoTo exportActivity
exitExportActivity:

'Costs with no component or activity
MaterialCost = 0: ProcessCost = 0
StatusBarMessage "Checking for costs without component and activity"
DoEvents
Set addSet = mydb.OpenRecordset("Select * from [>Part List] where nnez(ProcessComponent)=0 and nnez(ProcessActivity)=0 and nnez(ProductList)=" & Form_ProductList.ProductListName, dbOpenSnapshot, dbSeeChanges)
If addSet.RecordCount <> 0 Then
    With addSet
        Do Until .EOF
            MaterialCost = MaterialCost + NNEZ(!MaterialCost)
            ProcessCost = ProcessCost + NNEZ(!ProcessCost)
            .MoveNext
        Loop
    End With
End If
If MaterialCost <> 0 Then ErrorLogEntry "Missing total Material cost without compononent and activity: " & Format(MaterialCost, "$#,#.00"): theErrors = theErrors + 1
If ProcessCost <> 0 Then ErrorLogEntry "Missing total Process cost without compononent and activity: " & Format(ProcessCost, "$#,#.00"): theErrors = theErrors + 1
updateEstimate:
'Set componentSet = mydb.OpenRecordset("select *  from [Components] where Component='Additional Cost'", dbOpenSnapshot, dbSeeChanges)
'If componentSet.RecordCount <> 0 Then
    'Set estimateSet = mydb.OpenRecordset("Select * from [Estimates] where Component=" & componentSet!Key & " and Job=" & Form_ProductList.JobName, dbOpenDynaset, dbSeeChanges)
    'If estimateSet.RecordCount = 0 Then
        'estimateSet.AddNew
        'estimateSet!Job = Form_ProductList.JobName
        'estimateSet!Component = componentSet!Key
        'estimateSet!Sequence = componentSet!Sequence
    'Else
        'estimateSet.Edit
    'End If
    'estimateSet!Updated = Now
    'estimateSet.Update
'Else
    'MsgBox "Refresh Estimate"
'End If
Dim jobSet As DAO.Recordset
Set jobSet = mydb.OpenRecordset("Select LastEstimateExport from [>Jobs] where Key=" & Form_ProductList.JobName, dbOpenDynaset, dbSeeChanges)
jobSet.Edit
jobSet!LastEstimateExport = Now
jobSet.Update
StatusBarMessage "Checking for merged components"

Set componentSet = mydb.OpenRecordset("SELECT Sequence, Component, ImportPL, ImportParts, ImportMerge FROM Estimates  where Job =" & Form_ProductList.JobName & " And Description Is Null  and ImportPL=True  and ImportParts=True ORDER BY Sequence, Component", dbOpenDynaset, dbSeeChanges)
If componentSet.RecordCount <> 0 Then
    componentSet.MoveFirst
    'lastComponent = 0
    Do Until componentSet.EOF
    'If lastComponent = componentSet!Component Then
        'componentSet.MovePrevious
        componentSet.Edit
        componentSet!importPL = False
        componentSet!ImportParts = False
        componentSet!ImportMerge = True
        componentSet.Update
        'componentSet.MoveNext
        'componentSet.Edit
        'componentSet!ImportPL = False
        'componentSet!ImportParts = False
        'componentSet!ImportMerge = True
        'componentSet.Update
    'End If
    'lastComponent = componentSet!Component
    componentSet.MoveNext
    Loop
End If

'delete empty components
Set estimateSet = mydb.OpenRecordset("Select * from [Estimates] where Job=" & Form_ProductList.JobName & " Order by Sequence", dbOpenDynaset, dbSeeChanges)
TheCount = 0
StatusBarMessage "Checking for empty components"
If estimateSet.RecordCount <> 0 Then
    With estimateSet
        .MoveFirst
        Do Until .EOF
            If !importPL = 0 And !ImportParts = 0 And !ImportMerge = 0 Then
            Else
                For i = 0 To .Fields.Count - 1
                    If .Fields(i).Name = "Material" Then
                        If .Fields(i).Value <> Null Then GoTo getNextComponent
                    End If
                    If .Fields(i).Name = "Inventory" Then
                        If .Fields(i).Value <> Null Then GoTo getNextComponent
                    End If
                    If InStr(.Fields(i).Name, "Import") = 0 Then
                    ElseIf InStr(.Fields(i).Name, "PL") = 0 And InStr(.Fields(i).Name, "Parts") = 0 And InStr(.Fields(i).Name, "Merge") = 0 Then
                        If .Fields(i).Value <> 0 Then GoTo getNextComponent
                    End If
                Next i
                TheCount = TheCount + 1
                StatusBarMessage "Deleted " & TheCount & " empty component(s)"
                .Delete
            End If
getNextComponent:
        .MoveNext
        Loop
    End With
End If
StatusBarMessage "Finished export"
Pause 2
StatusBarMessage " "

If theErrors <> 0 Then
    ErrorLogReport theErrors
End If
EchoOn
If InStr(Screen.ActiveForm.Name, "Master") <> 0 Then
    Form_ProductList.StopExecution.Visible = False
Else
    Forms!PartsList!StopExecution.Visible = False
End If
Exit Function

getComponent:
Set componentSet = mydb.OpenRecordset("select *  from [Components] where Key=" & lastComponent, dbOpenSnapshot, dbSeeChanges)
If NNEZ(lastactivity) <> 0 Then
    Set activitySet = mydb.OpenRecordset("select *  from [Activity] where Key=" & lastactivity, dbOpenSnapshot, dbSeeChanges)
    ActivityName = activitySet!Description
Else
    ActivityName = "no Activity"
End If

'look for PL component to merge first
Set estimateSet = mydb.OpenRecordset("Select * from [Estimates] where ImportPL=True and Description is null and Component=" & componentSet!Key & " and Job=" & Form_ProductList.JobName, dbOpenDynaset, dbSeeChanges)

If estimateSet.RecordCount = 0 Then
    Set estimateSet = mydb.OpenRecordset("Select * from [Estimates] where ImportParts=True and Component=" & componentSet!Key & " and Job=" & Form_ProductList.JobName, dbOpenDynaset, dbSeeChanges)
Else
    estimateSet.Edit
    estimateSet!ImportParts = True
    estimateSet.Update
End If
If estimateSet.RecordCount = 0 Then
    estimateSet.AddNew
    estimateSet!Job = Form_ProductList.JobName
    estimateSet!Component = componentSet!Key
    estimateSet!Sequence = componentSet!Sequence
    estimateSet!ImportParts = True
    estimateSet.Update
    estimateSet.MoveLast
Else
    estimateSet.MoveLast
    If estimateSet.RecordCount <> 1 Then MsgBox "Export was canceled because there are more than one " & componentSet!Component & " Part List Import components in the estimate.": Exit Function
End If


Return

End Function

Public Function ExportExtraCosts()

If InStr(NNEN(LocalVariable("Revit_List")), "Revit") <> 0 Then
   MsgBox "This function not supported for Revit lists"
   Exit Function
End If
On Error GoTo ExportError
If IsNull(Form_ProductList.JobName) Then MsgBox "Select a job": Exit Function
'EchoOff
SetMyDB
g_StopExecution = False
ErrorLogClear
'StatusBarMessage "Exporting extra costs"
DoEvents
Dim addSet As DAO.Recordset, estimateSet As DAO.Recordset, componentSet As DAO.Recordset, descriptionSet As DAO.Recordset, jobSet As DAO.Recordset, partSet As DAO.Recordset, listSet As DAO.Recordset
Dim Inventory As Currency, specialmaterial As Currency, OS As Currency, pListsSet As DAO.Recordset
Dim OfficeHours As Currency, ShopHours As Currency, FinishHours As Currency, AssemblyHours As Currency, InstallHours As Currency
Dim theComponentName As String

'compare PL to partlist
'If LocalVariable("ScratchPad") = "" Then GoTo skipThis
Dim theDiff As Currency
theDiff = 0
'EchoOff
Dim totalPartCost As Currency, totalListCost As Currency, partItemCost As Currency
StatusBarMessage "Checking product cost"
totalPartCost = 0: totalListCost = 0: ThisItem = 0
'Set listSet = mydb.OpenRecordset("Select IncludeInEstimate from [>Product Lists] where Key=" & Form_ProductList.ProductListName, dbOpenSnapshot, dbSeeChanges)
'If Not listSet!IncludeInEstimate Then
If Not Form_ProductList.IncludeInEstimate Then
    MsgBox "This List is not included in an estimate.  Please either include this list in an estimate or select a list that is included in an estimate"
    Exit Function
End If
Set pListsSet = mydb.OpenRecordset("Select key, Productlist from [>Product Lists] where IncludeInEstimate and Job=" & Form_ProductList.JobName & " Order by ProductList", dbOpenSnapshot, dbSeeChanges)
pListsSet.MoveFirst
Do Until pListsSet.EOF
    StatusBarMessage "Checking product cost for " & pListsSet!ProductList
    'Set listSet = mydb.OpenRecordset("Select key, productlistkey, item, totalCost from [>Product List] where IncludeInEstimate and nnez(ProductListKey)=" & Form_ProductList.ProductListName & " Order by Item", dbOpenSnapshot, dbSeeChanges)
    'Set listSet = mydb.OpenRecordset("SELECT [>Product List].key, productlistkey, item, [>Product Lists].ProductList, totalCost FROM [>Product Lists] INNER JOIN [>Product List] ON [>Product Lists].Key = [>Product List].ProductListKey WHERE [>Product Lists].Job=" & [Forms]![ProductListMaster]![ProductListControl]![JobName] & " AND [>Product Lists].IncludeInEstimate=True Order by ProductListKey, Item", dbOpenSnapshot, dbSeeChanges)
    Set listSet = mydb.OpenRecordset("Select key, productlistkey, item, totalCost from [>Product List] where nnez(ProductListKey)=" & pListsSet!Key & " Order by Item", dbOpenSnapshot, dbSeeChanges)
    
    
    'Set partSet = mydb.OpenRecordset("Select materialcost, processcost from [>Part List] where IncludeInEstimate and nnez(ProductList)=" & listSet!ProductListKey, dbOpenSnapshot, dbSeeChanges)
    'Set partSet = mydb.OpenRecordset("SELECT [>Part List].materialcost, [>Part List].processcost, [>Part List].Item , [>Part List].ItemNumber,[>Part List].ProductList FROM [>Product Lists] INNER JOIN [>Part List] ON [>Product Lists].Job = [>Part List].Job WHERE [>Part List].ProductList <> null and [>Product Lists].Job=" & [Forms]![ProductListMaster]![ProductListControl]![JobName] & " AND [>Product Lists].IncludeInEstimate=True Order by nnez([>Part List].ProductList), ItemNumber", dbOpenSnapshot, dbSeeChanges)
    Set partSet = mydb.OpenRecordset("Select materialcost, processcost, item, itemnumber from [>Part List] where nnez(ProductList)=" & pListsSet!Key & " Order by ItemNumber", dbOpenSnapshot, dbSeeChanges)
    
    
    If partSet.RecordCount = 0 Then
    Else
        'partSet.MoveLast
        'MsgBox partSet.RecordCount
        partSet.MoveFirst
        Do Until partSet.EOF
            totalPartCost = totalPartCost + NNEZ(partSet!MaterialCost) + NNEZ(partSet!ProcessCost)
            partSet.MoveNext
        Loop
        partSet.MoveFirst
    End If
    listSet.MoveFirst
    'partSet.MoveFirst
    'Set partSet = mydb.OpenRecordset("Select ProductList, materialcost, processcost, ItemNumber, Item from [>Part List] where nnez(ProductList)=" & listSet!ProductListKey & " Order by ProductList, ItemNumber", dbOpenSnapshot, dbSeeChanges)
    Form_ProductList.StopExecution.Visible = True
    Do Until listSet.EOF
        If g_StopExecution Then
            g_StopExecution = False
            StatusBarMessage "Stopped execution"
            EchoOn
            Exit Function
        End If
        totalListCost = totalListCost + NNEZ(listSet!TotalCost)
        partItemCost = 0
        If partSet.RecordCount = 0 Then
        ElseIf partSet.EOF Then
        Else
            If partSet!ItemNumber = listSet!Item Then ' And Val(NNEZ(partSet!ProductList)) = listSet!ProductListKey Then
                Do Until partSet!ItemNumber <> listSet!Item
                'Do Until partSet!Item <> listSet!Key
                    partItemCost = partItemCost + NNEZ(partSet!MaterialCost) + NNEZ(partSet!ProcessCost)
                    partSet.MoveNext
                    If partSet.EOF Then Exit Do
                Loop
            End If
        End If
        If partItemCost <> NNEZ(listSet!TotalCost) Then
            ErrorLogEntry pListsSet!ProductList & " item " & listSet!Item & " Product cost " & Format(NNEZ(listSet!TotalCost), "$#,#.00") & " <> Parts cost " & Format(partItemCost, "$#,#.00")
            theDiff = theDiff + NNEZ(listSet!TotalCost) - partItemCost
        End If
        'StatusBarMessage "Comparing list item " & listSet!Item & " cost to parts list cost. Total discrepancy: " & Format(theDiff, "$#,0")
        DoEvents
        listSet.MoveNext
    Loop
pListsSet.MoveNext
Loop
StatusBarMessage " "
If LocalVariable("ScratchPad") <> "" Then
    SetLocalVariable "ScratchPad", ""
    If totalPartCost <> totalListCost Then
        MsgBox "Parts List cost and Product List cost discrepancy is " & Format(totalListCost - totalPartCost, "$#,#.00") & vbCrLf & vbCrLf & "See log for details."
    Else
        MsgBox "Parts List cost and Product List cost are equal"
    End If
    Form_ProductList.StopExecution.Visible = False
    EchoOn
    Exit Function
End If

If totalPartCost <> totalListCost Then
    If MessageOKCancel("Parts List cost and Product List cost discrepancy is " & Format(totalListCost - totalPartCost, "$#,#.00") & vbCrLf & vbCrLf & "See log for details." & vbCrLf & vbCrLf & "Continue export without recomputing product costs?") Then
        Form_ProductList.StopExecution.Visible = False
        EchoOn
        Exit Function
    End If
End If
GoTo skipthis
TheCount = 0

Set estimateSet = mydb.OpenRecordset("Select * from Estimates where nnez([50])<>0 or nnez([51])<>0", dbOpenDynaset, dbSeeChanges)
If estimateSet.RecordCount <> 0 Then
    estimateSet.MoveFirst
    Do Until estimateSet.EOF
        estimateSet.Edit
        If NNEZ(estimateSet![50]) <> 0 Then
            estimateSet![52] = estimateSet![50] + NNEZ(estimateSet![52])
            estimateSet![52cost] = estimateSet![50Cost] + NNEZ(estimateSet![52cost])
            estimateSet!Import52 = True
            estimateSet![50] = 0
            estimateSet![50Cost] = 0
            estimateSet![Import50] = False
        End If
        If NNEZ(estimateSet![51]) <> 0 Then
            estimateSet![53] = estimateSet![51] + NNEZ(estimateSet![53])
            estimateSet![53cost] = estimateSet![51Cost] + NNEZ(estimateSet![53cost])
            estimateSet!Import53 = True
            estimateSet![51] = 0
            estimateSet![51Cost] = 0
            estimateSet![Import51] = False
        End If
        estimateSet.Update
        TheCount = TheCount + 1
        StatusBarMessage "Merged " & TheCount & " records"
        estimateSet.MoveNext
    Loop
End If

MsgBox "Merged " & TheCount & " legacy finish estimates"
DoPL:
Set estimateSet = mydb.OpenRecordset("Select * from [>Product List] where nnez([Activity50])<>0 or nnez([Activity51])<>0", dbOpenDynaset, dbSeeChanges)
If estimateSet.RecordCount <> 0 Then
    estimateSet.MoveLast
    estimateSet.MoveFirst
    Do Until estimateSet.EOF
        estimateSet.Edit
        If NNEZ(estimateSet![Activity50]) <> 0 Then
            estimateSet![Activity52] = estimateSet![Activity50] + NNEZ(estimateSet![Activity52])
            estimateSet![Activity50] = 0
        End If
        If NNEZ(estimateSet![Activity51]) <> 0 Then
            estimateSet![Activity53] = estimateSet![Activity51] + NNEZ(estimateSet![Activity53])
            estimateSet![Activity51] = 0
        End If
        estimateSet.Update
        TheCount = TheCount + 1
        StatusBarMessage "Merged " & TheCount & " records"
        estimateSet.MoveNext
    Loop
End If

MsgBox "Merged " & TheCount & " legacy product list estimates"
'Exit Function


skipthis:

Set jobSet = mydb.OpenRecordset("Select * from [>Jobs] where Key=" & Form_ProductList.JobName, dbOpenDynaset, dbSeeChanges)
If jobSet.RecordCount = 0 Then
    MsgBox "Select a job": Exit Function
Else
    g_theOfficeCost = NNEZ(jobSet!DesignEstCost)
    g_theShopCost = NNEZ(jobSet!ShopEstCost)
    g_theInstallCost = NNEZ(jobSet!InstallEstCost)
End If
If g_theShopCost = 0 Then
    jobSet.Edit
    jobSet!DesignOH = NNEZ(Variable("Office OH"))
    jobSet!SIOH = NNEZ(Variable("Shop OH"))
    jobSet!IOH = NNEZ(Variable("Install OH"))
    jobSet!DesignEstCost = NNEZ(Variable("Office hrly cost estimate"))
    jobSet!ShopEstCost = NNEZ(Variable("Shop hrly cost estimate"))
    jobSet!InstallEstCost = NNEZ(Variable("Install hrly cost estimate"))
    jobSet.Update
    g_theOfficeCost = NNEZ(jobSet!DesignEstCost)
    g_theShopCost = NNEZ(jobSet!ShopEstCost)
    g_theInstallCost = NNEZ(jobSet!InstallEstCost)
End If
ErrorLogEntry "Estimate for " & jobSet!ID
ErrorLogEntry Format(g_theOfficeCost, "$#,#.00") & " Additional cost Office Rate (current default " & Format(NNEZ(Variable("Office hrly cost estimate")), "$#,#.00") & ")"
ErrorLogEntry Format(g_theShopCost, "$#,#.00") & " Additional cost Shop Rate (current default " & Format(NNEZ(Variable("Shop hrly cost estimate")), "$#,#.00") & ")"
ErrorLogEntry Format(g_theInstallCost, "$#,#.00") & " Additional cost Install Rate (current default " & Format(NNEZ(Variable("Install hrly cost estimate")), "$#,#.00") & ")"

'Set estimateSet = mydb.OpenRecordset("Select * from [Estimates] where ImportPL=True and Job=" & Form_ProductList.JobName, dbOpenDynaset, dbSeeChanges)
Set estimateSet = mydb.OpenRecordset("Select * from [Estimates] where Job=" & Form_ProductList.JobName & " Order by Sequence", dbOpenDynaset, dbSeeChanges)
If estimateSet.RecordCount <> 0 Then
    With estimateSet
        .MoveFirst
        Do Until .EOF
            If g_StopExecution Then
                g_StopExecution = False
                StatusBarMessage "Stopped execution"
                Form_ProductList.StopExecution.Visible = False
                EchoOn
                Exit Function
            End If
            If NNEZ(!Component) = 0 Then
                .Delete
                StatusBarMessage "Deleted blank component"
            ElseIf !importPL = 0 And !ImportParts = 0 And !ImportMerge = 0 Then
            Else
                StatusBarMessage "Clearing imports from " & SQLResult("Select Component from Components where key =" & !Component)
                DoEvents
                If !ImportMerge Then
                    .Edit
                    !importPL = True: !ImportParts = False: !ImportMerge = False
                    .Update
                End If
                For i = 0 To .Fields.Count - 1
                    If InStr(.Fields(i).Name, "Import") = 0 Then
                    ElseIf InStr(.Fields(i).Name, "PL") = 0 And InStr(.Fields(i).Name, "Parts") = 0 And InStr(.Fields(i).Name, "Merge") = 0 Then
                        If .Fields(i).Name = "Material" Then
                            .Edit
                            .Fields(i).Value = Null
                            .Update
                        End If
                        If .Fields(i).Name = "Inventory" Then
                            .Edit
                            .Fields(i).Value = Null
                            .Update
                        End If
                        If .Fields(i).Value <> 0 Then
                            .Edit
                            .Fields(i).Value = 0
                            .Update
                            sequenceNo = Right(.Fields(i).Name, Len(.Fields(i).Name) - 6)
                            For ii = 0 To .Fields.Count - 1
                                If .Fields(ii).Name = sequenceNo Or .Fields(ii).Name = sequenceNo & "cost" Then
                                    TheCount = TheCount + 1
                                    .Edit
                                    .Fields(ii).Value = Null
                                    .Update
                                End If
                            Next ii
                        End If
                    End If
                Next i
            End If
           .MoveNext
        Loop
    End With
End If
StatusBarMessage "Checking for legacy entries without components"
Dim AdditionalCostComponent As Integer
AdditionalCostComponent = SQLResult("Select Key from Components where instr(Component,'Additional Cost')<>0")
Set componentSet = mydb.OpenRecordset("SELECT Item, Component, ComponentText FROM [>Product List] WHERE nnez(Component)=0 and nnez(specialMaterials) <>0 and ([>Product List].ProductListKey) =" & [Forms]![productlistmaster]![ProductListControl]![ProductListName], dbOpenSnapshot, dbSeeChanges)
If componentSet.RecordCount <> 0 Then
    componentSet.MoveLast
    ErrorLogEntry "Updated " & componentSet.RecordCount & " Special Material components"
    Set componentSet = mydb.OpenRecordset("SELECT Item, Component, ComponentText FROM [>Product List] WHERE nnez(Component)=0 and nnez(specialMaterials) <>0 and ([>Product List].ProductListKey) =" & [Forms]![productlistmaster]![ProductListControl]![ProductListName], dbOpenDynaset, dbSeeChanges)
    Do Until componentSet.EOF
        componentSet.Edit
        componentSet!Component = AdditionalCostComponent
        componentSet.Update
        componentSet.MoveNext
    Loop
End If
Set componentSet = mydb.OpenRecordset("SELECT Item, Component, ComponentText FROM [>Product List] WHERE nnez(Component)=0 and nnez(Inventory) <>0 and ([>Product List].ProductListKey) =" & [Forms]![productlistmaster]![ProductListControl]![ProductListName], dbOpenSnapshot, dbSeeChanges)
If componentSet.RecordCount <> 0 Then
    componentSet.MoveLast
    ErrorLogEntry "Updated " & componentSet.RecordCount & " Inventory components"
    Set componentSet = mydb.OpenRecordset("SELECT Item, Component, ComponentText FROM [>Product List] WHERE nnez(Component)=0 and nnez(Inventory) <>0 and ([>Product List].ProductListKey) =" & [Forms]![productlistmaster]![ProductListControl]![ProductListName], dbOpenDynaset, dbSeeChanges)
    Do Until componentSet.EOF
        componentSet.Edit
        componentSet!Component = AdditionalCostComponent
        componentSet.Update
        componentSet.MoveNext
    Loop
End If
Set componentSet = mydb.OpenRecordset("SELECT Item, Component, ComponentText FROM [>Product List] WHERE nnez(Component)=0 and nnez(OfficeHours) <>0 and ([>Product List].ProductListKey) =" & [Forms]![productlistmaster]![ProductListControl]![ProductListName], dbOpenSnapshot, dbSeeChanges)
If componentSet.RecordCount <> 0 Then
    componentSet.MoveLast
    ErrorLogEntry "Updated " & componentSet.RecordCount & " Office Hour components"
    Set componentSet = mydb.OpenRecordset("SELECT Item, Component, ComponentText FROM [>Product List] WHERE nnez(Component)=0 and nnez(OfficeHours) <>0 and ([>Product List].ProductListKey) =" & [Forms]![productlistmaster]![ProductListControl]![ProductListName], dbOpenDynaset, dbSeeChanges)
    Do Until componentSet.EOF
        componentSet.Edit
        componentSet!Component = AdditionalCostComponent
        componentSet.Update
        componentSet.MoveNext
    Loop
End If
Set componentSet = mydb.OpenRecordset("SELECT Item, Component, ComponentText FROM [>Product List] WHERE nnez(Component)=0 and nnez(ShopHours) <>0 and ([>Product List].ProductListKey) =" & [Forms]![productlistmaster]![ProductListControl]![ProductListName], dbOpenSnapshot, dbSeeChanges)
If componentSet.RecordCount <> 0 Then
    componentSet.MoveLast
    ErrorLogEntry "Updated " & componentSet.RecordCount & " Shop Hour components"
    Set componentSet = mydb.OpenRecordset("SELECT Item, Component, ComponentText FROM [>Product List] WHERE nnez(Component)=0 and nnez(ShopHours) <>0 and ([>Product List].ProductListKey) =" & [Forms]![productlistmaster]![ProductListControl]![ProductListName], dbOpenDynaset, dbSeeChanges)
    Do Until componentSet.EOF
        componentSet.Edit
        componentSet!Component = AdditionalCostComponent
        componentSet.Update
        componentSet.MoveNext
    Loop
End If
Set componentSet = mydb.OpenRecordset("SELECT Item, Component, ComponentText FROM [>Product List] WHERE nnez(Component)=0 and nnez(AssemblyHours) <>0 and ([>Product List].ProductListKey) =" & [Forms]![productlistmaster]![ProductListControl]![ProductListName], dbOpenSnapshot, dbSeeChanges)
If componentSet.RecordCount <> 0 Then
    componentSet.MoveLast
    ErrorLogEntry "Updated " & componentSet.RecordCount & " Assembly Hour components"
    Set componentSet = mydb.OpenRecordset("SELECT Item, Component, ComponentText FROM [>Product List] WHERE nnez(Component)=0 and nnez(AssemblyHours) <>0 and ([>Product List].ProductListKey) =" & [Forms]![productlistmaster]![ProductListControl]![ProductListName], dbOpenDynaset, dbSeeChanges)
    Do Until componentSet.EOF
        componentSet.Edit
        componentSet!Component = AdditionalCostComponent
        componentSet.Update
        componentSet.MoveNext
    Loop
End If
Set componentSet = mydb.OpenRecordset("SELECT Item, Component, ComponentText FROM [>Product List] WHERE nnez(Component)=0 and nnez(FinishHours) <>0 and ([>Product List].ProductListKey) =" & [Forms]![productlistmaster]![ProductListControl]![ProductListName], dbOpenSnapshot, dbSeeChanges)
If componentSet.RecordCount <> 0 Then
    componentSet.MoveLast
    ErrorLogEntry "Updated " & componentSet.RecordCount & " Finish Hour components"
    Set componentSet = mydb.OpenRecordset("SELECT Item, Component, ComponentText FROM [>Product List] WHERE nnez(Component)=0 and nnez(FinishHours) <>0 and ([>Product List].ProductListKey) =" & [Forms]![productlistmaster]![ProductListControl]![ProductListName], dbOpenDynaset, dbSeeChanges)
    Do Until componentSet.EOF
        componentSet.Edit
        componentSet!Component = AdditionalCostComponent
        componentSet.Update
        componentSet.MoveNext
    Loop
End If
Set componentSet = mydb.OpenRecordset("SELECT Item, Component, ComponentText FROM [>Product List] WHERE nnez(Component)=0 and nnez(InstallHours) <>0 and ([>Product List].ProductListKey) =" & [Forms]![productlistmaster]![ProductListControl]![ProductListName], dbOpenSnapshot, dbSeeChanges)
If componentSet.RecordCount <> 0 Then
    componentSet.MoveLast
    ErrorLogEntry "Updated " & componentSet.RecordCount & " Install Hour components"
    Set componentSet = mydb.OpenRecordset("SELECT Item, Component, ComponentText FROM [>Product List] WHERE nnez(Component)=0 and nnez(InstallHours) <>0 and ([>Product List].ProductListKey) =" & [Forms]![productlistmaster]![ProductListControl]![ProductListName], dbOpenDynaset, dbSeeChanges)
    Do Until componentSet.EOF
        componentSet.Edit
        componentSet!Component = AdditionalCostComponent
        componentSet.Update
        componentSet.MoveNext
    Loop
End If
Form_ProductList.StopExecution.Visible = True
'''Set componentSet = mydb.OpenRecordset("SELECT Component, ComponentText FROM [>Product List] WHERE nnez(Component)<>0 and ([>Product List].ProductListKey) =" & [Forms]![ProductListMaster]![ProductListControl]![ProductListName] & " GROUP BY [>Product List].Component, [>Product List].ComponentText ;", dbOpenSnapshot, dbSeeChanges)
Set componentSet = mydb.OpenRecordset("SELECT Component, ComponentText FROM [>Product Lists] LEFT JOIN [>Product List] ON [>Product Lists].Key = [>Product List].ProductListKey WHERE [>Product Lists].Job =" & [Forms]![productlistmaster]![ProductListControl]![JobName] & " And [>Product Lists].IncludeInEstimate = True And NNEZ([Component]) <> 0 GROUP BY Component, ComponentText", dbOpenSnapshot, dbSeeChanges)
If componentSet.RecordCount = 0 Then
    MsgBox "No Product List components found for " & SQLResult("Select ID from [>Jobs] where key=" & [Forms]![productlistmaster]![ProductListControl]![JobName])
Else
    componentSet.MoveLast
    ErrorLogEntry "Exporting " & componentSet.RecordCount & " additional cost components"
    componentSet.MoveFirst
    Do Until componentSet.EOF
StopExecution:
        If g_StopExecution Then
            g_StopExecution = False
            StatusBarMessage "Stopped execution"
            Form_ProductList.StopExecution.Visible = False
            EchoOn
            Exit Function
        End If
        theComponentName = SQLResult("Select Component from Components where key=" & componentSet!Component)
        StatusBarMessage "working on " & theComponentName
        If NNEN(theComponentName) = "" Then ErrorLogEntry "No component"
        'Set addSet = mydb.OpenRecordset("Select * from [>Product List] where [>Product List].Component =" & componentSet!Component & " and ConditionName(nnen(ComponentText)) = '" & ConditionName(NNEN(componentSet!ComponentText)) & "' and Productlistkey=" & Form_ProductList.ProductListKey, dbOpenSnapshot, dbSeeChanges)
        Set addSet = mydb.OpenRecordset("Select * from [>Product Lists] LEFT JOIN [>Product List] ON [>Product Lists].Key = [>Product List].ProductListKey where  [>Product Lists].Job =" & [Forms]![productlistmaster]![ProductListControl]![JobName] & " and [>Product List].Component =" & componentSet!Component & " and [>Product Lists].IncludeInEstimate = True and ConditionName(nnen(ComponentText)) = '" & ConditionName(NNEN(componentSet!ComponentText)) & "'", dbOpenSnapshot, dbSeeChanges)
        If addSet.RecordCount <> 0 Then
            Inventory = 0: SpecialMaterials = 0
            OfficeHours = 0: ShopHours = 0: FinishHours = 0: AssemblyHours = 0: InstallHours = 0
            Activity32Hours = 0: Activity33Hours = 0: Activity34Hours = 0: Activity41Hours = 0: Activity42Hours = 0: Activity43Hours = 0: Activity44Hours = 0: Activity45Hours = 0: Activity46Hours = 0: Activity50Hours = 0
            Activity51Hours = 0: Activity52Hours = 0: Activity53Hours = 0: Activity54Hours = 0: Activity55Hours = 0: Activity61Hours = 0: Activity62Hours = 0: Activity63Hours = 0: Activity71Hours = 0: Activity72Hours = 0
            addSet.MoveFirst
            Do Until addSet.EOF
        'MsgBox addSet!Item & " " & componentSet!Component & " " & NNEZ(addSet!EstimateOfficeRate)
                If addSet!PremiumCost <> 0 Then
                    If NNEZ(addSet!EstimateOfficeRate) <> 0 Then
                        If addSet!EstimateOfficeRate <> g_theOfficeCost Then
                            MsgBox SQLResult("Select ProductList from [>Product Lists] where key=" & addSet!ProductListKey) & ": The job office rate of " & Format(g_theOfficeCost, "$#.00") & " is not equal to the computed additional cost office rate of " & Format(addSet!EstimateOfficeRate, "$#.00") & " for item " & addSet!Item & CRLF & CRLF & "Recompute cost for this job to correct labor rates"
                            g_StopExecution = True
                            GoTo StopExecution
                        End If
                    End If
                    If NNEZ(addSet!EstimateShopRate) <> 0 Then
                        If addSet!EstimateShopRate <> g_theShopCost Then
                            MsgBox SQLResult("Select ProductList from [>Product Lists] where key=" & addSet!ProductListKey) & ": The job shop rate of " & Format(g_theShopCost, "$#.00") & " is not equal to the computed additional cost shop rate of " & Format(addSet!EstimateShopRate, "$#.00") & " for item " & addSet!Item & CRLF & CRLF & "Recompute cost for this job to correct labor rates"
                            g_StopExecution = True
                            GoTo StopExecution
                        End If
                    End If
                    If NNEZ(addSet!EstimateInstallRate) <> 0 Then
                        If addSet!EstimateInstallRate <> g_theInstallCost Then
                            MsgBox SQLResult("Select ProductList from [>Product Lists] where key=" & addSet!ProductListKey) & ": The job install rate of " & Format(g_theInstallCost, "$#.00") & " is not equal to the computed additional cost install rate of " & Format(addSet!EstimateInstallRate, "$#.00") & " for item " & addSet!Item & CRLF & CRLF & "Recompute cost for this job to correct labor rates"
                            g_StopExecution = True
                            GoTo StopExecution
                        End If
                    End If
                End If
                Activity32Hours = Activity32Hours + NNEZ(addSet!Activity32) * NNE1(addSet!Pieces)
                Activity33Hours = Activity33Hours + NNEZ(addSet!Activity33) * NNE1(addSet!Pieces)
                Activity34Hours = Activity34Hours + NNEZ(addSet!Activity34) * NNE1(addSet!Pieces)
                Activity41Hours = Activity41Hours + NNEZ(addSet!Activity41) * NNE1(addSet!Pieces)
                Activity42Hours = Activity42Hours + NNEZ(addSet!Activity42) * NNE1(addSet!Pieces)
                Activity43Hours = Activity43Hours + NNEZ(addSet!Activity43) * NNE1(addSet!Pieces)
                Activity44Hours = Activity44Hours + NNEZ(addSet!Activity44) * NNE1(addSet!Pieces)
                Activity45Hours = Activity45Hours + NNEZ(addSet!Activity45) * NNE1(addSet!Pieces)
                Activity46Hours = Activity46Hours + NNEZ(addSet!Activity46) * NNE1(addSet!Pieces)
                Activity50Hours = Activity50Hours + NNEZ(addSet!Activity50) * NNE1(addSet!Pieces)
                Activity51Hours = Activity51Hours + NNEZ(addSet!Activity51) * NNE1(addSet!Pieces)
                Activity52Hours = Activity52Hours + NNEZ(addSet!Activity52) * NNE1(addSet!Pieces)
                Activity53Hours = Activity53Hours + NNEZ(addSet!Activity53) * NNE1(addSet!Pieces)
                Activity54Hours = Activity54Hours + NNEZ(addSet!Activity54) * NNE1(addSet!Pieces)
                Activity55Hours = Activity55Hours + NNEZ(addSet!Activity55) * NNE1(addSet!Pieces)
                Activity61Hours = Activity61Hours + NNEZ(addSet!Activity61) * NNE1(addSet!Pieces)
                Activity62Hours = Activity62Hours + NNEZ(addSet!Activity62) * NNE1(addSet!Pieces)
                Activity63Hours = Activity63Hours + NNEZ(addSet!Activity63) * NNE1(addSet!Pieces)
                Activity71Hours = Activity71Hours + NNEZ(addSet!Activity71) * NNE1(addSet!Pieces)
                Activity72Hours = Activity72Hours + NNEZ(addSet!Activity72) * NNE1(addSet!Pieces)
                OfficeHours = OfficeHours + NNEZ(addSet!OfficeHours) * NNE1(addSet!Pieces)
                ShopHours = ShopHours + NNEZ(addSet!ShopHours) * NNE1(addSet!Pieces)
                FinishHours = FinishHours + NNEZ(addSet!FinishHours) * NNE1(addSet!Pieces)
                AssemblyHours = AssemblyHours + NNEZ(addSet!AssemblyHours) * NNE1(addSet!Pieces)
                InstallHours = InstallHours + NNEZ(addSet!InstallHours) * NNE1(addSet!Pieces)
                Inventory = Inventory + NNEZ(addSet!Inventory) * NNE1(addSet!Pieces)
                SpecialMaterials = SpecialMaterials + NNEZ(addSet!SpecialMaterials) * NNE1(addSet!Pieces)
                OS = OS + NNEZ(addSet!OS) * NNE1(addSet!Pieces)
                addSet.MoveNext
            Loop
            Set estimateSet = mydb.OpenRecordset("Select * from [Estimates] where ConditionName(nnen(Description)) = '" & ConditionName(NNEN(componentSet!ComponentText)) & "' and Component=" & componentSet!Component & " and Job=" & Form_ProductList.JobName, dbOpenDynaset, dbSeeChanges)
            If estimateSet.RecordCount = 0 Then
                estimateSet.AddNew
                estimateSet!Job = Form_ProductList.JobName
                estimateSet!Component = componentSet!Component
                estimateSet!Sequence = SQLResult("Select Sequence from Components where key=" & componentSet!Component)
            ElseIf estimateSet.RecordCount <> 1 Then 'check for duplicates
                estimateSet.MoveFirst
                Do Until estimateSet.EOF
                    Set descriptionSet = mydb.OpenRecordset("Select * from [Estimates] where ImportParts=True and Component=" & componentSet!Key & " and Description='" & estimateSet!Description & "' and Job=" & Form_ProductList.JobName, dbOpenSnapshot, dbSeeChanges)
                    If descriptionSet.RecordCount <> 1 Then
                        MsgBox "Export was canceled because there are more than one " & componentSet!Component & " " & estimateSet!Description & " Part List Import components in the estimate.": Exit Function
                    End If
                    estimateSet.MoveNext
                Loop
            End If
            If estimateSet.RecordCount <> 0 Then estimateSet.Edit
            'Activity32Hours = OfficeHours - Activity33Hours - Activity34Hours 'in case of legacy
            If Activity32Hours <> 0 Then
                For i = 0 To estimateSet.Fields.Count - 1
                    If estimateSet.Fields(i).Name = "32" Then estimateSet.Fields(i) = Activity32Hours
                    If estimateSet.Fields(i).Name = "32Cost" Then estimateSet.Fields(i) = Round(Activity32Hours * g_theOfficeCost, 2) '(activitySet!LaborRate + activitySet!Overhead), 2)
                    If estimateSet.Fields(i).Name = "Import32" Then estimateSet.Fields(i) = True
                Next i
            End If
            If Activity33Hours <> 0 Then
                For i = 0 To estimateSet.Fields.Count - 1
                    If estimateSet.Fields(i).Name = "33" Then estimateSet.Fields(i) = Activity33Hours
                    If estimateSet.Fields(i).Name = "33Cost" Then estimateSet.Fields(i) = Round(Activity33Hours * g_theOfficeCost, 2) '(activitySet!LaborRate + activitySet!Overhead), 2)
                    If estimateSet.Fields(i).Name = "Import33" Then estimateSet.Fields(i) = True
                Next i
            End If
            If Activity34Hours <> 0 Then
                For i = 0 To estimateSet.Fields.Count - 1
                    If estimateSet.Fields(i).Name = "34" Then estimateSet.Fields(i) = Activity34Hours
                    If estimateSet.Fields(i).Name = "34Cost" Then estimateSet.Fields(i) = Round(Activity34Hours * g_theOfficeCost, 2) '(activitySet!LaborRate + activitySet!Overhead), 2)
                    If estimateSet.Fields(i).Name = "Import34" Then estimateSet.Fields(i) = True
                Next i
            End If
            'Activity41Hours = ShopHours - Activity42Hours - Activity43Hours - Activity44Hours - Activity45Hours - Activity46Hours 'in case of legacy
            If Activity41Hours <> 0 Then
                For i = 0 To estimateSet.Fields.Count - 1
                    If estimateSet.Fields(i).Name = "41" Then estimateSet.Fields(i) = Activity41Hours
                    If estimateSet.Fields(i).Name = "41Cost" Then estimateSet.Fields(i) = Round(Activity41Hours * g_theShopCost, 2) '(activitySet!LaborRate + activitySet!Overhead), 2)
                    If estimateSet.Fields(i).Name = "Import41" Then estimateSet.Fields(i) = True
                Next i
            End If
            If Activity42Hours <> 0 Then
                For i = 0 To estimateSet.Fields.Count - 1
                    If estimateSet.Fields(i).Name = "42" Then estimateSet.Fields(i) = Activity42Hours
                    If estimateSet.Fields(i).Name = "42Cost" Then estimateSet.Fields(i) = Round(Activity42Hours * g_theShopCost, 2) '(activitySet!LaborRate + activitySet!Overhead), 2)
                    If estimateSet.Fields(i).Name = "Import42" Then estimateSet.Fields(i) = True
                Next i
            End If
            If Activity43Hours <> 0 Then
                For i = 0 To estimateSet.Fields.Count - 1
                    If estimateSet.Fields(i).Name = "43" Then estimateSet.Fields(i) = Activity43Hours
                    If estimateSet.Fields(i).Name = "43Cost" Then estimateSet.Fields(i) = Round(Activity43Hours * g_theShopCost, 2) '(activitySet!LaborRate + activitySet!Overhead), 2)
                    If estimateSet.Fields(i).Name = "Import43" Then estimateSet.Fields(i) = True
                Next i
            End If
            If Activity44Hours <> 0 Then
                For i = 0 To estimateSet.Fields.Count - 1
                    If estimateSet.Fields(i).Name = "44" Then estimateSet.Fields(i) = Activity44Hours
                    If estimateSet.Fields(i).Name = "44Cost" Then
                        estimateSet.Fields(i) = Round(Activity44Hours * g_theShopCost, 2) '(activitySet!LaborRate + activitySet!Overhead), 2)
                    End If
                    If estimateSet.Fields(i).Name = "Import44" Then estimateSet.Fields(i) = True
                Next i
            End If
            If Activity45Hours <> 0 Then
                For i = 0 To estimateSet.Fields.Count - 1
                    If estimateSet.Fields(i).Name = "45" Then estimateSet.Fields(i) = Activity45Hours
                    If estimateSet.Fields(i).Name = "45Cost" Then estimateSet.Fields(i) = Round(Activity45Hours * g_theShopCost, 2) '(activitySet!LaborRate + activitySet!Overhead), 2)
                    If estimateSet.Fields(i).Name = "Import45" Then estimateSet.Fields(i) = True
                Next i
            End If
            If Activity46Hours <> 0 Then
                For i = 0 To estimateSet.Fields.Count - 1
                    If estimateSet.Fields(i).Name = "46" Then estimateSet.Fields(i) = Activity46Hours
                    If estimateSet.Fields(i).Name = "46Cost" Then estimateSet.Fields(i) = Round(Activity46Hours * g_theShopCost, 2) '(activitySet!LaborRate + activitySet!Overhead), 2)
                    If estimateSet.Fields(i).Name = "Import46" Then estimateSet.Fields(i) = True
                Next i
            End If
            'Activity50Hours = FinishHours - Activity51Hours - Activity52Hours - Activity53Hours - Activity54Hours - Activity55Hours 'in case of legacy
            If Activity50Hours <> 0 Then
                For i = 0 To estimateSet.Fields.Count - 1
                    If estimateSet.Fields(i).Name = "50" Then estimateSet.Fields(i) = Activity50Hours
                    If estimateSet.Fields(i).Name = "50Cost" Then estimateSet.Fields(i) = Round(Activity50Hours * g_theShopCost, 2) '(activitySet!LaborRate + activitySet!Overhead), 2)
                    If estimateSet.Fields(i).Name = "Import50" Then estimateSet.Fields(i) = True
                Next i
            End If
            If Activity51Hours <> 0 Then
                For i = 0 To estimateSet.Fields.Count - 1
                    If estimateSet.Fields(i).Name = "51" Then estimateSet.Fields(i) = Activity51Hours
                    If estimateSet.Fields(i).Name = "51Cost" Then estimateSet.Fields(i) = Round(Activity51Hours * g_theShopCost, 2) '(activitySet!LaborRate + activitySet!Overhead), 2)
                    If estimateSet.Fields(i).Name = "Import51" Then estimateSet.Fields(i) = True
                Next i
            End If
            If Activity52Hours <> 0 Then
                For i = 0 To estimateSet.Fields.Count - 1
                    If estimateSet.Fields(i).Name = "52" Then estimateSet.Fields(i) = Activity52Hours
                    If estimateSet.Fields(i).Name = "52Cost" Then estimateSet.Fields(i) = Round(Activity52Hours * g_theShopCost, 2) '(activitySet!LaborRate + activitySet!Overhead), 2)
                    If estimateSet.Fields(i).Name = "Import52" Then estimateSet.Fields(i) = True
                Next i
            End If
            If Activity53Hours <> 0 Then
                For i = 0 To estimateSet.Fields.Count - 1
                    If estimateSet.Fields(i).Name = "53" Then estimateSet.Fields(i) = Activity53Hours
                    If estimateSet.Fields(i).Name = "53Cost" Then estimateSet.Fields(i) = Round(Activity53Hours * g_theShopCost, 2) '(activitySet!LaborRate + activitySet!Overhead), 2)
                    If estimateSet.Fields(i).Name = "Import53" Then estimateSet.Fields(i) = True
                Next i
            End If
            If Activity54Hours <> 0 Then
                For i = 0 To estimateSet.Fields.Count - 1
                    If estimateSet.Fields(i).Name = "54" Then estimateSet.Fields(i) = Activity54Hours
                    If estimateSet.Fields(i).Name = "54Cost" Then estimateSet.Fields(i) = Round(Activity54Hours * g_theShopCost, 2) '(activitySet!LaborRate + activitySet!Overhead), 2)
                    If estimateSet.Fields(i).Name = "Import54" Then estimateSet.Fields(i) = True
                Next i
            End If
            If Activity55Hours <> 0 Then
                For i = 0 To estimateSet.Fields.Count - 1
                    If estimateSet.Fields(i).Name = "55" Then estimateSet.Fields(i) = Activity55Hours
                    If estimateSet.Fields(i).Name = "55Cost" Then estimateSet.Fields(i) = Round(Activity55Hours * g_theShopCost, 2) '(activitySet!LaborRate + activitySet!Overhead), 2)
                    If estimateSet.Fields(i).Name = "Import55" Then estimateSet.Fields(i) = True
                Next i
            End If
            'Activity61Hours = AssemblyHours - Activity62Hours - Activity63Hours 'in case of legacy
            If Activity61Hours <> 0 Then
                For i = 0 To estimateSet.Fields.Count - 1
                    If estimateSet.Fields(i).Name = "61" Then estimateSet.Fields(i) = Activity61Hours
                    If estimateSet.Fields(i).Name = "61Cost" Then estimateSet.Fields(i) = Round(Activity61Hours * g_theShopCost, 2) '(activitySet!LaborRate + activitySet!Overhead), 2)
                    If estimateSet.Fields(i).Name = "Import61" Then estimateSet.Fields(i) = True
                Next i
            End If
            If Activity62Hours <> 0 Then
                For i = 0 To estimateSet.Fields.Count - 1
                    If estimateSet.Fields(i).Name = "62" Then estimateSet.Fields(i) = Activity62Hours
                    If estimateSet.Fields(i).Name = "62Cost" Then estimateSet.Fields(i) = Round(Activity62Hours * g_theShopCost, 2) '(activitySet!LaborRate + activitySet!Overhead), 2)
                    If estimateSet.Fields(i).Name = "Import62" Then estimateSet.Fields(i) = True
                Next i
            End If
            If Activity63Hours <> 0 Then
                For i = 0 To estimateSet.Fields.Count - 1
                    If estimateSet.Fields(i).Name = "63" Then estimateSet.Fields(i) = Activity63Hours
                    If estimateSet.Fields(i).Name = "63Cost" Then estimateSet.Fields(i) = Round(Activity63Hours * g_theShopCost, 2) '(activitySet!LaborRate + activitySet!Overhead), 2)
                    If estimateSet.Fields(i).Name = "Import63" Then estimateSet.Fields(i) = True
                Next i
            End If
            'Activity71Hours = InstallHours - Activity72Hours  'in case of legacy
            If Activity71Hours <> 0 Then
                For i = 0 To estimateSet.Fields.Count - 1
                    If estimateSet.Fields(i).Name = "71" Then estimateSet.Fields(i) = Activity71Hours
                    If estimateSet.Fields(i).Name = "71Cost" Then estimateSet.Fields(i) = Round(Activity71Hours * g_theInstallCost, 2) '(activitySet!LaborRate + activitySet!Overhead), 2)
                    If estimateSet.Fields(i).Name = "Import71" Then estimateSet.Fields(i) = True
                Next i
            End If
            If Activity72Hours <> 0 Then
                For i = 0 To estimateSet.Fields.Count - 1
                    If estimateSet.Fields(i).Name = "72" Then estimateSet.Fields(i) = Activity72Hours
                    If estimateSet.Fields(i).Name = "72Cost" Then estimateSet.Fields(i) = Round(Activity72Hours * g_theInstallCost, 2) '(activitySet!LaborRate + activitySet!Overhead), 2)
                    If estimateSet.Fields(i).Name = "Import72" Then estimateSet.Fields(i) = True
                Next i
            End If
            
            
            estimateSet!Material = Round(SpecialMaterials, 2)
            estimateSet!Inventory = Round(Inventory, 2)
            If NNEZ(estimateSet!Material) <> 0 Then estimateSet!ImportMaterial = True
            If NNEZ(estimateSet!Inventory) <> 0 Then estimateSet!ImportInventory = True
            estimateSet!extracostos = Round(OS, 2)
            estimateSet!Description = componentSet!ComponentText
            estimateSet!importPL = True
            estimateSet!ImportParts = False
            estimateSet!ImportMerge = False
            estimateSet!Updated = Now
            estimateSet!OfficeRate = g_theOfficeCost
            estimateSet!ShopRate = g_theShopCost
            estimateSet!InstallRate = g_theInstallCost
            estimateSet.Update
        End If
        componentSet.MoveNext
    Loop
End If
'Set JobSet = mydb.OpenRecordset("Select LastEstimateExport from [>Jobs] where Key=" & Form_ProductList.JobName, dbOpenDynaset, dbSeeChanges)
'JobSet.Edit
'JobSet!LastEstimateExport = Now
'JobSet.Update
'EchoOn
StatusBarMessage "Exporting components"
'DoEvents
'Pause 1
'StatusBarMessage " "
ExportComponentCosts

Exit Function

ExportError:
    MsgBox Err.Description
    g_StopExecution = False
    If InStr(Screen.ActiveForm.Name, "Master") <> 0 Then
        Form_ProductList.StopExecution.Visible = False
    Else
        Forms!PartsList!StopExecution.Visible = False
    End If

    Resume ResumeExportError
ResumeExportError:

End Function
   
   

'Private Sub Form_Load()

   'Command1.Caption = "Get Domain Name"
   'Label1.Caption = "Network domain is:"
   
'End Sub
   

'Private Sub Command1_Click()

   'Text1.Text = GetDomainName()

'End Sub


Public Function GetDomainName() As String

   Dim buff()        As Byte
   Dim cbRequired    As Long
   Dim nStructSize   As Long
   Dim Info          As FIXED_INFO

  'Call the api passing null as pFixedInfo.
  'The required size of the buffer for the
  'data is returned in cbRequired
   Call GetNetworkParams(ByVal 0&, cbRequired)

   If cbRequired > 0 Then
    
     'create a buffer of the needed size
      ReDim buff(0 To cbRequired - 1) As Byte
      
     'and call again
      If GetNetworkParams(buff(0), cbRequired) = ERROR_SUCCESS Then
              
        'copy the buffer into a FIXED_INFO type
         ''''CopyMemory Info, ByVal VarPtr(buff(0)), LenB(Info)
            
        'and retrieve the domain name
         GetDomainName = TrimNull(StrConv(Info.DomainName, vbUnicode))
      
      End If  'If GetNetworkParams
   End If  'If cbRequired > 0

End Function
   
Private Sub testing()

XValue = GetPublicIP 'GetIPAddress 'DhcpServerAddress
MsgBox GetHostNameFromIP(XValue)

'Xname = GetDomainName
'MsgBox Xname

End Sub


Public Function GetIPAddress() As String

Dim TheServerPath As String
Close #2
Open "C:\ACCESS\ServerPath.TXT" For Input As #2
Input #2, ServerPath
Close #2

GetIPAddress = ServerPath
Exit Function
   Dim sHostName    As String * 256
   Dim lpHost    As Long
   Dim HOST      As HOSTENT
   Dim dwIPAddr  As Long
   Dim tmpIPAddr() As Byte
   Dim i         As Integer
   Dim sIPAddr  As String
   
   If Not SocketsInitialize() Then
      GetIPAddress = ""
      Exit Function
   End If
    
  'gethostname returns the name of the local host into
  'the buffer specified by the name parameter. The host
  'name is returned as a null-terminated string. The
  'form of the host name is dependent on the Windows
  'Sockets provider - it can be a simple host name, or
  'it can be a fully qualified domain name. However, it
  'is guaranteed that the name returned will be successfully
  'parsed by gethostbyname and WSAAsyncGetHostByName.

  'In actual application, if no local host name has been
  'configured, gethostname must succeed and return a token
  'host name that gethostbyname or WSAAsyncGetHostByName
  'can resolve.
   If gethostname(sHostName, 256) = SOCKET_ERROR Then
      GetIPAddress = ""
      MsgBox "Windows Sockets error " & Str$(WSAGetLastError()) & _
              " has occurred. Unable to successfully get Host Name."
      SocketsCleanup
      Exit Function
   End If
   
  'gethostbyname returns a pointer to a HOSTENT structure
  '- a structure allocated by Windows Sockets. The HOSTENT
  'structure contains the results of a successful search
  'for the host specified in the name parameter.

  'The application must never attempt to modify this
  'structure or to free any of its components. Furthermore,
  'only one copy of this structure is allocated per thread,
  'so the application should copy any information it needs
  'before issuing any other Windows Sockets function calls.

  'gethostbyname function cannot resolve IP address strings
  'passed to it. Such a request is treated exactly as if an
  'unknown host name were passed. Use inet_addr to convert
  'an IP address string the string to an actual IP address,
  'then use another function, gethostbyaddr, to obtain the
  'contents of the HOSTENT structure.
   sHostName = Trim$(sHostName)
   lpHost = gethostbyname(sHostName)
    
   If lpHost = 0 Then
      GetIPAddress = ""
      MsgBox "Windows Sockets are not responding. " & _
              "Unable to successfully get Host Name."
      SocketsCleanup
      Exit Function
   End If
    
  'to extract the returned IP address, we have to copy
  'the HOST structure and its members
   CopyMemory HOST, lpHost, Len(HOST)
   CopyMemory dwIPAddr, HOST.hAddrList, 4
   
  'create an array to hold the result
   ReDim tmpIPAddr(1 To HOST.hLen)
   CopyMemory tmpIPAddr(1), dwIPAddr, HOST.hLen
   
  'and with the array, build the actual address,
  'appending a period between members
   For i = 1 To HOST.hLen
      sIPAddr = sIPAddr & tmpIPAddr(i) & "."
   Next
  
  'the routine adds a period to the end of the
  'string, so remove it here
   GetIPAddress = Mid$(sIPAddr, 1, Len(sIPAddr) - 1)
   
   SocketsCleanup
    
End Function


Public Function GetIPHostName() As String

    Dim sHostName As String * 256
    
    If Not SocketsInitialize() Then
        GetIPHostName = ""
        Exit Function
    End If
    
    If gethostname(sHostName, 256) = SOCKET_ERROR Then
        GetIPHostName = ""
        MsgBox "Windows Sockets error " & Str$(WSAGetLastError()) & _
                " has occurred.  Unable to successfully get Host Name."
        SocketsCleanup
        Exit Function
    End If
    
    GetIPHostName = Left$(sHostName, InStr(sHostName, Chr(0)) - 1)
    SocketsCleanup

End Function


Public Function HiByte(ByVal wParam As Integer) As Byte
  
  'note: VB4-32 users should declare ptrsafe this function As Integer
   HiByte = (wParam And &HFF00&) \ (&H100)
 
End Function


Public Function LoByte(ByVal wParam As Integer) As Byte

  'note: VB4-32 users should declare ptrsafe this function As Integer
   LoByte = wParam And &HFF&

End Function





Public Function TheUsername()

Dim s$, cnt&, dl&
cnt& = 199
s$ = String$(200, 0)
dl& = GetUserName(s$, cnt)
TheUsername = Left(s$, cnt - 1)

End Function


Public Function ListMonthBegin(fld As Control, ID As Variant, row As Variant, col As Variant, code As Variant) As Variant
    Dim intOffset As Integer
    Select Case code
        Case acLBInitialize            ' Initialize.
            ListMonthBegin = True
        Case acLBOpen                    ' Open.
            ListMonthBegin = Timer        ' Unique ID.
        Case acLBGetRowCount            ' Get rows.
            ListMonthBegin = 121
        Case acLBGetColumnCount    ' Get columns.
            ListMonthBegin = 1
        Case acLBGetColumnWidth    ' Get column width.
            ListMonthBegin = -1            ' Use default width.
        Case acLBGetValue                ' Get the data.
            g_TheDate = Date - Day(Date) + 1
            For i = 1 To row
                g_TheDate = g_TheDate - Day(g_TheDate - 1)
            Next i
            ListMonthBegin = g_TheDate
    End Select
End Function

Public Function ListMonthEnd(fld As Control, ID As Variant, row As Variant, col As Variant, code As Variant) As Variant
    Dim intOffset As Integer
    Select Case code
        Case acLBInitialize            ' Initialize.
            ListMonthEnd = True
        Case acLBOpen                    ' Open.
            ListMonthEnd = Timer        ' Unique ID.
        Case acLBGetRowCount            ' Get rows.
            ListMonthEnd = 121
        Case acLBGetColumnCount    ' Get columns.
            ListMonthEnd = 1
        Case acLBGetColumnWidth    ' Get column width.
            ListMonthEnd = -1            ' Use default width.
        Case acLBGetValue                ' Get the data.
            g_TheDate = Date + 40 - Day(Date + 40) + 1
            For i = 1 To row
                g_TheDate = g_TheDate - Day(g_TheDate - 1)
            Next i
            ListMonthEnd = g_TheDate - 1
    End Select
End Function

Public Function ListWeekBegin(fld As Control, ID As Variant, row As Variant, col As Variant, code As Variant) As Variant
    Dim intOffset As Integer
    Select Case code
        Case acLBInitialize            ' Initialize.
            ListWeekBegin = True
        Case acLBOpen                    ' Open.
            ListWeekBegin = Timer        ' Unique ID.
        Case acLBGetRowCount            ' Get rows.
            ListWeekBegin = 121 * 4
        Case acLBGetColumnCount    ' Get columns.
            ListWeekBegin = 1
        Case acLBGetColumnWidth    ' Get column width.
            ListWeekBegin = -1            ' Use default width.
        Case acLBGetValue                ' Get the data.
            g_TheDate = Date + 10 - Weekday(Date + 10) + 1
            Do Until Weekday(g_TheDate) = vbMonday
                g_TheDate = g_TheDate - 1
            Loop
            For i = 1 To row
                g_TheDate = g_TheDate - 7
            Next i
            ListWeekBegin = g_TheDate
    End Select
End Function

Public Function ListFutureWeekBegin(fld As Control, ID As Variant, row As Variant, col As Variant, code As Variant) As Variant
    Dim intOffset As Integer
    Select Case code
        Case acLBInitialize            ' Initialize.
            ListFutureWeekBegin = True
        Case acLBOpen                    ' Open.
            ListFutureWeekBegin = Timer        ' Unique ID.
        Case acLBGetRowCount            ' Get rows.
            ListFutureWeekBegin = 121 * 4
        Case acLBGetColumnCount    ' Get columns.
            ListFutureWeekBegin = 1
        Case acLBGetColumnWidth    ' Get column width.
            ListFutureWeekBegin = -1            ' Use default width.
        Case acLBGetValue                ' Get the data.
            g_TheDate = Date - 10 - Weekday(Date - 10) + 1
            Do Until Weekday(g_TheDate) = vbMonday
                g_TheDate = g_TheDate + 1
            Loop
            For i = 1 To row
                g_TheDate = g_TheDate + 7
            Next i
            ListFutureWeekBegin = g_TheDate
    End Select
End Function

Public Function ListWeekEnd(fld As Control, ID As Variant, row As Variant, col As Variant, code As Variant) As Variant
    Dim intOffset As Integer
    Select Case code
        Case acLBInitialize            ' Initialize.
            ListWeekEnd = True
        Case acLBOpen                    ' Open.
            ListWeekEnd = Timer        ' Unique ID.
        Case acLBGetRowCount            ' Get rows.
            ListWeekEnd = 121 * 4
        Case acLBGetColumnCount    ' Get columns.
            ListWeekEnd = 1
        Case acLBGetColumnWidth    ' Get column width.
            ListWeekEnd = -1            ' Use default width.
        Case acLBGetValue                ' Get the data.
            g_TheDate = Date + 10 - Weekday(Date + 10) + 1
            Do Until Weekday(g_TheDate) = vbSunday
                g_TheDate = g_TheDate - 1
            Loop
            For i = 1 To row
                g_TheDate = g_TheDate - 7
            Next i
            ListWeekEnd = g_TheDate
    End Select
End Function

Public Function DateToday()

DateToday = Date

End Function

Public Function ConvertedNumber(TheNumber As Double, NumberSystem As String, DecimalPlaces As Integer, Fraction As Integer) As String

EchoOn
If InStr(NumberSystem, "millimeter") <> 0 Then
ElseIf InStr(NumberSystem, "mm") <> 0 Then
Else
    TheNumber = TenThousandths(TheNumber / 25.4)
    If InStr(NumberSystem, "decimal inch") <> 0 Then
    ElseIf InStr(NumberSystem, "/") = 0 Then
    Else
        Dim TheWhole As Double
        Dim ThisNumber As String, TheNumerator As String
        Dim Numerator As Double, Denominator As Long
        If TheNumber \ 1 <> TheNumber Then
            ThisNumber = Str(TheNumber)
            M = InStr(ThisNumber, ".")
            If TheNumber >= 1 Then
                TheWhole = Left(ThisNumber, M - 1)
            Else
                TheWhole = 0
            End If
            TheNumerator = Val(Right(ThisNumber, Len(ThisNumber) - M + 1))
            Numerator = Val(TheNumerator)
            Denominator = Fraction
            Numerator = (Fraction * Numerator) \ 1
            LCD = LowestCommonDenominator(Numerator, Denominator)
            Numerator = ConditionNumber(Numerator / LCD)
            Denominator = Denominator / LCD
            If Numerator = 0 Then
                ConvertedNumber = TheWhole
            ElseIf Numerator = Denominator Then
                ConvertedNumber = TheWhole + (Numerator / Denominator)
            ElseIf Val(TheWhole) <> 0 Then
                ConvertedNumber = TheWhole & " " & Numerator & "/" & Denominator
            Else
                ConvertedNumber = Numerator & "/" & Denominator
            End If
        Else
            ConvertedNumber = TheNumber
        End If
        Exit Function
    End If
End If
If DecimalPlaces = 4 Then
    ConvertedNumber = Format(Round(TheNumber, 4), "#,###.####;(0); ;""") 'TenThousandths(TheNumber)
ElseIf DecimalPlaces = 3 Then
    ConvertedNumber = Format(Round(TheNumber, 3), "#,###.###;(0); ;""") 'Thousandths(TheNumber)
ElseIf DecimalPlaces = 2 Then
    ConvertedNumber = Format(Round(TheNumber, 2), "#,###.##;(0); ;""") 'Hundredths(TheNumber)
ElseIf DecimalPlaces = 1 Then
    ConvertedNumber = Format(Round(TheNumber, 1), "#,###.#;(0); ;""") 'Tenths(TheNumber)
Else
    ConvertedNumber = Format(Round(TheNumber, 0), "#,###.#;(0); ;""") 'TheNumber \ 1
End If

End Function

Private Function LowestCommonDenominator(Numerator As Double, Denominator As Long)

For i = Numerator To 1 Step -1
    M = Denominator / i
    If M \ 1 = M Then
        M = Numerator / i
        If M \ 1 = M Then
            LowestCommonDenominator = i
            Exit Function
        End If
    End If
Next i
LowestCommonDenominator = 1

End Function

Sub CircumCenter(k_px, k_py, cX, cY, Cr)

variant1 = px(1) - px(3)
Variant2 = py(1) - py(3)
Variant3 = variant1 * (px(1) + px(3)) / 2 + Variant2 * (py(1) + py(3)) / 2
variant4 = px(2) - px(3)
variant5 = py(2) - py(3)
variant6 = variant4 * (px(2) + px(3)) / 2 + variant5 * (py(2) + py(3)) / 2
variant7 = variant1 * variant5 - Variant2 * variant4

cX = 0#
cY = 0#
Cr = 0#

If (variant7 <> 0#) Then
    cX = (Variant3 * variant5 - variant6 * Variant2) / variant7
    cY = (variant1 * variant6 - variant4 * Variant3) / variant7
    Cr = Sqr((px(3) - cX) ^ 2 + (py(3) - cY) ^ 2)
End If

End Sub

Function CalcString(ThePlaces, TheLine)

If NNEN(TheLine) = "" Then Exit Function
M = 1
Do Until M = 0
    M = InStr(1, TheLine, "=+")
    If M <> 0 Then TheLine = Left(TheLine, M - 1) & "= +" & Right(TheLine, Len(TheLine) - M - 1)
  Loop
M = 1
Do Until M = 0
    M = InStr(1, TheLine, "=-")
    If M <> 0 Then TheLine = Left(TheLine, M - 1) & "= -" & Right(TheLine, Len(TheLine) - M - 1)
  Loop
M = 1
Do Until M = 0
    M = InStr(1, TheLine, "=>")
    If M <> 0 Then TheLine = Left(TheLine, M - 1) & ">= " & Right(TheLine, Len(TheLine) - M - 1)
  Loop
M = 1
Do Until M = 0
    M = InStr(1, TheLine, "=<")
    If M <> 0 Then TheLine = Left(TheLine, M - 1) & "<= " & Right(TheLine, Len(TheLine) - M - 1)
  Loop
M = 1
Do Until M = 0
    M = InStr(1, TheLine, "--")
    If M <> 0 Then TheLine = Left(TheLine, M - 1) & "+" & Right(TheLine, Len(TheLine) - M - 1)
  Loop
M = 1
Do Until M = 0
    M = InStr(1, TheLine, "+-")
    If M <> 0 Then
        TheLine = Left(TheLine, M - 1) & Right(TheLine, Len(TheLine) - M)
    End If
Loop
M = 1
Do Until M = 0
    M = InStr(1, TheLine, "++")
    If M <> 0 Then TheLine = Left(TheLine, M - 1) & Right(TheLine, Len(TheLine) - M)
Loop
M = 1
Do Until M = 0
    M = InStr(1, TheLine, "+*")
    If M <> 0 Then TheLine = Left(TheLine, M - 1) & Right(TheLine, Len(TheLine) - M)
Loop
M = 1
Do Until M = 0
    M = InStr(1, TheLine, "+/")
    If M <> 0 Then TheLine = Left(TheLine, M - 1) & Right(TheLine, Len(TheLine) - M)
 Loop
M = 1
Do Until M = 0
    M = InStr(1, TheLine, "*-")
    If M <> 0 Then TheLine = Left(TheLine, M - 1) & "* -" & Right(TheLine, Len(TheLine) - M - 1)
 Loop
M = 1
Do Until M = 0
    M = InStr(1, TheLine, "/-")
    If M <> 0 Then TheLine = Left(TheLine, M - 1) & "/ -" & Right(TheLine, Len(TheLine) - M - 1)
 Loop
M = 1
Do Until M = 0
    M = InStr(1, TheLine, "\-")
    If M <> 0 Then TheLine = Left(TheLine, M - 1) & "\ -" & Right(TheLine, Len(TheLine) - M - 1)
Loop
M = 1
Do Until M = 0
    M = InStr(1, TheLine, "*+")
    If M <> 0 Then TheLine = Left(TheLine, M - 1) & "*" & Right(TheLine, Len(TheLine) - M - 1)
Loop
M = 1
Do Until M = 0
    M = InStr(1, TheLine, "/+")
    If M <> 0 Then TheLine = Left(TheLine, M - 1) & "/" & Right(TheLine, Len(TheLine) - M - 1)
Loop
M = 1
Do Until M = 0
    M = InStr(1, TheLine, "\+")
    If M <> 0 Then TheLine = Left(TheLine, M - 1) & "\" & Right(TheLine, Len(TheLine) - M - 1)
Loop
M = 1
Do Until M = 0
    M = InStr(1, TheLine, "<-")
    If M <> 0 Then TheLine = Left(TheLine, M - 1) & "< -" & Right(TheLine, Len(TheLine) - M - 1)
 Loop
M = 1
Do Until M = 0
    M = InStr(1, TheLine, ">-")
    If M <> 0 Then TheLine = Left(TheLine, M - 1) & "> -" & Right(TheLine, Len(TheLine) - M - 1)
Loop
M = 1
Do Until M = 0
    M = InStr(1, TheLine, "<+")
    If M <> 0 Then TheLine = Left(TheLine, M - 1) & "<" & Right(TheLine, Len(TheLine) - M - 1)
 Loop
M = 1
Do Until M = 0
    M = InStr(1, TheLine, ">+")
    If M <> 0 Then TheLine = Left(TheLine, M - 1) & ">" & Right(TheLine, Len(TheLine) - M - 1)
Loop
M = 1
Do Until M = 0
    M = InStr(1, TheLine, "False<")
    If M <> 0 Then TheLine = Left(TheLine, M - 1) & "0 and 0 <" & Right(TheLine, Len(TheLine) - M - 5)
Loop
M = 1
Do Until M = 0
    M = InStr(1, TheLine, "False>")
    If M <> 0 Then TheLine = Left(TheLine, M - 1) & "0 and 0 >" & Right(TheLine, Len(TheLine) - M - 5)
Loop
M = 1
Do Until M = 0
    M = InStr(1, TheLine, "False=")
    If M <> 0 Then TheLine = Left(TheLine, M - 1) & "0 and 0 =" & Right(TheLine, Len(TheLine) - M - 5)
Loop
M = 1
Do Until M = 0
    M = InStr(1, TheLine, "<False")
    If M <> 0 Then TheLine = Left(TheLine, M - 1) & "< 0 and 0" & Right(TheLine, Len(TheLine) - M - 5)
Loop
M = 1
Do Until M = 0
    M = InStr(1, TheLine, ">False")
    If M <> 0 Then TheLine = Left(TheLine, M - 1) & "> 0 and 0" & Right(TheLine, Len(TheLine) - M - 5)
Loop
M = 1
Do Until M = 0
    M = InStr(1, TheLine, "=False")
    If M <> 0 Then TheLine = Left(TheLine, M - 1) & "= 0 and 0" & Right(TheLine, Len(TheLine) - M - 5)
Loop
'GoTo CalcTheString
M = 1
Do Until M = 0
    M = InStr(1, TheLine, "False <")
    If M <> 0 Then TheLine = Left(TheLine, M - 1) & "0 and 0 <" & Right(TheLine, Len(TheLine) - M - 6)
Loop
M = 1
Do Until M = 0
    M = InStr(1, TheLine, "False >")
    If M <> 0 Then TheLine = Left(TheLine, M - 1) & "0 and 0 >" & Right(TheLine, Len(TheLine) - M - 6)
Loop
M = 1
Do Until M = 0
    M = InStr(1, TheLine, "False =")
    If M <> 0 Then TheLine = Left(TheLine, M - 1) & "0 and 0 =" & Right(TheLine, Len(TheLine) - M - 6)
Loop
M = 1
Do Until M = 0
    M = InStr(1, TheLine, "< False")
    If M <> 0 Then TheLine = Left(TheLine, M - 1) & "< 0 and 0" & Right(TheLine, Len(TheLine) - M - 6)
Loop
M = 1
Do Until M = 0
    M = InStr(1, TheLine, "> False")
    If M <> 0 Then TheLine = Left(TheLine, M - 1) & "> 0 and 0" & Right(TheLine, Len(TheLine) - M - 6)
Loop
M = 1
Do Until M = 0
    M = InStr(1, TheLine, "= False")
    If M <> 0 Then TheLine = Left(TheLine, M - 1) & "= 0 and 0" & Right(TheLine, Len(TheLine) - M - 6)
Loop
M = 1
Do Until M = 0
    M = InStr(1, TheLine, "log")
    If M <> 0 Then
        TheLine = Left(TheLine, M - 1) & Right(TheLine, Len(TheLine) - M - 2)
        ShowResult = True
    End If
Loop
'If InStr(TheLine, "Sqr") <> 0 Then ErrorLogEntry TheLine: ShowResult = True
CalcTheString:
If Right(TheLine, 1) = "+" Or Right(TheLine, 1) = "-" Or Right(TheLine, 1) = "*" Or Right(TheLine, 1) = "/" Then TheLine = Left(TheLine, Len(TheLine) - 1)
If NNEN(TheLine) = "" Then Exit Function
TheCalcString = Hundredths(Form_Parser.Parse(TheLine))
CalcString = TheCalcString
If ShowResult Then ErrorLogEntry "Result " & TheCalcString

End Function


Function pi() As Single

pi = 4 * Atn(1)

End Function

Sub RotZ(XCoordinate, YCoordinate, angle)

Dim XNew As Currency
Dim YNew As Currency
XNew = XCoordinate * Cos(angle) - YCoordinate * Sin(angle)
YNew = XCoordinate * Sin(angle) + YCoordinate * Cos(angle)
XCoordinate = Thousandths(XNew)
YCoordinate = Thousandths(YNew)

End Sub


Sub RotX(XCoordinate, YCoordinate, ZCoordinate, angle)

YNew = YCoordinate * Cos(angle) - ZCoordinate * Sin(angle)
ZNew = YCoordinate * Sin(angle) + ZCoordinate * Cos(angle)
YCoordinate = YNew
ZCoordinate = ZNew

End Sub
Sub VAV(X1, y1, deg, X2, y2, cX, cY, Cr, ca)

'function [cx, cy, cr, ca] = VAV(x1, y1, deg, x2, y2)

' VAV -- Vertex-Angle-Vertex circle solution.
'  [CX,CY,CR,CA]=VAV(X1,Y1,DEG,X2,Y2) returns the
'   center (CX,CY), radius CR, and angle CA (degrees)
'   subtended by the circular arc lying between vertices
'   (X1,Y1) and (X2,Y2), spanning angle DEG in degrees.
'  VAV (no argument) demonstrates itself.
 
' Copyright (C) 1995 Dr. Charles R. Denham, ZYDECO.
' All Rights Reserved.
 
' Version of 23-Jan-95 at 09:55:26.4.

On Error Resume Next
rcf = 180 / pi()   ' Radian conversion factor.


' Setup.

dx = (X2 - X1) / 2
dy = (y2 - y1) / 2
DD = Sqr(dx * dx + dy * dy)
TT = Tan((deg / 2) / rcf)

' Center of circle.

cX = Hundredths(X1 + dx - (dy / TT))
cY = Hundredths(y1 + dy + (dx / TT))

' Radius of circle.

dx = X1 - cX
dy = y1 - cY
Cr = Hundredths(Sqr(dx * dx + dy * dy))

' Angle subtended (computed).

ca = 2 * Atn(DD / Sqr(Cr * Cr - DD * DD)) * rcf

End Sub

Function Tenths(TheNumber)

Tenths = ConditionNumber(Format(TheNumber, "#.0"))

End Function

Public Sub SizeFormTo(X, Y)

DoCmd.MoveSize , , X * 1440, Y * 1440

End Sub


Public Function LocalVariable(TheName)

On Error GoTo LocalVariableError
theKey = LocalSettings!Key
LocalSettings.FindFirst " [LocalSettingText5] = '" & TheName & "' "
        'MsgBox ""
If LocalSettings.NoMatch Then
    EchoOff
    If Left(TheName, 5) = "Form_" Then
        Dim TheForm As String, dbs As Database, ctr As Container, doc As Document, ctl As Control
        i = 6
        Do Until Mid(TheName, i, 1) = "_": i = i + 1: Loop
        TheForm = Mid(TheName, 6, i - 6)
        Set dbs = CurrentDb
        Set ctr = dbs.Containers!Forms
        For Each doc In ctr.Documents
            If doc.Name = TheForm Then
                Exit For
            End If
        Next doc
         If Not FIsLoaded(TheForm) Then
            Closeform = True
            DoCmd.OpenForm TheForm, acHidden
        End If
        For i = 0 To Forms.Count - 1
            If Forms(i).FormName = TheForm Then Exit For
        Next i
        TheVariable = ""
        TheNumber = i
        For Each ctl In Forms(TheNumber).Controls
            If TheName = "Form_" & TheForm & "_" & ctl.Name Then
                For i = 0 To ctl.Properties.Count - 1
                    If InStr(ctl.Properties.Item(i).Name, "DefaultValue") <> 0 Then
                        TheVariable = ctl.Properties.Item(i).Value
                        'MsgBox "Initialized " & ctl.Name & " to " & ctl.Properties.Item(I).Value
                        Exit For
                    End If
                Next i
                Exit For
            End If
        Next
    End If
    SetLocalVariable TheName, TheVariable
    LocalVariable = TheVariable
    If Closeform = True Then DoCmd.Close acForm, TheForm
    EchoOn
Else
    LocalVariable = NNEN(LocalSettings!LocalSettingText6)
End If
LocalSettings.FindFirst " [Key] = " & theKey
Exit Function

LocalVariableError:
'MsgBox Err.Description
GetSettings
Resume ResumeLocalVariableError
ResumeLocalVariableError:

End Function



Sub FormatTime(ElapsedTime, TheMinutes, TheSeconds)

ElapsedTime = (ElapsedTime * 10 \ 1) / 10
If ElapsedTime > 59 Then
    TheMinutes = ElapsedTime \ 60
    TheSeconds = Tenths(ElapsedTime - TheMinutes * 60) & " seconds"
    If ElapsedTime > 119 Then TheMinutes = TheMinutes & " minutes" Else TheMinutes = TheMinutes & " minute"
Else
    TheMinutes = ""
    TheSeconds = ElapsedTime & " seconds"
End If

End Sub
Public Function NotNull(TheString)

If IsNull(TheString) Then
ElseIf TheString = "" Then
Else
    NotNull = True
End If

End Function

Public Sub EchoNo(TheMessage)

g_Echo = False
DoCmd.Hourglass True
'docmd.Echo False
Access.Application.Echo False, TheMessage

End Sub

Public Sub EchoOff()

g_Echo = False
DoCmd.Hourglass True
Access.Application.Echo False

End Sub

Public Sub EchoOn()

On Error Resume Next
If g_EchoFix Then Exit Sub
g_Echo = True
DoCmd.Hourglass False
Access.Application.Echo (True)
'StatusBarMessage "echo on"

End Sub

Public Function DesignView()

On Error Resume Next
DoCmd.RunCommand acCmdDesignView
If TheUsername = "Marshall" Then
    DoCmd.ShowToolbar "Form Design", acToolbarYes
End If

End Function

Public Function DesignReportView()

On Error Resume Next
DoCmd.RunCommand acCmdDesignView
If TheUsername = "Marshall" Then
    DoCmd.ShowToolbar "Report Design", acToolbarYes
End If

End Function

Public Sub SaveRecord()

On Error Resume Next
DoCmd.DoMenuItem acFormBar, acFile, acSaveRecord
'docmd.RunCommand acCmdSaveRecord
'save record
'docmd.DoMenuItem 0, 0, 4
g_SaveProductList = False

End Sub

Public Sub UndoRecord()

On Error Resume Next
SaveRecord
DoCmd.DoMenuItem 0, 1, 0
SaveRecord

End Sub


Public Sub PositionWideForm()

PositionForm

End Sub

Public Function getDisplayHeight() As Long

Dim indAdapter As Long, indDisplay As Long
Dim ddAdapters As DISPLAY_DEVICE, ddDisplays As DISPLAY_DEVICE
ddAdapters.cb = Len(ddAdapters):  ddDisplays.cb = Len(ddDisplays)
Dim theDeviceName As String: theDeviceName = ""
Dim theMonitors As Integer: theMonitors = 0
indAdapter = 0
Do Until EnumDisplayDevices(vbNullString, indAdapter, ddAdapters, 0) = 0

  If (ddAdapters.StateFlags And DISPLAY_DEVICE_ATTACHED_TO_DESKTOP) = DISPLAY_DEVICE_ATTACHED_TO_DESKTOP Then

      Dim NullCharPos As Long
      NullCharPos = InStr(ddAdapters.DeviceName, vbNullChar)
        
      Dim CurDeviceName As String

      If NullCharPos > 0 Then
        CurDeviceName = Left$(ddAdapters.DeviceName, NullCharPos - 1)
      Else
        CurDeviceName = ddAdapters.DeviceName
      End If
      If theDeviceName <> CurDeviceName Then
        theDeviceName = CurDeviceName
        theMonitors = theMonitors + 1
      End If
      Dim dmode As DEVMODE
      dmode.dmSize = Len(dmode)

      EnumDisplaySettings CurDeviceName, ENUM_CURRENT_SETTINGS, dmode

      getDisplayHeight = dmode.dmPelsHeight
      If theMonitors = 2 Then getDisplayHeight = 1080: Exit Function
  End If

  indAdapter = indAdapter + 1
Loop
End Function

Public Sub PositionForm()

On Error Resume Next

DoCmd.ShowToolbar "Report Design", acToolbarNo
DoCmd.ShowToolbar "Form Design", acToolbarNo
If NNEN(Screen.ActiveForm.Caption) = "" Then TheFormName = Screen.ActiveForm.Name Else TheFormName = Screen.ActiveForm.Caption
SetVariable "User " & TheUsername & "_" & "KRH_Form" & "_" & TheFormName, Str(Date)
SetMenu
HideAllForms
ListWidth = 10.6 * 1440
ListHeight = 7 * 1440
If Screen.ActiveForm.FormName = "ProductListMaster" Then ListWidth = 13 * 1440
If Screen.ActiveForm.FormName = "Partslist" Then ListWidth = 13 * 1440
If Screen.ActiveForm.FormName = "CNC" Then ListWidth = 13 * 1440
If LocalVariable("screensize") = "Normal" Then
Else
     ListHeight = 9.9 * 1440
End If


If getDisplayHeight >= 1080 Then
    DoCmd.MoveSize 0, 0, 13 * 1440, 9.9 * 1440
Else
    DoCmd.MoveSize 0, 0, 13 * 1440, 7 * 1440
End If


'DoCmd.MoveSize 0, 0, ListWidth, ListHeight
'SizetoForm
For i = 0 To Forms.Count - 1
    'If Forms(I).FormName = "MainMenu" Then
    If Forms(i).FormName = Screen.ActiveForm.FormName Then
        Forms(i).Visible = True
    Else
        Forms(i).Visible = False
    End If
Next i

End Sub

Public Function setAppSize()

DetermineApplication
If NNEZ(LocalVariable(g_TheAppName & "_AppWidth")) = 0 Then SetLocalVariable g_TheAppName & "_AppWidth", 10.6
If getDisplayHeight >= 1080 Then
    setSizeLarge ("Load")
Else
    setSizeNormal ("Load")
End If
SizetoForm

End Function


Public Function setSizeNormal(State)

On Error Resume Next

EchoOff
SetLocalVariable g_TheAppName & "_ScreenSize", "Normal"
DoCmd.ShowToolbar "Report Design", acToolbarNo
DoCmd.ShowToolbar "Form Design", acToolbarNo
HideAllForms
Dim ListWidth, ListHeight
ListWidth = 13 * 1440 'LocalVariable(g_TheAppName & "_AppWidth") * 1440
ListHeight = 7 * 1440
If Screen.ActiveForm.Name = "ProductListMaster" Then Form_ProductListMaster.SetPLMSize
If Screen.ActiveForm.Name = "ProductListMaster" Then Form_ProductList.Form_Load
DoCmd.MoveSize 0, 0, ListWidth, ListHeight
SizetoForm
Dim i
For i = 0 To Forms.Count - 1
    If Forms(i).FormName = Screen.ActiveForm.FormName Then
        Forms(i).Visible = True
    Else
        Forms(i).Visible = False
    End If
Next i
If LocalVariable("Scratchpad") = "Close" Then
    SetLocalVariable "Scratchpad", ""
    DoCmd.Close acForm, "CNC"
    DoCmd.Close acForm, "PartList"
    DoCmd.Close acForm, "ProductListMaster"
    DoCmd.OpenForm "ProductListMaster"
End If
'EchoOn
    
End Function


Public Function setSizeLarge(State)

On Error Resume Next

EchoOff
If NNEZ(LocalVariable(g_TheAppName & "_AppWidth")) = 0 Then SetLocalVariable g_TheAppName & "_AppWidth", 13
SetLocalVariable g_TheAppName & "_ScreenSize", "Large"
DoCmd.ShowToolbar "Report Design", acToolbarNo
DoCmd.ShowToolbar "Form Design", acToolbarNo
HideAllForms
'SetMenu
Dim ListWidth, ListHeight
ListHeight = 9.9 * 1440
ListWidth = 13 * 1440 'LocalVariable(g_TheAppName & "_AppWidth") * 1440
If Screen.ActiveForm.Name = "ProductListMaster" Then Form_ProductListMaster.SetPLMSize
If Screen.ActiveForm.Name = "ProductListMaster" Then Form_ProductList.Form_Load
DoCmd.MoveSize 0, 0, ListWidth, ListHeight
SizetoForm
Dim i
For i = 0 To Forms.Count - 1
    If Forms(i).FormName = Screen.ActiveForm.FormName Then
        Forms(i).Visible = True
    Else
        Forms(i).Visible = False
    End If
Next i
If LocalVariable("Scratchpad") = "Close" Then
    SetLocalVariable "Scratchpad", ""
    DoCmd.Close acForm, "CNC"
    DoCmd.Close acForm, "PartList"
    DoCmd.Close acForm, "ProductListMaster"
    DoCmd.OpenForm "ProductListMaster"
End If
'EchoOn


End Function

Public Sub PositionReport(TheReport)

On Error Resume Next

SetVariable "User " & TheUsername & "_" & "KRH_Report" & "_" & TheReport, Str(Date)
DoCmd.ShowToolbar "Form Design", acToolbarNo
DoCmd.ShowToolbar "Report Design", acToolbarNo
DoCmd.ShowToolbar "Print Preview", acToolbarNo
ListWidth = 0
'DoCmd.MoveSize 3 * 1440, 0, 5.5, 7
DoCmd.Maximize

End Sub

Sub MenuBlack(M, n)

On Error Resume Next
DoCmd.SetMenuItem M - 1, n, , acMenuUngray

End Sub


Sub MenuGray(M, n)

On Error Resume Next
DoCmd.SetMenuItem M - 1, n, , acMenuGray

End Sub

Sub MenuCheck(M, n)

On Error Resume Next
DoCmd.SetMenuItem M - 1, n, , acMenuCheck

End Sub

Sub MenuUnCheck(M, n)

On Error Resume Next
DoCmd.SetMenuItem M - 1, n, , acMenuUncheck

End Sub

Function Thousandths(TheNumber) As Currency

Thousandths = ConditionNumber(Format(TheNumber, "#.##0"))

End Function

Public Sub StatusBarMessage(TheMessage)

If TheMessage = "" Then TheMessage = " "
On Error Resume Next
If Visio Then
    Forms!Message!TheMessage.Caption = TheMessage
Else
    temp = SysCmd(acSysCmdSetStatus, TheMessage)
    'If TheMessage <> " " Then ErrorLogEntry TheMessage
    'g_StatusBarMessage = ""
End If

End Sub


Public Sub SetLocalVariable(TheName, TheVariable)

On Error GoTo SetLocalVariableError
If NNEN(TheName) = "" Then
    TheName = "Form_" & Screen.ActiveForm.FormName & "_" & Screen.ActiveControl.ControlName
    TheVariable = Screen.ActiveControl
End If
If NNEN(TheVariable) = "" Then TheVariable = Null
GetSettings
LocalSettings.FindFirst " [LocalSettingText5] = '" & TheName & "' "
If LocalSettings.NoMatch Then
    If TheVariable = "DeleteThisVariable" Then GetSettings: Exit Sub
    LocalSettings.MoveFirst
    Do Until LocalSettings.EOF
        If NNEN(LocalSettings!LocalSettingText5) = "" Then LocalSettings.Edit: GoTo CreateNewVariable
        LocalSettings.MoveNext
    Loop
    LocalSettings.AddNew
    GoTo CreateNewVariable
Else
    LocalSettings.Edit
    If TheVariable = "DeleteThisVariable" Then
        TheVariable = ""
        LocalSettings!LocalSettingText5 = Null
        LocalSettings!LocalSettingText6 = Null
        LocalSettings.Update
        ErrorLogEntry "Deleted local variable " & LocalSettings!Key & " " & TheName
    Else
        LocalSettings!LocalSettingText6 = TheVariable
        If LocalSettings!LocalSettingText5 = "Form_Resources_ResourceList" Then
        ElseIf InStr(LocalSettings!LocalSettingText5, "Form_Resources_ResourceList") <> 0 Then
            Dim myset As DAO.Recordset
            Set myset = mydb.OpenRecordset("Select ID from [>Resources] where key = " & Val(TheVariable), dbOpenDynaset, dbSeeChanges)
            If myset.RecordCount <> 0 Then
                LocalSettings!LocalSettingText7 = myset!ID
            End If
        End If
        LocalSettings.Update
    End If
End If
GetSettings
Exit Sub

CreateNewVariable:
LocalSettings!LocalSettingText5 = TheName
LocalSettings!LocalSettingText6 = TheVariable
LocalSettings.Update
ErrorLogEntry "Created new local variable " & TheName
GetSettings
Exit Sub

SetLocalVariableError:
    'MsgBox Err.Description
Resume ResumeSetLocalVariableError
ResumeSetLocalVariableError:


End Sub

Public Function SetMonitor(TheSize)

'Form_Synchronization.UpdateProjectSchedule
'Exit Function
SetLocalVariable "FormMainMenu_ScreenSize", TheSize
If TheSize = 0 Then
    DoCmd.RunCommand acCmdAppMaximize
    SetLocalVariable "Appsize", "Maximize"
Else
    DoCmd.RunCommand acCmdAppRestore
    SetLocalVariable "Appsize", "Sizeable"
End If
PositionWideForm
setSizes

'Forms!MainMenu.Requery

End Function

Function ResponseYes(TheMessage)

If MsgBox(TheMessage, 36, "") = 6 Then ResponseYes = True

End Function

Public Function Password(TheString)

g_Password = TheString
DoCmd.OpenForm "Password"
While g_Password = TheString
    DoEvents
Wend
DoCmd.Close acForm, "Password"
If g_Password = "True" Then
    TheMessage = ""
    Password = True
Else
    MsgBox "Password is incorrect.", 64, "Password"
    TheMessage = " Unsuccessful"
End If
SetVariable "User " & TheUsername & "_" & g_ThisForm & "_" & Forms(Forms.Count - 1).FormName, Str(Date) & TheMessage

End Function

Public Function ResourcePassword(TheString)

g_Password = TheString
DoCmd.OpenForm "ResourcePassword"
While g_Password = TheString
    DoEvents
Wend
DoCmd.Close acForm, "ResourcePassword"
If g_Password = "True" Then
    TheMessage = ""
    ResourcePassword = True
Else
    MsgBox "Password is incorrect.", 64, "Password"
    TheMessage = " Unsuccessful"
    SetVariable "User " & TheUsername & "_" & "Resource Password ", Str(Date) & " Unsuccessful"
End If
SetVariable "User " & TheUsername & "_" & g_ThisForm & "_" & Forms(Forms.Count - 1).FormName, Str(Date) & TheMessage

End Function

Public Function NNEZ(TheNumber)

On Error Resume Next
If IsNull(TheNumber) Or TheNumber = "" Then NNEZ = 0 Else NNEZ = TheNumber


End Function

Public Function NNEN(TheString)

On Error Resume Next
If IsNull(TheString) Then NNEN = "" Else NNEN = TheString


End Function

Function MessageOKCancel(TheMessage)

'returns True when no is selected
'returns false when yes is selected
MessageOKCancel = False
Response = MsgBox(TheMessage, 36, " ")
If Response = 7 Then ' cancel
    MessageOKCancel = True
    RecalculateListInProgress = False
End If

End Function


Function MessageOK(TheMessage)

MsgBox TheMessage, 64, "Message"

End Function

Function MessageYesNoCancel(TheMessage) As String

Response = MsgBox(TheMessage, 35, " ")
If Response = vbNo Then
    MessageYesNoCancel = "No"
    RecalculateListInProgress = False
ElseIf Response = vbYes Then
    MessageYesNoCancel = "Yes"
    RecalculateListInProgress = False
Else
    MessageYesNoCancel = "Cancel"
    RecalculateListInProgress = False
End If

End Function

Function MessageYesNo(TheMessage) As String

Response = MsgBox(TheMessage, vbYesNo, " ")
If Response = vbNo Then
    MessageYesNo = "No"
ElseIf Response = vbYes Then
    MessageYesNo = "Yes"
End If

End Function

Function LowerCase(TheString)

TheString = LCase(TheString)

End Function

Function Hundredths(TheNumber)

Hundredths = ConditionNumber(Format(TheNumber, "#.#0"))

End Function


Function RoundDown(TheNumber)

RoundDown = ConditionNumber(Format(TheNumber, "#."))

End Function

Function FIsActiveForm(stFrmName$) As Integer

FIsActiveForm = False
On Error GoTo FIsActiveFormError
'If LastForm = stFrmName$ And FIsLoaded(stFrmName$) Then FIsActiveForm = True
If Screen.ActiveControl.ControlName = "Key" Then FIsActiveForm = False
If Screen.ActiveForm.FormName = stFrmName$ Then
    FIsActiveForm = True
End If
Exit Function
FIsActiveFormError:
Resume ResumeFIsActiveFormError
ResumeFIsActiveFormError:

End Function


'----------------------------------------------------------------------------
' FUNCTION : FIsLoaded
'
' PURPOSE  : Returns true if a the given Form/Report is currently open.
'----------------------------------------------------------------------------
Function FIsLoaded(stFrmName$) As Integer

' Scan the open forms...
FIsLoaded = False

    For i = 0 To Forms.Count - 1
        If (Forms(i).FormName = stFrmName$) Then
            FIsLoaded = True
            Exit Function
        End If
    Next i

    ' Scan the open reports...

    For i = 0 To Reports.Count - 1
        If (Reports(i).FormName = stFrmName$) Then
            FIsLoaded = True
            Exit Function
        End If
    Next i

    FIsLoaded = False
If g_FormParts_Parts And stFrmName$ = "Parts" Then
    FIsLoaded = True
ElseIf g_FormParts_DrawingParts And stFrmName$ = "PartsDraw" Then
    FIsLoaded = True
ElseIf g_FormParts_CNCParts And stFrmName$ = "PartsCNC" Then
    FIsLoaded = True
Else
    If g_FormProductParts_DrawingPartsControl And g_FormParts_DrawingParts And stFrmName$ = "PartsDraw" Then
        FIsLoaded = True
    ElseIf g_FormProductParts_CNCPartsControl And g_FormParts_CNCParts And stFrmName$ = "PartsCNC" Then
        FIsLoaded = True
    End If
End If

End Function

Sub ErrorLogReport(TheNumber)

On Error Resume Next
Dim errorSet As DAO.Recordset
SetMyDB
Set errorSet = mydb.OpenRecordset("SELECT* from [>Errors] Where Not IsNull([Error])")
If errorSet.RecordCount <> 0 Then
    errorSet.MoveLast
    If errorSet.RecordCount >= TheNumber Then
        Beep
        If errorSet.RecordCount = 1 Then
            StatusBarMessage "There is 1 log entry. See the log for details."
        Else
            StatusBarMessage "There are " & errorSet.RecordCount & " log entries. See the log for details."
        End If
        ErrorLogEntry "Total entries: " & errorSet.RecordCount
        Finish = Timer + 3
        Do
        Loop Until Timer > Finish
    End If
End If

End Sub

Sub ErrorLogEntry(TheError)

On Error GoTo ErrorLogEntryError
While g_ElapsedTimer = Timer: Wend
g_ElapsedTimer = Timer
Dim errorSet As DAO.Recordset
SetMyDB
Set errorSet = mydb.OpenRecordset("SELECT* from [>Errors] Where [Error] = Null Order by [Key]")
If errorSet.RecordCount = 0 Then errorSet.AddNew Else errorSet.Edit
errorSet!Error = TheError
errorSet!Time = Timer
errorSet.Update
'TheActiveForm = Screen.ActiveForm.Caption
'ErrorSet.Edit
'ErrorSet!Form = TheActiveForm
'ErrorSet.Update
If FIsLoaded("Log") Then
    DoCmd.SelectObject acForm, "Log"
    Forms!Log.Requery
    Forms!Log.Refresh
End If

Exit Sub

ErrorLogEntryError:
Resume ResumeErrorLogEntryError
ResumeErrorLogEntryError:

End Sub


Sub ErrorLogClear()

On Error GoTo ErrorLogClearError
SetMyDB
Dim errorSet As DAO.Recordset, errorRecords As Integer
Set errorSet = mydb.OpenRecordset("SELECT* from [>Errors] where nnez(Time)<>0")
If errorSet.RecordCount <> 0 Then
    errorSet.MoveFirst
    Do Until errorSet.EOF
        'TheRecordNumber = TheRecordNumber + 1
        'If TheRecordNumber > 200 Then
            'ErrorSet.Delete
        'ElseIf NNEN(ErrorSet!Time) <> "" Or NNEN(ErrorSet!Form) <> "" Then
        errorSet.Edit
        errorSet!Error = Null
        errorSet!Form = Null
        errorSet!Time = Null
        errorSet.Update
        'End If
        errorSet.MoveNext
    Loop
End If
Exit Sub
 
ErrorLogClearError:
MsgBox Err.Description

End Sub

Function TenThousandths(TheNumber)

TenThousandths = ConditionNumber(Format(TheNumber, "#.###0"))

End Function


Public Function NNENull(TheString) As Variant
If NNEN(TheString) = "" Then NNENull = Null Else NNENull = TheString

End Function

Public Function ResourceAddressPhone(String1, String2, String3, String4, String5, String6)

On Error Resume Next
theaddress = ResourceAddress(String1, String2, String3, String4)
If NNEN(String5) <> "" Or NNEN(String6) <> "" Then
    theaddress = theaddress & Chr$(13) & Chr$(10) & String5 & " " & String6
End If
ResourceAddressPhone = theaddress

End Function

Public Function ResourcePhone(String4, String5)

On Error Resume Next
If NNEN(String4) <> "" Or NNEN(String5) <> "" Then
    theaddress = String4 & " " & String5
End If
ResourcePhone = theaddress

End Function

Public Function ResourceAddress(String1, String2, String3, String4)

On Error Resume Next
If NNEN(String1) <> "" Then String1 = String1 & CRLF
'If Right(String2, 1) <> "," Then String2 = String2 & ","
'ResourceAddress = String1 & String2 & "    " & String3 & "   " & String4
ResourceAddress = String1 & String2 & "  " & String3 & "  " & String4

End Function

Public Function ResourceTown(theKey)

On Error Resume Next
SetMyDB
Dim myset As DAO.Recordset
Set myset = mydb.OpenRecordset("Select * from [>Resources] where key = " & theKey, dbOpenDynaset, dbSeeChanges)
If myset.RecordCount <> 0 Then
    If NNEN(myset!Address) <> "" Then
        For i = 1 To Len(myset!Address)
            theaddress = theaddress & Mid(myset!Address, i, 1)
            If Mid(myset!Address, i, 1) = Chr$(10) Then theaddress = ""
            If Mid(myset!Address, i, 1) = Chr$(13) Then theaddress = ""
        Next i
    End If
    ResourceTown = theaddress
End If

End Function

Public Function ResourceStreet1(theKey)

On Error Resume Next
SetMyDB
Dim myset As DAO.Recordset
Set myset = mydb.OpenRecordset("Select * from [>Resources] where key = " & theKey, dbOpenDynaset, dbSeeChanges)
If myset.RecordCount <> 0 Then
    If NNEN(myset!Address) <> "" Then
        For i = 1 To Len(myset!Address)
            If Mid(myset!Address, i, 1) = Chr$(10) Then Exit For
            If Mid(myset!Address, i, 1) = Chr$(13) Then Exit For
            theaddress = theaddress & Mid(myset!Address, i, 1)
        Next i
    End If
    ResourceStreet1 = theaddress
End If

End Function

Public Function NotAPP()

Set mydb = CurrentDb()
If InStr(mydb.Name, "App") <> 0 Then NotAPP = False Else NotAPP = True

End Function

Public Function NoDashes(TheString)

For i = 1 To Len(TheString)
    If Mid(TheString, i, 1) <> "-" Then TheResult = TheResult & Mid(TheString, i, 1)
Next i
NoDashes = NNEN(TheResult)

End Function

Public Function ResourceID(TheLine)

On Error Resume Next
M = InStr(TheLine, "(")
If M <> 0 Then
    n = InStr(M, TheLine, ")")
    If n <> 0 Then
        If M <> 1 Then variant9 = Left(TheLine, M - 1) Else variant9 = ""
        If n <> Len(TheLine) Then variant1 = Right(TheLine, Len(TheLine) - n) Else variant1 = ""
        TheLine = variant9 & variant1
    End If
End If
ResourceID = TheLine

End Function

Public Function ResourceFirstID(TheLine)

On Error Resume Next
M = InStr(TheLine, "(")
If M <> 0 Then
    n = InStr(M, TheLine, ")")
    If n <> 0 Then
        If M <> 1 Then variant9 = Left(TheLine, M - 1) Else variant9 = ""
        If n <> Len(TheLine) Then variant1 = Right(TheLine, Len(TheLine) - n) Else variant1 = ""
        TheLine = variant9 & variant1
    End If
End If
If InStr(TheLine, Chr$(13)) <> 0 Then TheLine = Left(TheLine, InStr(TheLine, Chr$(13)) - 1)
ResourceFirstID = TheLine

End Function

Public Function Resource(theKey As Long)

Resource = NNEN(SQLResult("Select ID from [>Resources] where key =" & theKey))

End Function

Function GetAlternateDisplay(TheForm)

On Error GoTo GetAlternateDisplayError
'EchoOn
If TheForm = "Jobs" Then
    If IsNull(Forms!Jobs!JobName) Then
        On Error Resume Next
        Forms!Jobs!AlternateDisplay = ""
        Exit Function
    End If
End If
If TheForm = "ProductList" Then
    If IsNull(Forms!productlistmaster!ProductListControl!ProductListName) Then Exit Function
End If
TheAlternate = "Alternate "
TheList = "None"
Dim MyPLSet As DAO.Recordset, mytable As DAO.Recordset, SaleLinks As DAO.Recordset, myset As DAO.Recordset, MaterialSet As DAO.Recordset, MaterialsSet As DAO.Recordset, DesignsSet As DAO.Recordset, JobsSet As DAO.Recordset, ResourceSet As DAO.Recordset
SetMyDB
If InStr(TheForm, "Sales") <> 0 Then
    Set JobsSet = mydb.OpenRecordset("Select * from [>Jobs] where [Key] = " & Forms!Sales!JobName, dbOpenDynaset, dbSeeChanges)
    Set myset = mydb.OpenRecordset("SELECT * from [Sales Journal] WHERE [Job] = " & Forms!Sales!JobName & " Order by EntryDate", dbOpenDynaset, dbSeeChanges)
    Set SaleLinks = mydb.OpenRecordset("SELECT * from [Sales Journal] WHERE [Journal] = 'Sale' and [Job] = " & Forms!Sales!JobName & " Order by InvoiceNumber", dbOpenDynaset, dbSeeChanges)
    If myset.RecordCount <> 0 Then
        myset.MoveLast
        If NNEZ(myset!EntryDate) <> 0 Then
            TheLastDate = "Last transaction: " & myset!EntryDate
        End If
    End If
    Set myset = mydb.OpenRecordset("SELECT * from [>Jobs] WHERE [Key] = " & Forms!Sales!JobName & " ", dbOpenDynaset, dbSeeChanges)
    If myset.RecordCount = 0 Then
    ElseIf NNEZ(myset!Agreement) <> 0 And NNEZ(myset!Agreement) <> NNEZ(myset!Customer) Then
        TheCustomer = myset!Agreement
    Else
        TheCustomer = myset!Customer
    End If
    If InStr(TheForm, "Alpha") Or InStr(TheForm, "Numeric") Then GoTo ALPHANUMERIC
    If InStr(TheForm, "Heading") <> 0 Then
        Alt = Alt & Format(Date, "mmmm d, yyyy") & vbCrLf
    Else
        If NNEN(TheLastDate) <> "" Then Alt = TheLastDate & vbCrLf
    End If
    If myset.RecordCount <> 0 Then
        Alt = Alt & vbCrLf
        If InStr(TheForm, "SalesInvoice") = 0 Then
            Set ResourceSet = mydb.OpenRecordset("SELECT Employee from [MIS Personnel] WHERE [Key] = " & NNEZ(myset!ManagedBy) & " ", dbOpenDynaset, dbSeeChanges)
            If ResourceSet.RecordCount <> 0 Then
                Alt = Alt & "Partner: " & ResourceSet!Employee & vbCrLf
            End If
            Set ResourceSet = mydb.OpenRecordset("SELECT Employee from [MIS Personnel] WHERE [Key] = " & NNEZ(myset!SpecifiedBy) & " ", dbOpenDynaset, dbSeeChanges)
            If ResourceSet.RecordCount <> 0 Then
                Alt = Alt & "Project Manager: " & ResourceSet!Employee & vbCrLf
            End If
            Set ResourceSet = mydb.OpenRecordset("SELECT Employee from [MIS Personnel] WHERE [Key] = " & NNEZ(myset!EstimatedBy) & " ", dbOpenDynaset, dbSeeChanges)
            If ResourceSet.RecordCount <> 0 Then
                Alt = Alt & "Engineer: " & ResourceSet!Employee & vbCrLf
            End If
            Set ResourceSet = mydb.OpenRecordset("SELECT Employee from [MIS Personnel] WHERE [Key] = " & NNEZ(myset!InstalledBy) & " ", dbOpenDynaset, dbSeeChanges)
            If ResourceSet.RecordCount <> 0 Then
                Alt = Alt & "Installer: " & ResourceSet!Employee & vbCrLf
            End If
        End If
        If NNEZ(myset!Agreement) <> 0 Then
            TheName = SQLResult("Select TheName from [>Resources] where key = " & myset!Agreement)
            If InStr(TheName, Chr$(13)) <> 0 Then TheName = Left(TheName, InStr(TheName, Chr$(13)) - 1)
            TheAgreement = "The agreement is with " & TheName
            Set ResourceSet = mydb.OpenRecordset("SELECT * from [>Resources] WHERE [Key] = " & myset!Agreement & " ", dbOpenDynaset, dbSeeChanges)
        Else
            TheAgreement = "There is no agreement."
        End If
        If InStr(TheForm, "SalesInvoice") = 0 Then
            Alt = Alt & TheAgreement & vbCrLf
            If NNEZ(myset!Customer) <> 0 Then
                Alt = Alt & vbCrLf
                Alt = Alt & "Customer: "
                Set ResourceSet = mydb.OpenRecordset("SELECT * from [>Resources] WHERE [Key] = " & myset!Customer & " ", dbOpenDynaset, dbSeeChanges)
                If ResourceSet.RecordCount <> 0 Then
                    'alt = alt & ResourceID(ResourceSet!TheName) & vbCrLf
                    'alt = alt & ResourceAddressPhoneFax(ResourceSet!CompanyName, ResourceSet!Address, ResourceSet!State, ResourceSet!Zip, ResourceSet!AreaCode, ResourceSet!Field2, ResourceSet!Field3) & vbCrLf
                    Alt = Alt & ResourceFirstNameAddress(ResourceSet!Key) & vbCrLf
                    Alt = Alt & ResourcePhoneFax(ResourceSet!AreaCode, ResourceSet!Field2, ResourceSet!Field3) & vbCrLf
                    Alt = Alt & Resourceemail(ResourceSet!Key) & vbCrLf
                End If
            End If
            If NNEZ(myset!Architect) <> 0 Then
                Alt = Alt & vbCrLf
                Alt = Alt & "Architect: "
                Set ResourceSet = mydb.OpenRecordset("SELECT * from [>Resources] WHERE [Key] = " & myset!Architect & " ", dbOpenDynaset, dbSeeChanges)
                If ResourceSet.RecordCount <> 0 Then
                    Alt = Alt & ResourceID(ResourceSet!TheName) & vbCrLf
                    If TheAgreement = "architect" Then
                        Alt = Alt & ResourceAddressPhoneFax(ResourceSet!CompanyName, ResourceSet!Address, ResourceSet!State, ResourceSet!Zip, ResourceSet!AreaCode, ResourceSet!Field2, ResourceSet!Field3) & vbCrLf
                    Else
                        Alt = Alt & ResourcePhoneFax(ResourceSet!AreaCode, ResourceSet!Field2, ResourceSet!Field3) & vbCrLf
                    End If
                End If
            End If
            If NNEZ(myset!DesignedBy) <> 0 Then
                Alt = Alt & vbCrLf
                Alt = Alt & "Interior design: "
                Set ResourceSet = mydb.OpenRecordset("SELECT * from [>Resources] WHERE [Key] = " & myset!DesignedBy & " ", dbOpenDynaset, dbSeeChanges)
                If ResourceSet.RecordCount <> 0 Then
                    Alt = Alt & ResourceID(ResourceSet!TheName) & vbCrLf
                    If TheAgreement = "interior designer" Then
                        Alt = Alt & ResourceAddressPhoneFax(ResourceSet!CompanyName, ResourceSet!Address, ResourceSet!State, ResourceSet!Zip, ResourceSet!AreaCode, ResourceSet!Field2, ResourceSet!Field3) & vbCrLf
                    Else
                        Alt = Alt & ResourcePhoneFax(ResourceSet!AreaCode, ResourceSet!Field2, ResourceSet!Field3) & vbCrLf
                    End If
                End If
            End If
            If NNEZ(myset!Contractor) <> 0 Then
                Alt = Alt & vbCrLf
                Alt = Alt & "Contractor: "
                Set ResourceSet = mydb.OpenRecordset("SELECT * from [>Resources] WHERE [Key] = " & myset!Contractor & " ", dbOpenDynaset, dbSeeChanges)
                If ResourceSet.RecordCount <> 0 Then
                    Alt = Alt & ResourceID(ResourceSet!TheName) & vbCrLf
                    If TheAgreement = "contractor" Then
                        Alt = Alt & ResourceAddressPhoneFax(ResourceSet!CompanyName, ResourceSet!Address, ResourceSet!State, ResourceSet!Zip, ResourceSet!AreaCode, ResourceSet!Field2, ResourceSet!Field3) & vbCrLf
                    Else
                        Alt = Alt & ResourcePhoneFax(ResourceSet!AreaCode, ResourceSet!Field2, ResourceSet!Field3) & vbCrLf
                    End If
                End If
            End If
        Else 'invoice form
            If TheAgreement = "There is no agreement." Then
                Alt = Alt & "Please specify an agreement for this job." & vbCrLf
            ElseIf ResourceSet.RecordCount <> 0 Then
                'alt = alt & ResourceID(ResourceSet!TheName) & vbCrLf
                'alt = alt & ResourceAddress(ResourceSet!CompanyName, ResourceSet!Address, ResourceSet!State, ResourceSet!Zip) & vbCrLf
                Alt = Alt & ResourceFirstNameAddress(ResourceSet!Key) & vbCrLf
            Else
                Alt = Alt & "Please specify an agreement for this job." & vbCrLf
            End If
        End If
        Set myset = mydb.OpenRecordset("SELECT * from [>Jobs] WHERE [Key] = " & Forms!Sales!JobName & " ", dbOpenDynaset, dbSeeChanges)
        If NNEN(Forms!Sales!AlternateTitle) = "" Then
            JobID = "Project: " & myset!ID
        Else
            JobID = "Project: " & Forms!Sales!AlternateTitle
        End If
        If NNEZ(Forms!Sales!ShowRemarks) <> 0 Then
            If NNEN(Forms!Sales!Remarks) <> "" Then
                JobID = JobID & vbCrLf & vbCrLf & Forms!Sales!Remarks
            End If
        End If
        Alt = Alt & vbCrLf & JobID & vbCrLf & vbCrLf
        If InStr(TheForm, "Design") Then
            If LocalVariable("scratchpad") = "Weekly" Then
                Alt = Alt & "Design Weekly Hours" & vbCrLf & vbCrLf
            ElseIf LocalVariable("scratchpad") = "Progress" Then
                Alt = Alt & "Progress report for design hours"
                Alt = Alt & " from " & Format(Forms!Sales!FromDate, "m/d") & " to " & Format(Forms!Sales!ToDate, "m/d") & vbCrLf & vbCrLf
            Else
                If SQLResult("Select PrivateNote from [Sales Journal] where job =" & Forms!Sales!TheJobName & " and invoicenumber = " & Forms!Sales!SelectDesignInvoice) <> "" Then
                    Alt = Alt & SQLResult("Select PrivateNote from [Sales Journal] where job =" & Forms!Sales!TheJobName & " and invoicenumber = " & Forms!Sales!SelectDesignInvoice)
                Else
                    Alt = Alt & SQLResult("Select Description from [Sales Journal] where job =" & Forms!Sales!TheJobName & " and invoicenumber = " & Forms!Sales!SelectDesignInvoice)
                End If
                Alt = Alt & " " & Format(SQLResult("Select InvoiceAmount from [Sales Journal] where job =" & Forms!Sales!TheJobName & " and invoicenumber = " & Forms!Sales!SelectDesignInvoice), "$#,#.00")
                Alt = Alt & vbCrLf
                Alt = Alt & vbCrLf
            End If
        End If
        If InStr(TheForm, "Heading") Then
            GetAlternateDisplay = Alt
            Exit Function
        ElseIf InStr(TheForm, "SalesNoteHeader") <> 0 Then
            'Set myset = MyDB.OpenRecordset("SELECT Note from [Sales Journal] WHERE [Key] = " & Forms!Sales!InvoiceSubFormControl.Form!Key)
            'If myset.RecordCount <> 0 Then
                'If NNEN(myset!Note) <> "" Then GetAlternateDisplay = vbCrLf & NNEN(myset!Note)
            'End If
            Exit Function
        ElseIf InStr(TheForm, "SalesContractHeader") <> 0 Then
            If InStr(LCase(Forms!Sales!PrintDescription), "contract") <> 0 Then
                Set myset = mydb.OpenRecordset("SELECT ContractHeader from [>Settings] WHERE [Key] = 2", dbOpenDynaset, dbSeeChanges)
                If myset.RecordCount <> 0 Then GetAlternateDisplay = vbCrLf & NNEN(myset!ContractHeader)
            End If
            If InStr(LCase(Forms!Sales!PrintDescription), "proposal") <> 0 Then
                Set myset = mydb.OpenRecordset("SELECT ContractHeader from [>Settings] WHERE [Key] = 20", dbOpenDynaset, dbSeeChanges)
                If myset.RecordCount <> 0 Then GetAlternateDisplay = vbCrLf & NNEN(myset!ContractHeader)
            End If
            Exit Function
        ElseIf InStr(TheForm, "SalesContractFooter") <> 0 Then
            If InStr(LCase(Forms!Sales!PrintDescription), "contract") <> 0 Then
                Set myset = mydb.OpenRecordset("SELECT ContractFooter from [>Settings] WHERE [Key] = 2", dbOpenDynaset, dbSeeChanges)
                If myset.RecordCount <> 0 Then GetAlternateDisplay = NNEN(myset!ContractFooter)
            End If
            If InStr(LCase(Forms!Sales!PrintDescription), "proposal") <> 0 Then
                Set myset = mydb.OpenRecordset("SELECT ContractFooter from [>Settings] WHERE [Key] = 20", dbOpenDynaset, dbSeeChanges)
                If myset.RecordCount <> 0 Then GetAlternateDisplay = NNEN(myset!ContractFooter)
            End If
            Exit Function
        End If
        If TheForm = "SalesDue" Then
            'GetAlternateDisplay = NNEN(Format(Forms!Sales!InvoiceSubFormControl.Form!Due, "mmmm d, yyyy")) '& "    " & Forms!Sales!InvoiceSubFormControl.Form!Description
            'GetAlternateDisplay = NNEN(Format(Forms!Sales!InvoiceSubFormControl.Form!Due, "mmmm d, yyyy")) '& "    " & Forms!Sales!InvoiceSubFormControl.Form!Description
            Exit Function
        End If
        Set myset = mydb.OpenRecordset("Select * from [Sales Journal] where [Journal] = 'Invoice' and [Job] = " & Forms!Sales!JobName, dbOpenDynaset, dbSeeChanges)
        If myset.RecordCount <> 0 Then
            myset.MoveFirst
            Do Until myset.EOF Or NNEZ(myset!InvoiceNumber) = Val(LocalVariable("PrintDescriptionNumber"))
                myset.MoveNext
            Loop
            If TheForm = "SalesDueAmount" Then
                TheLabel = ""
                TheTotal = NNEZ(myset!InvoiceAmount)
                If Forms!Sales!JobLabel.Caption = "Closed" Then Exit Function
                If Forms!Sales!ShowInvoiceDate Then
                    TheLabel = NNEN(Format(myset!Due, "mmmm d, yyyy")) & " "
                End If
                '''''If InStr(LCase(Forms!Sales!PrintDescription), "contract") <> 0 Then
                    '''''If Forms!Sales!ShowInvoiceAmount Then
                        '''''Set mySet = mydb.OpenRecordset("Select * from [Sales Journal] where [Journal] = 'Sale' and [Job] = " & Forms!Sales!JobName)
                        '''''If mySet.RecordCount <> 0 Then
                            '''''mySet.MoveFirst
                            '''''Do Until mySet.EOF
                                '''''If InStr(mySet!Category, "Additional") = 0 Then
                                    '''''TotalSale = TotalSale + mySet!SaleAmount
                                '''''End If
                                '''''mySet.MoveNext
                            '''''Loop
                        '''''End If
                        '''''If NNEZ(TotalSale) <> 0 Then
                            '''''TheLabel = TheLabel & ": $" & Format(TotalSale, "###,##0.00")
                        '''''End If
                    '''''End If
                '''''Else
                    If InStr(LocalVariable("PageCaption"), "Statement") <> 0 Then
                        TheLabel = LocalVariable("PageCaption") & " "
                    Else
                        If Forms!Sales!ShowInvoiceDescription Then
                            TheLabel = TheLabel & NNEZ(myset!Description) & " "
                        Else
                            TheLabel = TheLabel & LocalVariable("PageCaption") & " "
                        End If
                        'If NNEN(myset!PrivateNote) <> "" Then
                            'If Len(myset!PrivateNote) > 20 Then TheLabel = TheLabel & CRLF
                            'TheLabel = TheLabel & myset!PrivateNote & " "
                        'End If
                        If Forms!Sales!ShowInvoiceAmount Then
                            If NNEZ(TheTotal) <> 0 Then TheLabel = TheLabel & ":  $" & Format(TheTotal, "###,##0.00")
                        End If
                    '''''End If
                        If Forms!Sales!SecondNotice Then
                            TheLabel = TheLabel & vbCrLf & vbCrLf & Format(Date, "d mmmm yyyy") & " " & Forms!Sales!OverdueText & vbCrLf
                        End If
                    End If
                GetAlternateDisplay = TheLabel
                Exit Function
            End If
        End If
    End If
ALPHANUMERIC:
    If Not Forms!Sales!Family Then 'InStr(TheForm, "SalesClose") <> 0 Or InStr(TheForm, "SalesProposal") <> 0 Then
        Set myset = mydb.OpenRecordset("Select * from [Sales Journal] where [Job] = " & Forms!Sales!JobName & " Order by Journal, InvoiceNumber", dbOpenDynaset, dbSeeChanges)
    Else
        Set myset = mydb.OpenRecordset("SELECT [>Jobs].ID, [Sales Journal].* FROM [>Jobs] LEFT JOIN [Sales Journal] ON [>Jobs].[Key] = [Sales Journal].[Job] WHERE IIf([>Jobs].[Parent] = " & Forms!Sales!JobName & ", True, False) ORDER BY [>Jobs].ID, [Sales Journal].Journal, [Sales Journal].InvoiceNumber", dbOpenDynaset, dbSeeChanges)
        'Set myset = mydb.OpenRecordset("Select * from [Sales Journal] where [Job] = " & Forms!Sales!JobName & " Order by Journal, InvoiceNumber", dbOpenDynaset, dbSeeChanges)
    End If
'agreement
    If TheForm = "Sales" Then
        Forms!Sales!Information = Alt
        savealt = Alt
        Alt = ""
    End If
    StatusBarMessage "Getting Agreement"
    SummaryBefore = False
    DetailBefore = False
    If myset.RecordCount <> 0 Then
        myset.MoveFirst
        TheContractDate = ""
        Do Until myset.EOF
            If myset!Description = "Contract" Then
                If NNEN(myset!Due) <> "" Then
                    If Not Forms!Sales!Family Then TheContractDate = Format(myset!Due, "mmmm d, yyyy") & " "
                    Exit Do
                End If
            End If
            myset.MoveNext
        Loop
        myset.MoveFirst
        Thedata = ""
        If InStr(TheForm, "Numeric") Then
        ElseIf InStr(TheForm, "AlphaText") Then
            If InStr(LCase(Forms!Sales!PrintDescription), "contract") = 0 Then
                Thedata = Thedata & TheContractDate & "Sale:"
            Else
                Thedata = "Sale:"
            End If
        ElseIf InStr(TheForm, "AlphaDescription") Then
        Else
            Thedata = TheContractDate & "Sale:"
        End If
        If TheForm = "Sales" Or Forms!Sales!ShowAgreement Or Forms!Sales!ShowAgreementSummary Then
            Alt = Alt & Thedata
            If TheForm = "Sales" Or Forms!Sales!ShowAgreement Then Alt = Alt & vbCrLf
        End If
        Do Until myset.EOF
            If Not Forms!Sales!Family Then thechild = "" Else thechild = myset!ID & " "
            TheCrLF = False
            If NNEN(myset!PrivateNote) <> "" Then
                TheDescription = myset!PrivateNote
                If Len(TheDescription) > 50 Then
                    TheCrLF = True
                End If
            Else
                TheDescription = myset!Category
            End If
            If myset!Journal = "Sale" And InStr(myset!Category, "Additional") <> 0 Then
                If Forms!Sales!ShowAdditional Or Forms!Sales!ShowAdditionalSummary Then totalAdditional = NNEZ(totalAdditional) + NNEZ(myset!SaleAmount)
            ElseIf myset!Journal = "Sale" And InStr(myset!Category, "Additional") = 0 Then
                If InStr(TheForm, "Numeric1") Then
                    Thedata = Format(NNEZ(myset!SaleAmount), "###,##0.00")
                ElseIf InStr(TheForm, "Numeric2") Then
                    Thedata = ""
                ElseIf InStr(TheForm, "AlphaText") Then
                    Thedata = ""
                ElseIf InStr(TheForm, "AlphaDescription") Then
                    Thedata = "" & TheDescription
                    'MsgBox TheDescription
                    'On Error GoTo 0
                    '[Reports]![Sales Invoice Report]![AmountLabel].Caption = "Hello"
                Else
                    Thedata = myset!Category & " " & " " & Format(NNEZ(myset!SaleAmount), "###,##0.00")
                    TheCrLF = False
                End If
                If TheForm = "Sales" Or Forms!Sales!ShowAgreement Then
                    Alt = Alt & thechild & Thedata & vbCrLf
                    If TheCrLF And InStr(TheForm, "AlphaDescription") = 0 Then
                        Alt = Alt & vbCrLf
                    End If
                    If Len(TheDescription) > 35 Then
                        TheLongNote = True
                    End If
                End If
                TotalSale = TotalSale + NNEZ(myset!SaleAmount)
                If InStr(TheForm, "SalesClose") <> 0 Then
                    If Not Forms!Sales!JobSubForm.Form!Proposal Then
                        If NNEN(myset!TheDate) = "" Then
                            GetAlternateDisplay = "a sale is not dated."
                            Exit Function
                        ElseIf Year(myset!TheDate) >= SQLResult("Select FY9 from [MIS Accounts] where Number = 101") Then 'Year(NNEZ(Settings!ArchiveDate)) Then
                            GetAlternateDisplay = "a sale dated " & myset!TheDate & " is in current period"
                            Exit Function
                        End If
                    ElseIf Forms!Sales!JobSubForm.Form!Proposal Then
                        If NNEN(myset!TheDate) <> "" Then
                            GetAlternateDisplay = "a sale is dated."
                            Exit Function
                        End If
                    End If
                ElseIf InStr(TheForm, "SalesProposal") <> 0 Then
                    If NNEN(myset!TheDate) <> "" Then
                        GetAlternateDisplay = "a sale is dated " & myset!TheDate
                        Exit Function
                    End If
                End If
            End If
            myset.MoveNext
        Loop
        Thedata = ""
        If InStr(TheForm, "Numeric1") Then
            If Forms!Sales!emailfax Then Thedata = "Total: "
            Thedata = Thedata & Format(TotalSale, "###,##0.00") & vbCrLf
        ElseIf InStr(TheForm, "Numeric2") Then
            If Forms!Sales!ShowAgreement Then
                For Counter = 1 To Len(TotalSale) * 2 + 1
                    Thedata = Thedata & Chr$(95)
                Next Counter
            End If
            If Forms!Sales!emailfax Then Thedata = ""
            Thedata = Thedata & CRLF
        ElseIf InStr(TheForm, "AlphaText") Then
            Thedata = vbCrLf
        ElseIf InStr(TheForm, "AlphaDescription") Then
            Thedata = vbCrLf
        Else
            Thedata = vbCrLf & "Agreement total" & " " & Format(TotalSale, "###,##0.00") & vbCrLf & vbCrLf
        End If
        If TheForm = "Sales" Or Forms!Sales!ShowAgreement Or Forms!Sales!ShowAgreementSummary Then
            Alt = Alt & Thedata
            If TheForm <> "Sales" Then
                If Forms!Sales!ShowAgreementSummary Then SummaryBefore = True
                If Forms!Sales!ShowAgreement Then DetailBefore = True
            End If
        End If
'additional work
        StatusBarMessage "Getting additional work"
        If totalAdditional = 0 Then GoTo Terms
        AdditionalTerms = "Sale "
        totalAdditional = 0
        myset.MoveFirst
        Thedata = ""
        If InStr(TheForm, "Numeric") Then
        ElseIf InStr(TheForm, "AlphaText") Then
            Thedata = Thedata & "Additional work:"
        ElseIf InStr(TheForm, "AlphaDescription") Then
        Else
            Thedata = Thedata & "Additional work:"
        End If
        If TheForm = "Sales" Or Forms!Sales!ShowAdditional Or Forms!Sales!ShowAdditionalSummary Then
            If SummaryBefore Then
                Alt = Alt & vbCrLf
                SummaryBefore = False
            ElseIf DetailBefore Then
                If TheForm <> "Sales" And Forms!Sales!ShowAdditionalSummary Then Alt = Alt & vbCrLf
            End If
            DetailBefore = False
            Alt = Alt & Thedata
            If TheForm = "Sales" Or Forms!Sales!ShowAdditional Then Alt = Alt & vbCrLf
        End If
        Do Until myset.EOF
            If Not Forms!Sales!Family Then thechild = "" Else thechild = myset!ID & " "
            TheCrLF = False
            If NNEN(myset!PrivateNote) <> "" Then
                TheDescription = myset!PrivateNote
                If Len(TheDescription) > 50 Then
                    TheCrLF = True
                End If
            Else
                TheDescription = myset!Category
            End If
            If myset!Journal = "Sale" And InStr(myset!Category, "Additional") <> 0 Then
                If InStr(TheForm, "Numeric1") Then
                    Thedata = Format(NNEZ(myset!SaleAmount), "###,##0.00")
                ElseIf InStr(TheForm, "Numeric2") Then
                    Thedata = ""
                ElseIf InStr(TheForm, "AlphaText") Then
                    Thedata = ""
                ElseIf InStr(TheForm, "AlphaDescription") Then
                    Thedata = "" & TheDescription
                Else
                    Thedata = myset!Category & " " & " " & Format(NNEZ(myset!SaleAmount), "###,##0.00")
                    TheCrLF = False
                End If
                If TheForm = "Sales" Or Forms!Sales!ShowAdditional Then
                    Alt = Alt & thechild & Thedata & vbCrLf
                    If TheCrLF And InStr(TheForm, "AlphaDescription") = 0 Then
                        Alt = Alt & vbCrLf
                    End If
                    If Len(TheDescription) > 35 Then
                        TheLongNote = True
                    End If
                End If
                totalAdditional = totalAdditional + NNEZ(myset!SaleAmount)
                If InStr(TheForm, "SalesClose") <> 0 Then
                    If Not Forms!Sales!JobSubForm.Form!Proposal Then
                        If NNEN(myset!TheDate) = "" Then
                            GetAlternateDisplay = "a sale is not dated."
                            Exit Function
                        ElseIf Year(myset!TheDate) >= SQLResult("Select FY9 from [MIS Accounts] where Number = 101") Then
                            GetAlternateDisplay = "a sale dated " & myset!TheDate & " is in current period"
                            Exit Function
                        End If
                    ElseIf Forms!Sales!JobSubForm.Form!Proposal Then
                        If NNEN(myset!TheDate) <> "" Then
                            GetAlternateDisplay = "a sale is dated."
                            Exit Function
                        End If
                    End If
                ElseIf InStr(TheForm, "SalesProposal") <> 0 Then
                    If NNEN(myset!TheDate) <> "" Then
                        GetAlternateDisplay = "a sale is dated " & myset!TheDate
                        Exit Function
                    End If
                End If
            End If
            myset.MoveNext
        Loop
        Thedata = ""
        If InStr(TheForm, "Numeric1") Then
            If Forms!Sales!emailfax Then Thedata = "Total: "
            Thedata = Thedata & Format(totalAdditional, "###,##0.00") & vbCrLf
        ElseIf InStr(TheForm, "Numeric2") Then
            If Forms!Sales!ShowAdditional Then
                For Counter = 1 To Len(totalAdditional) * 2 + 1
                    Thedata = Thedata & Chr$(95)
                Next Counter
            End If
            If Forms!Sales!emailfax Then Thedata = ""
            Thedata = Thedata & CRLF
        ElseIf InStr(TheForm, "AlphaText") Then
            Thedata = vbCrLf
        ElseIf InStr(TheForm, "AlphaDescription") Then
            Thedata = vbCrLf
        Else
            Thedata = vbCrLf & "Additional total" & " " & Format(totalAdditional, "###,##0.00") & vbCrLf
        End If
        If TheForm = "Sales" Or Forms!Sales!ShowAdditional Or Forms!Sales!ShowAdditionalSummary Then
            Alt = Alt & Thedata
            If TheForm <> "Sales" Then
                If Forms!Sales!ShowAdditionalSummary Then SummaryBefore = True
                If Forms!Sales!ShowAdditional Then DetailBefore = True
            End If
        End If
project:
        Thedata = ""
        If InStr(TheForm, "Numeric") Then
        ElseIf InStr(TheForm, "AlphaText") Then
        ElseIf InStr(TheForm, "AlphaDescription") Then
        Else
            Thedata = ""
        End If
        Alt = Alt & Thedata & vbCrLf
        Thedata = ""
        If InStr(TheForm, "Numeric1") Then
            Thedata = "Project total:  " & Format(TotalSale + totalAdditional, "###,##0.00") & vbCrLf
        ElseIf InStr(TheForm, "Numeric2") Then
            Thedata = vbCrLf
        ElseIf InStr(TheForm, "AlphaText") Then
            Thedata = vbCrLf
        ElseIf InStr(TheForm, "AlphaDescription") Then
            Thedata = vbCrLf
        Else
            Thedata = "Project total" & " " & Format(TotalSale + totalAdditional, "###,##0.00") & vbCrLf & vbCrLf
        End If
        If TheForm <> "Sales" Then
            If Not Forms!Sales!ShowAdditional And Not Forms!Sales!ShowAdditionalSummary And Not Forms!Sales!ShowAgreement And Not Forms!Sales!ShowAgreementSummary Then
            Else
                SummaryBefore = False
                DetailBefore = True
                Alt = Alt & Thedata
            End If
        End If
Terms:
        StatusBarMessage "Getting Terms"
        myset.MoveFirst
        Thedata = ""
        If InStr(TheForm, "Numeric") Then
        ElseIf InStr(TheForm, "AlphaDescription") Then
        ElseIf InStr(TheForm, "AlphaText") Then
            Thedata = AdditionalTerms & "Terms:"
        Else
            Thedata = AdditionalTerms & "Terms:"
        End If
        If TheForm = "Sales" Or Forms!Sales!ShowTerms Then
            If SummaryBefore Then
                Alt = Alt & vbCrLf
                SummaryBefore = False
            End If
            DetailBefore = False
            Alt = Alt & Thedata
            If TheForm = "Sales" Or Forms!Sales!ShowTerms Then Alt = Alt & vbCrLf
        End If
        Do Until myset.EOF
           If Not Forms!Sales!Family Then thechild = "" Else thechild = myset!ID & " "
            TheCrLF = False
            If NNEN(myset!PrivateNote) <> "" Then
                TheDescription = myset!PrivateNote
                If Len(TheDescription) > 50 Then
                    TheCrLF = True
                End If
            Else
                TheDescription = myset!Description
            End If
            If InStr(myset!Description, "Additional") <> 0 Then
            ElseIf myset!Journal = "Invoice" And NNEZ(myset!InvoiceAmount) <> 0 And InStr(myset!Description, "Additional") = 0 Then
                If InStr(TheForm, "Numeric1") Then
                    Thedata = Format(myset!InvoiceAmount, "###,##0.00")
                ElseIf InStr(TheForm, "Numeric2") Then
                    Thedata = ""
                ElseIf InStr(TheForm, "AlphaText") Then
                    Thedata = ""
                ElseIf InStr(TheForm, "AlphaDescription") Then
                    Thedata = "" & TheDescription
                Else
                    Thedata = myset!Description & " " & " " & Format(myset!InvoiceAmount, "###,##0.00")
                    TheCrLF = False
                End If
                If TheForm = "Sales" Or Forms!Sales!ShowTerms Then
                    Alt = Alt & thechild & Thedata & vbCrLf
                    If TheCrLF And InStr(TheForm, "AlphaDescription") = 0 Then
                        Alt = Alt & vbCrLf
                    End If
                    If Len(TheDescription) > 35 Then
                        TheLongNote = True
                    End If
                End If
                InvoiceTotal = InvoiceTotal + NNEZ(myset!InvoiceAmount)
                If NNEN(myset!Due) <> "" And NNEZ(myset!InvoiceAmount) <> 0 Then InvoicesSent = True
            End If
            myset.MoveNext
        Loop
        If InStr(TheForm, "Numeric1") Then
            Thedata = vbCrLf
        ElseIf InStr(TheForm, "Numeric2") Then
            For Counter = 1 To Len(InvoiceTotal) * 2 + 1
                Thedata = Thedata & Chr$(95)
            Next Counter
            Thedata = vbCrLf
        ElseIf InStr(TheForm, "AlphaText") Then
            Thedata = vbCrLf
        ElseIf InStr(TheForm, "AlphaDescription") Then
            Thedata = vbCrLf
        Else
            Thedata = vbCrLf & "Terms total" & " " & Format(InvoiceTotal, "###,##0.00") & vbCrLf & vbCrLf
        End If
        If TheForm = "Sales" Or Forms!Sales!ShowTerms Then
            Alt = Alt & Thedata
        End If
        If TheForm = "Sales" Then Forms!Sales!AgreementInformation = Alt
AdditionalTerms:
        StatusBarMessage "Getting additional work terms"
        myset.MoveFirst
        Thedata = ""
        If InStr(TheForm, "Numeric") Then
        ElseIf InStr(TheForm, "AlphaDescription") Then
        ElseIf InStr(TheForm, "AlphaText") Then
            Thedata = "Additional work terms:"
        Else
            Thedata = "Additional work terms:"
        End If
        If TheForm = "Sales" Or Forms!Sales!ShowTerms Then
            Do Until myset.EOF
                If Not Forms!Sales!Family Then thechild = "" Else thechild = myset!ID & " "
                If InStr(myset!Description, "Additional") <> 0 Then
                    If SummaryBefore Then
                        Alt = Alt & vbCrLf
                        SummaryBefore = False
                    End If
                    DetailBefore = False
                    Alt = Alt & thechild & Thedata
                    If TheForm = "Sales" Or Forms!Sales!ShowTerms Then Alt = Alt & vbCrLf
                    Exit Do
                End If
                myset.MoveNext
                GoTo Invoices
            Loop
        End If
        myset.MoveFirst
        Do Until myset.EOF
           If Not Forms!Sales!Family Then thechild = "" Else thechild = myset!ID & " "
            TheCrLF = False
            If NNEN(myset!PrivateNote) <> "" Then
                TheDescription = myset!PrivateNote
                If Len(TheDescription) > 50 Then
                    TheCrLF = True
                End If
            Else
                TheDescription = myset!Description
            End If
            If InStr(myset!Description, "Additional") = 0 Then
            ElseIf myset!Journal = "Invoice" And NNEZ(myset!InvoiceAmount) <> 0 And InStr(myset!Description, "Additional") <> 0 Then
                If InStr(TheForm, "Numeric1") Then
                    Thedata = Format(myset!InvoiceAmount, "###,##0.00")
                ElseIf InStr(TheForm, "Numeric2") Then
                    Thedata = ""
                ElseIf InStr(TheForm, "AlphaText") Then
                    Thedata = ""
                ElseIf InStr(TheForm, "AlphaDescription") Then
                    Thedata = "" & TheDescription
                Else
                    Thedata = myset!Description & " " & " " & Format(myset!InvoiceAmount, "###,##0.00")
                    TheCrLF = False
                End If
                If TheForm = "Sales" Or Forms!Sales!ShowTerms Then
                    Alt = Alt & thechild & Thedata & vbCrLf
                    If TheCrLF And InStr(TheForm, "AlphaDescription") = 0 Then
                        Alt = Alt & vbCrLf
                    End If
                    If Len(TheDescription) > 35 Then
                        TheLongNote = True
                    End If
                End If
                InvoiceTotal = InvoiceTotal + NNEZ(myset!InvoiceAmount)
                If NNEN(myset!Due) <> "" And NNEZ(myset!InvoiceAmount) <> 0 Then InvoicesSent = True
            End If
            myset.MoveNext
        Loop
        If InStr(TheForm, "Numeric1") Then
            Thedata = vbCrLf
        ElseIf InStr(TheForm, "Numeric2") Then
            For Counter = 1 To Len(InvoiceTotal) * 2 + 1
                Thedata = Thedata & Chr$(95)
            Next Counter
            Thedata = vbCrLf
        ElseIf InStr(TheForm, "AlphaText") Then
            Thedata = vbCrLf
        ElseIf InStr(TheForm, "AlphaDescription") Then
            Thedata = vbCrLf
        Else
            Thedata = vbCrLf & "Terms total" & " " & Format(InvoiceTotal, "###,##0.00") & vbCrLf & vbCrLf
        End If
        If TheForm = "Sales" Or Forms!Sales!ShowTerms Then
            Alt = Alt & Thedata
        End If
        If TheForm = "Sales" Then Forms!Sales!AgreementInformation = Alt
Invoices:
        StatusBarMessage "Calculating Invoices"
        If InvoicesSent Then
            myset.MoveFirst
            If InStr(TheForm, "Numeric") Then
                Thedata = ""
            ElseIf InStr(TheForm, "AlphaText") Then
                Thedata = "Invoices sent:"
            ElseIf InStr(TheForm, "AlphaDescription") Then
                Thedata = ""
            Else
                Thedata = "Invoices sent:"
            End If
            If TheForm = "Sales" Or Forms!Sales!ShowInvoices Or Forms!Sales!ShowInvoicesSummary Then
                If SummaryBefore Then
                    payalt = payalt & vbCrLf
                    SummaryBefore = False
                ElseIf DetailBefore Then
                    If TheForm <> "Sales" And Forms!Sales!ShowInvoicesSummary Then payalt = payalt & vbCrLf
                End If
                DetailBefore = False
                payalt = payalt & Thedata
                If TheForm = "Sales" Or Forms!Sales!ShowInvoices Then payalt = payalt & vbCrLf
           End If
            Do Until myset.EOF
                If Not Forms!Sales!Family Then thechild = "" Else thechild = myset!ID & " "
                TheCrLF = False
                If NNEN(myset!PrivateNote) <> "" Then
                    TheDescription = myset!PrivateNote
                    If Len(TheDescription) > 50 Then
                        TheCrLF = True
                    End If
                Else
                    TheDescription = myset!Description
                End If
                If myset!Journal <> "Invoice" Then
                ElseIf NNEN(myset!Due) = "" Then
                ElseIf NNEZ(myset!InvoiceAmount) = 0 Then
                ElseIf InStr(myset!Description, "Proposal") <> 0 Then
                Else
                    If InStr(TheForm, "Numeric1") Then
                        Thedata = Format(myset!InvoiceAmount, "###,##0.00")
                    ElseIf InStr(TheForm, "Numeric2") Then
                        Thedata = ""
                    ElseIf InStr(TheForm, "AlphaText") Then
                        Thedata = Format(myset!Due, "m/d/yy")
                    ElseIf InStr(TheForm, "AlphaDescription") Then
                        Thedata = TheDescription
                    Else
                        Thedata = myset!Description & " " & " " & Format(myset!Due, "m/d/yy") & " " & Format(myset!InvoiceAmount, "###,##0.00")
                        TheCrLF = False
                    End If
                    If TheForm = "Sales" Or Forms!Sales!ShowInvoices Then
                        payalt = payalt & thechild & Thedata & vbCrLf
                        If TheCrLF And InStr(TheForm, "AlphaDescription") = 0 Then
                            payalt = payalt & vbCrLf
                        End If
                        If Len(TheDescription) > 35 Then
                            TheLongNote = True
                        End If
                    End If
                    TotalInvoices = Format(TotalInvoices + NNEZ(myset!InvoiceAmount), "#,#.00")
                    If InStr(TheForm, "SalesClose") <> 0 Then
                        If Year(myset!Due) >= SQLResult("Select FY9 from [MIS Accounts] where Number = 101") Then
                            GetAlternateDisplay = "an invoice dated " & myset!Due & " is in current period"
                            Exit Function
                        End If
                    End If
                    If InStr(TheForm, "SalesProposal") <> 0 Then
                        If NNEN(myset!Due) <> "" Then
                            GetAlternateDisplay = "an invoice is dated " & myset!Due
                            Exit Function
                        End If
                    End If
                End If
                myset.MoveNext
            Loop
            Thedata = ""
            If InStr(TheForm, "Numeric1") Then
                If Forms!Sales!emailfax Then Thedata = "Total: "
                Thedata = Thedata & Format(TotalInvoices, "###,##0.00") & vbCrLf
            ElseIf InStr(TheForm, "Numeric2") Then
                If Forms!Sales!ShowInvoices Then
                    For Counter = 1 To Len(TotalInvoices) * 2 + 1
                        Thedata = Thedata & Chr$(95)
                    Next Counter
                End If
                If Forms!Sales!emailfax Then Thedata = ""
                Thedata = Thedata & CRLF
            ElseIf InStr(TheForm, "AlphaText") Then
                Thedata = vbCrLf
            ElseIf InStr(TheForm, "AlphaDescription") Then
                Thedata = vbCrLf
            Else
                Thedata = vbCrLf & "Invoices total" & " " & Format(TotalInvoices, "###,##0.00") & vbCrLf & vbCrLf
            End If
            If TheForm = "Sales" Or Forms!Sales!ShowInvoices Or Forms!Sales!ShowInvoicesSummary Then
                payalt = payalt & Thedata
                If TheForm <> "Sales" Then
                    If Forms!Sales!ShowInvoicesSummary Then SummaryBefore = True
                    If Forms!Sales!ShowInvoices Then DetailBefore = True
                End If
            End If
        End If
'payments
        StatusBarMessage "Calculating Payments"
        If Not Forms!Sales!Family Then
            Set myset = mydb.OpenRecordset("SELECT * from [Receipts Journal] WHERE [Job] = " & Forms!Sales!JobName & " ORDER BY [CheckDate] ", dbOpenDynaset, dbSeeChanges)
        Else
            Set myset = mydb.OpenRecordset("SELECT [>Jobs].ID, [Receipts Journal].* FROM [>Jobs] LEFT JOIN [Receipts Journal] ON [>Jobs].[Key] = [Receipts Journal].[Job] WHERE IIf([>Jobs].[Parent] = " & Forms!Sales!JobName & ", True, False) ORDER BY [>Jobs].ID, [Receipts Journal].CheckDate", dbOpenDynaset, dbSeeChanges)
        End If
        totalPayments = 0
        If myset.RecordCount <> 0 Then
            myset.MoveFirst
            If InStr(TheForm, "Numeric") Then
                Thedata = ""
            ElseIf InStr(TheForm, "AlphaText") Then
                Thedata = "Payments received:"
            ElseIf InStr(TheForm, "AlphaDescription") Then
                Thedata = ""
            Else
                Thedata = "Payments:"
            End If
            If TheForm = "Sales" Or Forms!Sales!ShowPayments Or Forms!Sales!ShowPaymentSummary Then
                If SummaryBefore Then
                    payalt = payalt & vbCrLf
                    SummaryBefore = False
                ElseIf DetailBefore Then
                    If TheForm <> "Sales" And Forms!Sales!ShowPaymentSummary Then payalt = payalt & vbCrLf
                End If
                DetailBefore = False
                payalt = payalt & Thedata
                If TheForm = "Sales" Or Forms!Sales!ShowPayments Then payalt = payalt & vbCrLf
            End If
            Do Until myset.EOF
                If Not Forms!Sales!Family Then thechild = "" Else thechild = myset!ID & " "
                If InStr(TheForm, "Numeric1") Then
                    If NNEZ(myset!Amount) <> 0 Then
                        Thedata = "(" & Format(myset!Amount, "###,##0.00") & ")"
                    Else
                        Thedata = ""
                    End If
                ElseIf InStr(TheForm, "Numeric2") Then
                    Thedata = ""
                ElseIf InStr(TheForm, "AlphaText") Then
                    Thedata = Format(myset!CheckDate, "m/d/yy")
                ElseIf InStr(TheForm, "AlphaDescription") Then
                    Thedata = ""
                Else
                    If NNEZ(myset!Amount) <> 0 Then
                        Thedata = Format(myset!CheckDate, "m/d/yy") & " " & " " & "(" & Format(myset!Amount, "###,##0.00") & ")"
                    Else
                        Thedata = ""
                    End If
                End If
                If TheForm = "Sales" Or Forms!Sales!ShowPayments Then
                    If Thedata <> "" Then payalt = payalt & thechild & Thedata & vbCrLf
                End If
                totalPayments = totalPayments + NNEZ(myset!Amount)
                If InStr(TheForm, "SalesClose") <> 0 Then
                    If Year(myset!CheckDate) >= SQLResult("Select FY9 from [MIS Accounts] where Number = 101") Then
                        GetAlternateDisplay = "a receipt dated " & myset!CheckDate & " is in current period"
                        Exit Function
                    End If
                End If
                myset.MoveNext
            Loop
'payment loop

            Thedata = ""
            If InStr(TheForm, "Numeric1") Then
                If Forms!Sales!emailfax Then Thedata = "Total: "
                Thedata = Thedata & "(" & Format(totalPayments, "###,##0.00") & ")" & vbCrLf
            ElseIf InStr(TheForm, "Numeric2") Then
                If Forms!Sales!ShowPayments Then
                    For Counter = 1 To Len(totalPayments) * 2 + 1
                        Thedata = Thedata & Chr$(95)
                    Next Counter
                End If
                If Forms!Sales!emailfax Then Thedata = ""
                Thedata = Thedata & CRLF
            ElseIf InStr(TheForm, "AlphaText") Then
                Thedata = vbCrLf
            ElseIf InStr(TheForm, "AlphaDescription") Then
                Thedata = vbCrLf
            Else
                Thedata = vbCrLf & "Payments total" & " " & "(" & Format(totalPayments, "###,##0.00") & ")" & vbCrLf & vbCrLf
            End If
            If TheForm = "Sales" Or Forms!Sales!ShowPayments Or Forms!Sales!ShowPaymentSummary Then
                payalt = payalt & Thedata
                If TheForm <> "Sales" Then
                    If Forms!Sales!ShowPaymentSummary Then SummaryBefore = True
                    If Forms!Sales!ShowPayments Then DetailBefore = True
                End If
            End If
        End If
'refunds
        StatusBarMessage "Calculating Refunds"
        'Set MySet = mydb.OpenRecordset("SELECT * from [Cash Disbursements Journal] WHERE [DebitAmount] <> 0 And [SupplierID] = " & TheCustomer & " And [Job] = " & Forms!Sales!JobName & " ORDER BY [CheckDate] ")
        Set myset = mydb.OpenRecordset("SELECT * from [General Ledger] WHERE [AccountNumber] = 121 and [DebitAmount] <> 0 And [SourceTransaction] = 'Refund' And [Job] = " & Forms!Sales!JobName & " ORDER BY [TransactionDate] ", dbOpenDynaset, dbSeeChanges)
        totalrefunds = 0
        If myset.RecordCount <> 0 Then
            RefundsReceived = True
            myset.MoveFirst
            If InStr(TheForm, "Numeric") Then
                Thedata = ""
            ElseIf InStr(TheForm, "AlphaText") Then
                Thedata = "Refunds sent:"
            ElseIf InStr(TheForm, "AlphaDescription") Then
                Thedata = ""
            Else
                Thedata = "Refunds:"
            End If
            If SummaryBefore Then
                payalt = payalt & vbCrLf
            End If
            payalt = payalt & Thedata & vbCrLf
            Do Until myset.EOF
                If InStr(TheForm, "Numeric1") Then
                    Thedata = Format(myset!DebitAmount, "###,##0.00")
                ElseIf InStr(TheForm, "Numeric2") Then
                    Thedata = ""
                ElseIf InStr(TheForm, "AlphaText") Then
                    'TheData = "" & Format(MySet!CheckDate, "m/d/yy")
                    Thedata = "" & Format(myset!TransactionDate, "m/d/yy")
                ElseIf InStr(TheForm, "AlphaDescription") Then
                    Thedata = ""
                Else
                    'TheData = Format(MySet!CheckDate, "m/d/yy") & " " & " " & Format(MySet!DebitAmount, "###,##0.00")
                    Thedata = Format(myset!TransactionDate, "m/d/yy") & " " & " " & Format(myset!DebitAmount, "###,##0.00")
                End If
                payalt = payalt & Thedata & vbCrLf
                totalrefunds = totalrefunds + NNEZ(myset!DebitAmount)
                If InStr(TheForm, "SalesClose") <> 0 Then
                    If Year(myset!CheckDate) >= SQLResult("Select FY9 from [MIS Accounts] where Number = 101") Then
                        'GetAlternateDisplay = "a refund dated " & MySet!CheckDate & " is in current period"
                        GetAlternateDisplay = "a refund dated " & myset!TransactionDate & " is in current period"
                        Exit Function
                    End If
                End If
                myset.MoveNext
            Loop
'refund loop
            
            
            Thedata = ""
            If InStr(TheForm, "Numeric1") Then
                If Forms!Sales!emailfax Then Thedata = "Total: "
                Thedata = Thedata & Format(totalrefunds, "###,##0.00") & vbCrLf
            ElseIf InStr(TheForm, "Numeric2") Then
                For Counter = 1 To Len(totalrefunds) * 2 + 1
                    Thedata = Thedata & Chr$(95)
                Next Counter
                If Forms!Sales!emailfax Then Thedata = ""
                Thedata = Thedata & CRLF
            ElseIf InStr(TheForm, "AlphaText") Then
                Thedata = vbCrLf
            ElseIf InStr(TheForm, "AlphaDescription") Then
                Thedata = vbCrLf
            Else
                Thedata = vbCrLf & Format(totalrefunds, "###,##0.00") & " " & "Refunds total" & vbCrLf & vbCrLf
            End If
            payalt = payalt & Thedata
        End If
'account balance
        StatusBarMessage "Calculating Balance"
        If InvoicesSent Or RefundsReceived Then
            If InStr(TheForm, "BalanceDue") Then
                If InStr(LCase(Forms!Sales!PrintDescription), "contract") <> 0 Then
                    GetAlternateDisplay = ""
                    Exit Function
                ElseIf InStr(LCase(Forms!Sales!PrintDescription), "proposal") <> 0 Then
                    GetAlternateDisplay = ""
                    Exit Function
                ElseIf Forms!Sales!JobLabel.Caption = "Closed" Then
                    GetAlternateDisplay = "Paid in Full"
                    Exit Function
                ElseIf TotalInvoices - totalPayments + totalrefunds > 0 Then
                    GetAlternateDisplay = vbCrLf & "Balance due:  $" & Format(TotalInvoices - totalPayments + totalrefunds, "###,##0")
                    Exit Function
                Else
                    If InStr(LocalVariable("PageCaption"), "Proposal") = 0 Then GetAlternateDisplay = vbCrLf & "Balance due:  $" & Format(TotalInvoices - totalPayments + totalrefunds, "###,##0")
                    Exit Function
                End If
            ElseIf InStr(TheForm, "Numeric1") Then
                 Thedata = ""
            ElseIf InStr(TheForm, "Numeric2") Then
                 Thedata = ""
            ElseIf InStr(TheForm, "AlphaText") Then
                Thedata = ""
            ElseIf InStr(TheForm, "AlphaDescription") Then
                Thedata = ""
            Else
                Thedata = "Balance due:" & vbCrLf & Format(TotalInvoices - totalPayments + totalrefunds, "###,##0.00")
            End If
            payalt = payalt & Thedata
        Else
            If InStr(TheForm, "BalanceDue") Then
                GetAlternateDisplay = ""
                Exit Function
            End If
        End If
        If TheForm = "Sales" Then Forms!Sales!PaymentInformation = payalt
        If InStr(TheForm, "Numeric2") <> 0 Then
            If Reports![Sales Invoice Report].Report.PrintCount > 0 Then
            'If Screen.ActiveReport.PrintCount > 0 Then
            ElseIf Not TheLongNote Then
                Reports![Sales Invoice Report]!Numeric1.Left = (Reports![Sales Invoice Report]!Numeric1.Left - 2000)
                Reports![Sales Invoice Report]!Numeric2.Left = (Reports![Sales Invoice Report]!Numeric2.Left - 2000)
                Reports![Sales Invoice Report]!balancedue.Left = (Reports![Sales Invoice Report]!balancedue.Left - 2000)
            End If
        End If
    Else
        If InStr(TheForm, "SalesClose") <> 0 Then
            If Not JobsSet!Estimate Then
                If MessageOKCancel("No invoices or sales have been issued - reset this job to be an estimate and close?") Then
                    GetAlternateDisplay = "this job has no sales or invoices issued."
                Else
                    JobsSet.Edit
                    JobsSet!Estimate = True
                    JobsSet.Update
                End If
                EchoOn
                Exit Function
            End If
        End If
        If TheForm = "Sales" Then
            Forms!Sales!AgreementInformation = ""
            Forms!Sales!PaymentInformation = ""
        End If
        Exit Function
    End If
End If
If InStr(TheForm, "SalesClose") <> 0 Or InStr(TheForm, "SalesProposal") <> 0 Then
    If Hundredths(TotalInvoices - totalPayments + totalrefunds) <> 0 Then
        GetAlternateDisplay = "a balance is due of " & TotalInvoices - totalPayments + totalrefunds
    End If
    Exit Function
ElseIf InStr(TheForm, "SalesInvoice") <> 0 Then
    GetAlternateDisplay = Alt & payalt
    Exit Function
End If
If TheForm = "Sales" Then
    Alt = savealt
End If
GetAlternateDisplay = Alt
MyTableCount = 1
If TheForm = "ProductList" Or NNEN(TheForm) = "" Then
    ShopTalk = True
    Set myset = mydb.OpenRecordset("Select * from [>Product List] Where [ProductListKey] = " & Forms!productlistmaster!ProductListControl!ProductListName & " Order by [Alternate]", dbOpenDynaset, dbSeeChanges)
Else
    ShopTalk = False
    If NNEZ(Forms!Sales!JobName) = 0 Then Exit Function
    Set mytable = mydb.OpenRecordset("SELECT * from [>Product Lists] WHERE [Job] = " & NNEZ(Forms!Sales!JobName) & " ", dbOpenDynaset, dbSeeChanges)
    If mytable.RecordCount = 0 Then Exit Function
    mytable.MoveLast
    MyTableCount = mytable.RecordCount
    mytable.MoveFirst
    Set myset = mydb.OpenRecordset("SELECT * from [>Product List] WHERE [ProductListKey] = " & mytable!Key & " ORDER BY  [Alternate]", dbOpenDynaset, dbSeeChanges)
End If
DoCmd.Hourglass True
AlternatesLoop:
If InStr(TheForm, "Sales") <> 0 Then
ElseIf myset.RecordCount <> 0 Then
    myset.FindFirst "[Alternate] <>  '" & NNEN(TheAlternate) & "' "
    Do Until myset.NoMatch
      Alternate = NNEN(myset!Alternate)
      StatusBarMessage "Checking " & Alternate
      TheAlternate = Alternate
      TheList = myset!ProductListKey
      Set MaterialsSet = mydb.OpenRecordset("SELECT [>Material].Description,[>Materials].[Material], [>Materials].[Substitution] from [>Materials] INNER JOIN [>Material] ON [>Materials].Material = [>Material].Key Where [ProductListKey] = " & TheList & " and [Alternate] = '" & TheAlternate & "' Order by [>Material].Description", dbOpenDynaset, dbSeeChanges)
      Set DesignsSet = mydb.OpenRecordset("SELECT [DesignType], [DesignAlternate] from [>Designs] Where [ProductListKey] = " & TheList & " and [Alternate] = '" & TheAlternate & "'  Order by [DesignType] ", dbOpenDynaset, dbSeeChanges)
      Set MaterialSet = mydb.OpenRecordset("SELECT [Key], [Description],[Category] from [>Material] ", dbOpenDynaset, dbSeeChanges)
      Alt = Alt & vbCrLf & myset!ProductList & " " & TheAlternate & ":" & vbCrLf
      If DesignsSet.RecordCount <> 0 Then
            DesignsSet.MoveFirst
            Do Until DesignsSet.EOF
                  If ShopTalk Then
                    Alt = Alt & TheTab & DesignsSet!DesignType & ": " & ProductName(DesignsSet!DesignAlternate) & "." & vbCrLf
                 Else
                    TheDesign = SQLResult("Select SpecificationReportText from [>Products] Where Key = " & DesignsSet!DesignAlternate)
                    If NNEN(TheDesign) <> "" Then
                        Alt = Alt & TheTab & TheDesign & "." & vbCrLf
                    End If
                End If
                DesignsSet.MoveNext
            Loop
      End If
        If MaterialsSet.RecordCount <> 0 Then
            MaterialsSet.MoveFirst
            Do Until MaterialsSet.EOF
                  If ShopTalk Then
                    MaterialSet.FindFirst " [Key] = " & NNEZ(MaterialsSet!Material) & " "
                    Alt = Alt & TheTab & MaterialSet!Description & ": "
                    MaterialSet.FindFirst " [Key] = " & NNEZ(MaterialsSet!Substitution) & " "
                    Alt = Alt & MaterialSet!Description & "." & vbCrLf
                 Else
                    TheMaterial = SQLResult("Select SpecReportText from [>Material] Where Key = " & MaterialsSet!Material)
                    TheSubstitute = SQLResult("Select SpecReportText from [>Material] Where Key = " & MaterialsSet!Substitution)
                    If NNEN(TheMaterial) <> "" And NNEN(TheSubstitute) <> "" Then
                         Alt = Alt & TheTab & TheMaterial & ": " & TheSubstitute & "." & vbCrLf
                   End If
                End If
                MaterialsSet.MoveNext
           Loop
        End If
    myset.FindNext "[Alternate] <>  '" & TheAlternate & "' "
    Loop
End If
If MyTableCount > 1 Then
    MyTableCount = MyTableCount - 1
    mytable.MoveNext
    Set myset = mydb.OpenRecordset("SELECT * from [>Product List] WHERE [ProductListKey] = " & mytable!Key & " ORDER BY  [Alternate]", dbOpenDynaset, dbSeeChanges)
    GoTo AlternatesLoop
End If
GetAlternateDisplay = Alt
DoCmd.Hourglass False
'EchoOn

Exit Function

GetAlternateDisplayError:
    MsgBox Err.Description
Resume ResumeGetAlternateDisplayError
ResumeGetAlternateDisplayError:

End Function

Public Sub ImportVisioDrawing(TheName)

'On Error GoTo 0
Dim TheItem As Single, myset As DAO.Recordset, mytable As DAO.Recordset, OptionSet As DAO.Recordset, ShapeSet As DAO.Recordset
EchoOn
Dim TheXOffset As Single, TheYOffset As Single
TheXOffset = 0
TheYOffset = 0
ErrorLogClear
Set myset = mydb.OpenRecordset("Select * From [>Product List] Where ProductListKey = " & Forms!productlistmaster!ProductListControl!ProductListName & " and Reference2 = '" & TheName & "' Order by Item")
If myset.RecordCount <> 0 Then
    myset.MoveLast
    If MessageOKCancel(myset.RecordCount & " items with " & TheName & " as Reference 2 will be deleted first. Continue?") Then
        Exit Sub
    End If
    Set OptionSet = mydb.OpenRecordset("Select * from [>Options]")
    myset.MoveFirst
    TheReference1 = myset!Reference1
    TheItem = myset!Item
    TheAlternate = myset!Alternate
    StatusBarMessage "Deleting..."
    Do Until myset.EOF
        OptionSet.FindFirst "ProductListKey = " & myset!Key
        Do Until OptionSet.NoMatch
            OptionSet.Delete
            OptionSet.FindNext "ProductListKey = " & myset!Key
        Loop
        myset.Delete
        myset.MoveNext
    Loop
Else
    TheReference1 = Forms!productlistmaster!ProductListControl!Reference1
    TheItem = Forms!productlistmaster!ProductListControl!Item
    TheAlternate = Forms!productlistmaster!ProductListControl!Alternate
End If
Set mytable = mydb.OpenRecordset("Select ID, Key, ProductType from [>Products]")
Set ShapeSet = mydb.OpenRecordset("Select * from [Shapes] Order by Run, PinX-Width/2")
If ShapeSet.RecordCount <> 0 Then
    ShapeSet.MoveFirst
    Do Until ShapeSet.EOF
        mytable.FindFirst "Key = " & NNEZ(ShapeSet!Product)
        If Not mytable.NoMatch Then
            If mytable!ProductType = "Product" Then
                StatusBarMessage "Importing " & mytable!ProductType & " " & mytable!ID
                TheItem = TheItem + 0.01
                myset.AddNew
                myset!ProductListKey = Forms!productlistmaster!ProductListControl!ProductListName
                myset!Item = TheItem
                myset!Reference1 = TheReference1
                myset!Alternate = TheAlternate
                myset!Product = ShapeSet!Product
                myset!X = Hundredths(ShapeSet!Width)
                myset!Y = Hundredths(ShapeSet!Depth)
                myset!Z = Hundredths(ShapeSet!Height)
                myset!DrawingXBegin = Hundredths(ShapeSet!PinX - ShapeSet!Width / 2 - TheXOffset)
                myset!DrawingYBegin = Hundredths(ShapeSet!Depth * -1)
                myset!DrawingZBegin = Hundredths(ShapeSet!PinY - ShapeSet!Height / 2 - TheYOffset)
                myset!AbsoluteYBegin = True
                myset!AbsoluteZBegin = True
                myset!Reference2 = NNEN(TheName)
                myset.Update
                myset.MoveLast
                If mytable!ID = "Drawing Wall" Then
                    TheXOffset = ShapeSet!PinX - ShapeSet!Width / 2
                    TheYOffset = ShapeSet!PinY - ShapeSet!Height / 2
                    WallKey = myset!Key
                    FoundAWall = True
                Else
                    If FoundAWall Then
                        myset.Edit
                        myset!Position = NNEZ(WallKey)
                        myset.Update
                    End If
                End If
            End If
        End If
        ShapeSet.MoveNext
    Loop
    ShapeSet.MoveFirst
    Set myset = mydb.OpenRecordset("Select * From [>Product List] Where ProductListKey = " & Forms!productlistmaster!ProductListControl!ProductListName & " and Reference2 = '" & TheName & "' Order by Item")
    Do Until ShapeSet.EOF
        mytable.FindFirst "Key = " & NNEZ(ShapeSet!Product)
        If Not mytable.NoMatch Then
            If mytable!ProductType = "Option" Then
                myset.FindFirst "Key <> " & NNEZ(WallKey) & " and Val(DrawingXBegin) < " & ShapeSet!PinX - TheXOffset & " and Val(DrawingXBegin) + Val(X) > " & ShapeSet!PinX - TheXOffset & " and Val(DrawingZBegin) < " & ShapeSet!PinY - TheYOffset & " and Val(DrawingZBegin) + Val(Z) > " & ShapeSet!PinY - TheYOffset
                StatusBarMessage "Importing " & mytable!ProductType & " " & mytable!ID
                If Not myset.NoMatch Then
                    OptionSet.AddNew
                    OptionSet!ProductListKey = myset!Key
                    OptionSet!ProductList = Forms!productlistmaster!ProductListControl!ProductListKey
                    OptionSet!Option = ShapeSet!Product
                    OptionSet!OptionRequirement = ShapeSet!OptionRequirement
                    OptionSet.Update
                Else
                    MsgBox "Product not found for Option " & mytable!ID
                End If
            End If
        End If
        ShapeSet.MoveNext
    Loop
End If
DoCmd.SelectObject acForm, "ProductListMaster"
Form_ProductList.RenumberItems
Forms!productlistmaster!ProductListControl.Requery
DoCmd.GoToControl "Reference2"
DoCmd.FindRecord TheName

End Sub

Public Function SetMenu()

On Error GoTo Error
If IsNull(LastForm) Then LastForm = "MainMenu" Else LastForm = ThisForm
ThisForm = Screen.ActiveForm.FormName
If Screen.ActiveForm.FormName = "ProductListMaster" Then
    Forms!productlistmaster!ProductListControl!PasteButton.Enabled = False
ElseIf Screen.ActiveForm.FormName = "MainMenu" Then
    If NNEN(LocalVariable("ScreenSize")) = "" Or LocalVariable("ScreenSize") = "Normal" Then
        SetLocalVariable "screensize", "Normal"
        MenuCheck 2, 3
        MenuUnCheck 2, 2
    Else
        MenuCheck 2, 2
        MenuUnCheck 2, 3
    End If
    If NNEN(LocalVariable("AppSize")) = "" Or LocalVariable("AppSize") = "Sizeable" Then
        DoCmd.RunCommand acCmdAppRestore
        SetLocalVariable "Appsize", "Sizeable"
        MenuCheck 2, 0
        MenuUnCheck 2, 1
    Else
        DoCmd.RunCommand acCmdAppMaximize
        MenuCheck 2, 1
        MenuUnCheck 2, 0
    End If
    If NNEZ(LocalVariable("AutoSync")) <> 0 Then
        MenuCheck 2, 5
    Else
        MenuUnCheck 2, 5
    End If
Else
    MenuGray 1, 5 'blurr Paste Record
End If

Exit Function

Error:
Resume resumeerror
resumeerror:

End Function

Public Function setSizes()

    EchoOff
    CloseAllForms
    'DoCmd.Close acForm, "MainMenu"
    'DoCmd.OpenForm "MainMenu"
    PositionWideForm
    EchoOn
    
End Function

Public Function setsync()

If NNEZ(LocalVariable("AutoSync")) = 0 Then
    SetLocalVariable "AutoSync", -1
    MenuCheck 2, 5
    Forms!Mainmenu.TimerInterval = 3600000

Else
    SetLocalVariable "AutoSync", 0
    MenuUnCheck 2, 5
    Forms!Mainmenu.TimerInterval = 0
End If
    
End Function

Function CancelFile()

On Error Resume Next
DoCmd.Close A_FORM, Screen.ActiveForm.FormName
'If Screen.ActiveForm.FormName = "ProductListMaster" Then RequeryPopups

End Function

Function FormatWholeNumber(TheValue)

FormatWholeNumber = Format(NNEZ(TheValue), "###,##0;-###,##0")

End Function

Public Function ProductName(TheProductName)

If NNEZ(TheProductName) <> 0 And NNEZ(TheProductName) = NNEZ(g_Product) Then
    ProductName = g_ProductName
    'ErrorLogEntry "Repeated " & g_ProductName
Else
    Dim productsSet As DAO.Recordset
    SetMyDB
    Set productsSet = mydb.OpenRecordset("SELECT [ID]  from [>Products] WHERE [Key] = " & NNEZ(TheProductName) & " ")
    If productsSet.RecordCount = 0 Then
        ProductName = ""
        g_Product = 0
        g_ProductName = ""
    Else
        ProductName = productsSet!ID
        'ErrorLogEntry ProductsSet!ID
        g_Product = TheProductName
        g_ProductName = productsSet!ID
    End If
End If

End Function

Public Function JobFormOpen()


On Error Resume Next
g_JobForm = Screen.ActiveForm.Name & " Job"
DoCmd.OpenForm "Job"
Forms!Job!JobName.Enabled = True


End Function

Public Function JobOpen()

On Error Resume Next
FoundJob = 0
Dim frm As Form, ctl As Control
If Screen.ActiveForm.Name = "ProductListMaster" Then
    Set frm = Forms!productlistmaster!ProductListControl.Form
Else
    Set frm = Screen.ActiveForm
End If
For Each ctl In frm.Controls
    If InStr(ControlType(ctl.ControlType), "list box") <> 0 Then
        'ErrorLogEntry "Found in Form" & ControlType(ctl.ControlType) & " " & ctl.Name
        If InStr(ctl.Name, "Job") <> 0 Then
            If NNEN(ctl.ControlSource) = "" Then UnBound = ctl.Value
            SetLocalVariable "FormJobs_JobName", ctl.Value
            FoundJob = FoundJob + 1
        End If
    End If
Next
If FoundJob = 0 Then
    MsgBox "A combo box that includes the name Job was not found to initialize the name of the Job on the Job Form"
ElseIf FoundJob > 1 Then
    If NNEN(UnBound) <> "" Then
        SetLocalVariable "FormJobs_JobName", UnBound
    End If
End If
DoCmd.OpenForm "Job"

End Function

Public Function FindOpen()

On Error GoTo FindError
Screen.PreviousControl.SetFocus
TheFormName = Left(Screen.ActiveForm.Name, 1)
DoCmd.RunCommand (acCmdFind)
SendKeys "%h" '& "a", True
SendKeys "a"
SendKeys "%l"
SendKeys "{Down}"
SendKeys "%n"
'DoCmd.DoMenuItem acFormBar, acEditMenu, 10, , acMenuVer70
'SendKeys "%ha", True
'SendKeys "%ra", True
'SendKeys "%e", True
'SendKeys "%n{Delete}", True
Exit Function

FindError:
MsgBox Err.Description
Resume ResumeFindError
ResumeFindError:

End Function

Public Function CalcControl(ThePlaces, TheLine)

If Left(TheLine, 1) = "=" Then
      CalcControl = CalcString(ThePlaces, Right(TheLine, Len(TheLine) - 1))
Else
      CalcControl = TheLine
End If

End Function

Public Function Help()

If LocalVariable("Form_MainMenu_Password") = "KRH" Then HelpUpdate
TheForm = Screen.ActiveForm.Caption
TheControl = NNEN(Screen.ActiveControl.ControlName)
TheStatusBarText = NNEN(Screen.ActiveControl.StatusBarText)
TheTag = NNEN(Screen.ActiveControl.Tag)
SetMyDB
Dim myset As DAO.Recordset, mytable As DAO.Recordset
EchoOff

On Error Resume Next
Set myset = mydb.OpenRecordset("Select * from [>Help] Where [Form] = '" & TheForm & "' Order by [Category], [Label] ")
DoCmd.OpenForm "Help"
Forms!Help!HelpForm = TheForm
Forms!Help!Message = TheStatusBar
If InStr(TheTag, "Help for all notes") <> 0 Then
    Forms!Help!HelpEdit.Visible = False
    Set mytable = Forms!productlistmaster!ProductListControl.Form.RecordsetClone
    If mytable.RecordCount <> 0 Then
        mytable.MoveFirst
        Do Until mytable.EOF
            Set myset = mydb.OpenRecordset("Select * from [>Note] Where [ProductListKey] = " & mytable!Key)
            If myset.RecordCount <> 0 Then
                myset.MoveFirst
                GuideText = GuideText & "Item " & mytable!Item & Chr$(13) & Chr$(10)
                Do Until myset.EOF
                    GuideText = GuideText & "Re: " & myset!ID & Chr$(13) & Chr$(10)
                    GuideText = GuideText & myset!Note & Chr$(13) & Chr$(10) & Chr$(13) & Chr$(10)
                    myset.MoveNext
                Loop
            End If
            mytable.MoveNext
        Loop
    End If
Else
    If myset.RecordCount <> 0 Then
        GuideText = ""
        If InStr(TheTag, "selected option") Then TheTag = Form_Options!OptionSelection
        If InStr(TheTag, "all options") Then TheTag = Form_Options!OptionsList
        myset.FindFirst "[Control] = '" & TheControl & "' "
        FirstRecord = True
        If myset.NoMatch Then
        Else
            TheCategory = NNEN(myset!Category)
            TheStatusBar = myset!Label
            Forms!Help!Message = myset!Label
            If TheTag <> "" Then GuideText = "Note: " & TheTag & Chr$(13) & Chr$(10)
            GoSub GetData
            FirstRecord = False
        End If
        myset.MoveFirst
        Do Until myset.EOF
            If myset!Control <> TheControl Then GoSub GetData
            myset.MoveNext
        Loop
    End If
End If
Forms!Help!HelpText = Left(GuideText, 64000)
EchoOn
Exit Function

GetData:
    'StatusBarMessage "Getting data for " & MySet!Label
    skipthis = True
    TheGuideText = ""
    If NNEN(myset!Category) <> "" Then TheGuideText = TheGuideText & myset!Category & ": "
    If NNEN(myset!Label) <> "" Then TheGuideText = TheGuideText & myset!Label
    If Not IsNull(myset!Purpose) Then skipthis = False: TheGuideText = TheGuideText & Chr$(13) & Chr$(10) & Chr$(13) & Chr$(10) & "Purpose: " & myset!Purpose
    If Not IsNull(myset!Description) Then skipthis = False: TheGuideText = TheGuideText & Chr$(13) & Chr$(10) & Chr$(13) & Chr$(10) & "Description: " & myset!Description
    If Not IsNull(myset!Examples) Then skipthis = False: TheGuideText = TheGuideText & Chr$(13) & Chr$(10) & Chr$(13) & Chr$(10) & "Example: " & myset!Examples
    If Not IsNull(myset!Limitations) Then skipthis = False: TheGuideText = TheGuideText & Chr$(13) & Chr$(10) & Chr$(13) & Chr$(10) & "Limitations: " & myset!Limitations
    If Not IsNull(myset!SeeAlso) Then skipthis = False: TheGuideText = TheGuideText & Chr$(13) & Chr$(10) & Chr$(13) & Chr$(10) & "See also: " & myset!SeeAlso
    If Not IsNull(myset!References) Then skipthis = False: TheGuideText = TheGuideText & Chr$(13) & Chr$(10) & Chr$(13) & Chr$(10) & "References: " & myset!References
    If skipthis And FirstRecord Then GuideText = GuideText & "No specific help for the currently selected " & myset!Category & "." & Chr$(13) & Chr$(10)
    If Not skipthis Then
        If GuideText <> "" Then
            GuideText = GuideText & Chr$(13) & Chr$(10)
            GuideText = GuideText & Chr$(13) & Chr$(10)
            GuideText = GuideText & "______________________________________________________________________"
            GuideText = GuideText & Chr$(13) & Chr$(10)
            GuideText = GuideText & Chr$(13) & Chr$(10)
        End If
        'If Len(TheGuideText) > 256 Then ErrorLogEntry TheGuideText
        GuideText = GuideText & TheGuideText
    End If
Return

End Function

Private Function ControlType(TheControl)

'If TheControl = 101 Then
    'ControlType = "Rectangle"
'ElseIf TheControl = 102 Then
    'ControlType = "Line"
'ElseIf TheControl = 103 Then
    'ControlType = "Image"
If TheControl = 104 Then
    ControlType = "Button"
ElseIf TheControl = 105 Then
    ControlType = "Option button"
ElseIf TheControl = 106 Then
    ControlType = "Check box"
'ElseIf TheControl = 107 Then
    'ControlType = "Option group"
ElseIf TheControl = 108 Then
    ControlType = "Bound object frame"
ElseIf TheControl = 109 Then
    ControlType = "Text box"
ElseIf TheControl = 110 Then
    ControlType = "List box"
ElseIf TheControl = 111 Then
    ControlType = "List box"
ElseIf TheControl = 112 Then
    ControlType = "Subform"
'ElseIf TheControl = 114 Then
    'ControlType = "Unbound object frame"
'ElseIf TheControl = 118 Then
    'ControlType = "Page break"
'ElseIf TheControl = 119 Then
    'ControlType = "Custom control"
ElseIf TheControl = 122 Then
    ControlType = "Toggle button"
Else
    ControlType = "?"
End If

End Function

Public Sub DetermineRevision()

If g_ThisForm = "KRH" Then
    g_CurrentRev = NNEZ(LocalVariable("Form_Synchronization_KRHRev"))
ElseIf g_ThisForm = "KRHEdit" Then
    g_CurrentRev = NNEZ(LocalVariable("Form_Synchronization_KRHEditRev"))
ElseIf g_ThisForm = "Journals" Then
    g_CurrentRev = NNEZ(LocalVariable("Form_Synchronization_JournalsRev"))
ElseIf g_ThisForm = "FinancialReports" Then
    g_CurrentRev = NNEZ(LocalVariable("Form_Synchronization_FinancialReportsRev"))
ElseIf g_ThisForm = "AccountingReports" Then
    g_CurrentRev = NNEZ(LocalVariable("Form_Synchronization_AccountingReportsRev"))
ElseIf g_ThisForm = "ProjectManagerReports" Then
    g_CurrentRev = NNEZ(LocalVariable("Form_Synchronization_ProjectManagerReportsRev"))
ElseIf g_ThisForm = "Schedule" Then
    g_CurrentRev = NNEZ(LocalVariable("Form_Synchronization_ScheduleRev"))
End If

End Sub

Public Function BillsApp()

If g_ThisForm = "KRH" Then
    BillsApp = True
ElseIf g_ThisForm = "KRHEdit" Then
    BillsApp = True
ElseIf g_ThisForm = "Journals" Then
    BillsApp = True
ElseIf g_ThisForm = "FinancialReports" Then
    CurrentRev = LocalVariable("Form_Synchronization_FinancialReportsRev")
ElseIf g_ThisForm = "AccountingReports" Then
    g_CurrentRev = LocalVariable("Form_Synchronization_AccountingReportsRev")
ElseIf g_ThisForm = "ProjectManagerReports" Then
    g_CurrentRev = LocalVariable("Form_Synchronization_ProjectManagerReportsRev")
ElseIf g_ThisForm = "Schedule" Then
    g_CurrentRev = LocalVariable("Form_Synchronization_ScheduleRev")
End If

End Function

Public Sub DetermineApplication()

Set mydb = CurrentDb()
g_AppName = mydb.Name
theDot = InStr(Application.CurrentProject.Name, ".")
g_TheAppName = Left(Application.CurrentProject.Name, theDot - 1)

For i = 0 To Forms.Count - 1
    If InStr(mydb.Name, "krh.mdb") <> 0 Then
        TheSteps = 4
        g_ThisForm = "KRH"
    ElseIf InStr(mydb.Name, "krhedit.mdb") Then
        TheSteps = 1
        g_ThisForm = "KRHEdit"
    ElseIf InStr(mydb.Name, "journal") Then
        TheSteps = 2
        g_ThisForm = "Journals"
    ElseIf InStr(mydb.Name, "accountingreports.mdb") Then
        TheSteps = 6
        g_ThisForm = "AccountingReports"
    ElseIf InStr(mydb.Name, "Management") Or InStr(mydb.Name, "Schedule") Then
        TheSteps = 7
        g_ThisForm = "ManagementReports"
    End If
Next i
'8 is Visio rev!!
g_ApplicationNumber = TheSteps

End Sub
Public Function ConditionName(TheName)

For i = 1 To Len(TheName)
    If Mid(TheName, i, 1) = ":" Then Mid(TheName, i, 1) = "_"
    If Mid(TheName, i, 1) = "/" Then Mid(TheName, i, 1) = "_"
    If Mid(TheName, i, 1) = "\" Then Mid(TheName, i, 1) = "_"
    If Mid(TheName, i, 1) = "&" Then Mid(TheName, i, 1) = "_"
    If Mid(TheName, i, 1) = "," Then Mid(TheName, i, 1) = "_"
    If Mid(TheName, i, 1) = "." Then Mid(TheName, i, 1) = "_"
    If Mid(TheName, i, 1) = "'" Then Mid(TheName, i, 1) = "_"
    If Mid(TheName, i, 1) = Chr$(34) Then Mid(TheName, 1, 1) = "_"
Next i
ConditionName = TheName

End Function

Public Function ConnectedToServer()

On Error GoTo Error
GetSettings
g_RemoteConnection = True
KRH_NetworkAddress = Variable("KRH_NetworkAddress")
If NNEN(KRH_NetworkAddress) = "" Then KRH_NetworkAddress = "192.168.115"
ErrorLogEntry "KRH network address " & KRH_NetworkAddress
TheIPAddress = GetIPAddress
If NNEZ(TheIPAddress) = 0 Then
    ErrorLogEntry "Local IP address not found"
End If
If InStr(TheIPAddress, KRH_NetworkAddress) <> 0 Then
    g_RemoteConnection = False
End If
ErrorLogEntry "Local IP address " & TheIPAddress
If Not g_RemoteConnection Or g_ConnectRemotely Then
    TheTime = Timer
    Dim dbs As Database
    Set dbs = CurrentDb()
    TheDatabase = "APCSet.mdb"
    NetworkPath = LocalVariable("Form_Synchronization_NetworkPath")
    StatusBarMessage "Connecting to Server"
    Set dbs = DBEngine(0).OpenDatabase(NetworkPath & TheDatabase)
    g_ServerConnection = Hundredths(Timer - TheTime)
    ConnectedToServer = g_ServerConnection
    ErrorLogEntry "Connected to server in " & g_ServerConnection & " seconds."
    If Not g_RemoteConnection Then ErrorLogEntry "Auto-sync enabled"
Else
    If Not g_RemoteConnection Then ErrorLogEntry "Auto-sync disabled"
End If
StatusBarMessage " "

Exit Function

Error:
    MsgBox Err.Description
    StatusBarMessage "Connection to server not established"
    'SetLocalVariable "Server_Online", ""
    g_ServerConnection = 0
    ConnectedToServer = 0
    ErrorLogEntry "Auto-sync disabled"
    EchoOn
Resume resumeerror
resumeerror:

End Function

Public Function ServerConnected() As Boolean

On Error GoTo Error
GetSettings
EchoOff
TheTime = Timer
Dim dbs As Database
Set dbs = CurrentDb()
TheDatabase = "APCSet.mdb"
NetworkPath = LocalVariable("Form_Synchronization_NetworkPath")
StatusBarMessage "Checking connection to " & NetworkPath
Set dbs = DBEngine(0).OpenDatabase(NetworkPath & TheDatabase)
ServerConnected = True
EchoOn

Exit Function

Error:
    MsgBox Err.Description
    StatusBarMessage "Connection to server not established"
    ServerConnected = False
    EchoOn
Resume resumeerror
resumeerror:

End Function



Public Sub MainMenuLoad()

GetSettings
DetermineApplication
On Error GoTo MainMenuLoadError
Dim mytable As TableDef, Charts As DAO.Recordset
If InStr(g_ThisForm, "Project") <> 0 Or InStr(g_ThisForm, "Journal") <> 0 Then
    FoundTable = False
    For i = 0 To mydb.TableDefs.Count - 1
        If mydb.TableDefs(i).Name = "Charts" Then FoundTable = True
    Next i
    If Not FoundTable Then
        Set mytable = mydb.CreateTableDef("Charts")
        With mytable
        .Fields.Append .CreateField("Counter", dbLong)
        .Fields.Append .CreateField("Value1", dbCurrency)
        .Fields.Append .CreateField("Value2", dbCurrency)
        .Fields.Append .CreateField("Date1", dbDate)
        .Fields.Append .CreateField("Date2", dbDate)
        .Fields.Append .CreateField("Text1", dbText)
        .Fields.Append .CreateField("Text2", dbText)
        End With
        mydb.TableDefs.Append mytable
    End If
End If
foundField = False
Dim myset As DAO.Recordset
Set myset = mydb.OpenRecordset("Select * from [>Part List]")
For i = 0 To myset.Fields.Count - 1
    If myset.Fields(i).Name = "PartProcessAlternate" Then foundField = True
Next i
If Not foundField Then
'MsgBox "APC.mdb requires updating"
End If

If g_ThisForm = "KRH" Then
    CreateLocalTables
    GetSettings
    'get Visio revision
    For i = 1 To 8
        Settings.MoveNext
    Next i
    Forms!Mainmenu!VisioCopyRight = Settings!CopyRight
    For i = 1 To 4
        Settings.MovePrevious
    Next i
End If
TheMessage = ""
StartLoading:
Dim dbs As Database
Set dbs = CurrentDb()
'For i = 0 To dbs.Properties.Count - 1
    'MsgBox dbs.Properties(i).Name
    'If InStr(dbs.Properties(i).Name, "StartupShowDBWindow") <> 0 Then
        'dbs.Properties(i) = False
    'ElseIf InStr(dbs.Properties(i).Name, "StartUptoolbars") <> 0 Then
        'dbs.Properties(i) = False
    'ElseIf InStr(dbs.Properties(i).Name, "Allow") <> 0 Then
        'dbs.Properties(i) = True
    'End If
'Next i
DBEngine.SetOption dbMaxLocksPerFile, 445000
Application.SetOption "Left Margin", 0.25
Application.SetOption "Right Margin", 0.25
Application.SetOption "Top Margin", 0.75
Application.SetOption "Bottom Margin", 0.25
Application.SetOption "Default Database Directory", "C:\Access"
Set myset = mydb.OpenRecordset(">CopyRight")
If myset.RecordCount <> 0 Then
    GetSettings
    LocalSettingsLastPath "Get"
    DetermineApplication
    DetermineRevision
    For i = 1 To g_ApplicationNumber
        Settings.MoveNext
    Next i
    Forms!Mainmenu!CopyRight = myset!CopyRight
    If DateDiff("d", Settings!CopyRight, myset!CopyRight) < 0 Then
        'ServerConnection = ConnectedToServer
        'If g_ServerConnection <> 0 Then
        If g_RemoteConnection Then
            If MessageOKCancel("There is an update to " & g_ThisForm & " available. Would you like to update now?") Then
                Exit Sub
            Else
                g_ConnectRemotely = True
                If ConnectedToServer = 0 Then
                    g_ConnectRemotely = False
                    MsgBox "A connection to the server could not be established"
                    Exit Sub
                End If
            End If
        End If
        If g_ServerConnection <> 0 Then
            TheMessage = "An error occurred while synchronizing " & g_ThisForm & " application. " & Err.Description
            EchoOn
            LocalDatabase = "C:\Access\"
            TheDatabase = g_ThisForm & ".mdb"
            NetworkPath = ServerPath & "\Access\Access 2000\"
            StatusBarMessage "Receiving changes into " & TheDatabase
            'ThisDatabase = g_ThisForm & ".mdb"
            'Set dbs = DBEngine(0).OpenDatabase(LocalDatabase & ThisDatabase)
            'dbs.Synchronize NetworkPath & TheDatabase, dbRepImportChanges
            'StatusBarMessage ""
            'EchoOn
            'SetVariable "User " & TheUsername & "_Synchronized_" & g_ThisForm, Str(Date)
            'ThisDatabase = g_APPName 'g_ThisForm & ".mdb"
            'Set dbs = DBEngine(0).OpenDatabase(LocalDatabase & ThisDatabase)
            Set dbs = DBEngine(0).OpenDatabase(g_AppName)
            dbs.Synchronize NetworkPath & TheDatabase, dbRepImportChanges
            StatusBarMessage ""
            EchoOn
            SetVariable "User " & TheUsername & "_Synchronized_" & g_TheAppName, Str(Date)
            If InStr(TheUsername, "Time") <> 0 And InStr(TheUsername, "Card") <> 0 Then
            Else
                'MsgBox "Synchronization was successful." & Chr$(13) & Chr$(13) & "Your application has been updated and will be re-opened"
            End If
            RestartApplication
        End If
    End If
    If g_CurrentRev = "" Then g_CurrentRev = Date - 100
    If DateDiff("d", myset!CopyRight, g_CurrentRev) <> 0 Then
        If NNEN(myset!Message) <> "" Then
            If InStr(TheUsername, "Time") <> 0 And InStr(TheUsername, "Card") <> 0 Then
            Else
                MsgBox myset!Message
            End If
            SetLocalVariable "Form_Synchronization_" & g_ThisForm & "Rev", Forms!Mainmenu!CopyRight
        End If
    End If
End If

Exit Sub

MainMenuLoadError:
EchoOn
If InStr(TheUsername, "Time") <> 0 And InStr(TheUsername, "Card") <> 0 Then
Else
    MsgBox TheMessage & "Itinialize error: " & Err.Description
End If
Resume ResumeMainMenuLoadError
ResumeMainMenuLoadError:
SetLocalVariable "Form_Synchronization_" & ThisForm, Date - 100
End Sub

Public Function RequeryControl()

Screen.ActiveControl.Requery

End Function

Public Function HelpUpdate()

ErrorLogClear
TheForm = Screen.ActiveForm.Caption
SetMyDB
Dim myset As DAO.Recordset, mytable As DAO.Recordset
EchoOn
Set myset = mydb.OpenRecordset("Select * from [>Help] Where [Form] = '" & TheForm & "' ")
Dim frm As Form, ctl As Control
If Screen.ActiveForm.Name = "ProductListMaster" Then
    Set frm = Forms!productlistmaster!ProductListControl.Form
Else
    Set frm = Screen.ActiveForm
End If
'delete/update old controls

For Each ctl In frm.Controls
    If ControlType(ctl.ControlType) = "?" Then
    ElseIf ctl.ControlName = "Key" Then
    Else
        StatusBarMessage "Checking control for additions " & ctl.ControlName
        myset.FindFirst "[Control] = '" & ctl.ControlName & "' "
        If myset.NoMatch Then
            If NNEN(ctl.StatusBarText) <> "" Then
                myset.AddNew
                ErrorLogEntry "Added Help control " & ctl.ControlName
                myset!Control = ctl.ControlName
                myset!Category = ControlType(ctl.ControlType)
                myset!Label = ctl.StatusBarText
                myset!Form = Screen.ActiveForm.Caption
                myset.Update
                myset.MoveLast
            End If
        Else
            If NNEN(ctl.StatusBarText) = "" Then
                ErrorLogEntry "Deleted Help control " & ctl.ControlName
                myset.Delete
            Else
                If ctl.StatusBarText <> NNEN(myset!Label) Then
                    ErrorLogEntry "Updated Status Bar Text for Help control " & ctl.ControlName
                    myset.Edit
                    myset!Label = ctl.StatusBarText
                    myset.Update
                End If
            End If
            If myset!Category <> ControlType(ctl.ControlType) Then
                ErrorLogEntry "Updated Control Type for Help control " & ctl.ControlName
                myset.Edit
                myset!Category = ControlType(ctl.ControlType)
                myset.Update
            End If
            'look for duplicates
            myset.FindNext "[Control] = '" & ctl.ControlName & "' "
            Do Until myset.NoMatch
                ErrorLogEntry "Deleted duplicate Help control " & ctl.ControlName
                myset.Edit
                myset!Form = Null
                myset.Update
                myset.FindNext "[Control] = '" & ctl.ControlName & "' "
            Loop
        End If
    End If
Next ctl

'look for deleted controls
myset.MoveFirst
Do Until myset.EOF
    StatusBarMessage "Checking control for deletion " & myset!Control
    FoundControl = False
    For Each ctl In frm.Controls
        If myset!Control = ctl.ControlName Then
            If ControlType(ctl.ControlType) <> "?" Then FoundControl = True
            Exit For
        End If
    Next ctl
    If Not FoundControl Then
        ErrorLogEntry "Deleted Help control " & myset!Control
        myset.Edit
        myset!Form = Null
        myset.Update
    End If
    myset.MoveNext
Loop
ErrorLogReport 1

End Function




Public Sub CloseAllForms()

Forms!Mainmenu.RecordSource = ""
Forms!Mainmenu.Requery
BeginClose:
For i = 0 To Forms.Count - 1
    If Forms(i).FormName = "MainMenu" Then
    ElseIf Forms(i).FormName = "Synchronization" Then
    ElseIf Forms(i).FormName = Screen.ActiveForm.FormName Then
    Else
        DoCmd.Close acForm, Forms(i).FormName
        GoTo BeginClose
    End If
Next i

End Sub

Public Sub HideAllForms()

For i = 0 To Forms.Count - 1
    If Forms(i).FormName = "MainMenu" Then
    ElseIf Forms(i).FormName = Screen.ActiveForm.FormName Then
        Forms(i).Visible = True
    Else
        Forms(i).Visible = False
    End If
Next i

End Sub

Public Sub RequeryForm()

On Error GoTo RequeryFormError
SaveRecord
If InStr(Screen.ActiveForm.Name, "ProductList") <> 0 Or InStr(Screen.ActiveForm.Name, "Option") <> 0 Or InStr(Screen.ActiveForm.Name, "Note") <> 0 Then
    ThisKey = Forms!productlistmaster!ProductListControl!Key
    Forms!productlistmaster!ProductListControl.Requery
    DoCmd.GoToControl "Key"
    DoCmd.FindRecord ThisKey
    DoCmd.GoToControl "Product"
Else
    Screen.PreviousControl.SetFocus
    ThisControl = Screen.ActiveControl.ControlName
    ThisKey = Screen.ActiveForm!Key
    DoCmd.Requery
    DoCmd.GoToControl "Key"
    DoCmd.FindRecord ThisKey
    DoCmd.GoToControl ThisControl
End If
Exit Sub

RequeryFormError:
Resume ResumeRequeryFormError
ResumeRequeryFormError:

End Sub

Public Sub SetVariable(TheName, TheVariable)

On Error GoTo SetVariableError
FindVariable:
GetSettings
Dim myset As DAO.Recordset
Set myset = mydb.OpenRecordset("Select * from [>Settings] where MenuText = '" & TheName & "'", dbOpenDynaset, dbSeeChanges)
If myset.RecordCount = 0 Then 'Settings.NoMatch Then
    Set myset = mydb.OpenRecordset("Select * from [>Settings] where isnull(MenuText)", dbOpenDynaset, dbSeeChanges)
    If myset.RecordCount <> 0 Then 'Settings.MoveFirst
        myset.Edit
        GoTo EditVariable
    Else
        myset.AddNew
        GoTo EditVariable
    End If
Else
    myset.Edit
EditVariable:
    myset!MenuText = TheName
    myset!MacroToRun = TheVariable
    If Left(TheName, 4) = "User" Then
        If NNEZ(myset!MenuCategory) < 32000 Then myset!MenuCategory = NNEZ(myset!MenuCategory) + 1
    End If
    myset.Update
End If
GetSettings
Exit Sub

SetVariableError:
Resume ResumeSetVariableError
ResumeSetVariableError:

End Sub


Public Function Variable(TheName)

Settings.FindFirst " [MenuText] = '" & TheName & "' "
If Settings.NoMatch Then
    g_Settings = False
    SetVariable TheName, ""
    Variable = ""
Else
    Variable = NNEN(Settings!MacroToRun)
End If
GetSettings

End Function


Public Function ApostropheCheck(TheString)

M = InStr(TheString, "'")
If M <> 0 Then
    ApostropheCheck = Left(TheString, M - 1) & Chr$(96) & Right(TheString, Len(TheString) - M)
Else
    ApostropheCheck = TheString
End If

End Function

Public Sub FilterForm(TheString)

On Error GoTo FilterFormError
If NNEN(TheString) = "" Then
    Screen.ActiveForm.FilterOn = False
Else
    Screen.ActiveForm.Filter = TheString
    Screen.ActiveForm.FilterOn = True
End If
Exit Sub

FilterFormError:
Resume ResumeFilterFormError
ResumeFilterFormError:

End Sub

Public Function Concatenate(String1, Operator, String2)

If NNEN(Operator) = "" Then Operator = "and"
If NNEN(String1) = "" Then
    Concatenate = String2
Else
    Concatenate = String1 & " " & Operator & " " & String2
End If

End Function

Public Function OpenLog()
GetPublicIP

DoCmd.OpenForm "Log"

End Function

Public Sub RestoreLocalVariables()

On Error GoTo RestoreLocalVariablesError:
Dim mytable As DAO.Recordset, frm As Form, ctl As Control, myset As DAO.Recordset
SetMyDB
If Screen.ActiveForm.Name = "ProductListMaster" Then
    Set frm = Forms!productlistmaster!ProductListControl.Form
Else
    Set frm = Screen.ActiveForm
End If
If Screen.ActiveForm.RecordSource <> "" Then
    Set mytable = Screen.ActiveForm.RecordsetClone
End If
GetSettings
For Each ctl In frm.Controls
    If InStr(ControlType(ctl.ControlType), "box") <> 0 Then
        'ErrorLogEntry "Found in Form" & ControlType(ctl.ControlType) & " " & ctl.Name
        TheName = "Form_" & Screen.ActiveForm.Name & "_" & ctl.Name
        LocalSettings.FindFirst " [LocalSettingText5] = '" & TheName & "' "
        If LocalSettings.NoMatch Then
            'ErrorLogEntry "Not found in Form " & TheName
        Else
            SkipField = False
            If Screen.ActiveForm.RecordSource <> "" Then
                TheCount = mytable.Fields.Count
                For i = 0 To TheCount - 1
                    If mytable(i).Name = ctl.Name Then SkipField = True
                Next i
            End If
            If NNEN(ctl.Name) <> "" And ctl.Name <> "key" And ctl.Name <> "ID" Then
                If InStr(ControlType(ctl.ControlType), "check box") <> 0 Then
                    If Not SkipField Then ctl = NNEZ(LocalSettings!LocalSettingText6)
                Else
                    'If Not MessageOKCancel(ctl.Name) Then
                        If Not SkipField Then ctl = LocalSettings!LocalSettingText6
                    'End If
                End If
            End If
        End If
    End If
nextcontrol:
Next
GetSettings
Exit Sub

RestoreLocalVariablesError:
Set myset = mydb.OpenRecordset("select LocalSettingText5 from [>Local Settings] where LocalSettingText5 = '" & LocalSettings!LocalSettingText5 & "'")
If myset.RecordCount <> 0 Then
    myset.Edit
    myset!LocalSettingText5 = Null
    myset.Update
End If
ErrorLogEntry "Failed to restore " & LocalSettings!LocalSettingText6 & " into " & ctl.Name

Resume ResumeRestoreLocalVariablesError
ResumeRestoreLocalVariablesError:
GoTo nextcontrol
End Sub

Public Sub SaveLocalVariables()

ErrorLogClear
On Error GoTo SaveLocalVariablesError
Dim mytable As DAO.Recordset, frm As Form, ctl As Control
SetMyDB
If Screen.ActiveForm.Name = "ProductListMaster" Then
    Set frm = Forms!productlistmaster!ProductListControl.Form
Else
    Set frm = Screen.ActiveForm
End If
GetSettings
DoCmd.Hourglass True
For Each ctl In frm.Controls
    If InStr(ControlType(ctl.ControlType), "box") <> 0 Then
        TheName = "Form_" & Screen.ActiveForm.FormName & "_" & ctl.Name
        LocalSettings.FindFirst " [LocalSettingText5] = '" & TheName & "' "
        If LocalSettings.NoMatch Then
        Else
            If NNEN(LocalSettings!LocalSettingText6) <> NNEN(ctl) Then
                LocalSettings.Edit
                LocalSettings!LocalSettingText6 = ctl
                LocalSettings.Update
            End If
        End If
    End If
Next
DoCmd.Hourglass False

Exit Sub

SaveLocalVariablesError:
ErrorLogEntry "Failed to save " & ctl.Name
Resume Next

End Sub



Public Function ConditionNumber(TheNumber)

If TheNumber = ".0" Then TheNumber = 0
If Val(NNEZ(TheNumber)) = 0 Then TheNumber = 0
M = InStr(TheNumber, ".")
If M <> 0 Then
    If Len(TheNumber) - M = 1 And Right(TheNumber, 2) = ".0" Then TheNumber = TheNumber \ 1
    If Len(TheNumber) - M = 2 And Right(TheNumber, 3) = ".00" Then TheNumber = TheNumber \ 1
    If Len(TheNumber) - M = 3 And Right(TheNumber, 4) = ".000" Then TheNumber = TheNumber \ 1
End If
ConditionNumber = TheNumber

End Function

Public Function HelpOpen()

On Error Resume Next
Screen.PreviousControl.SetFocus
Help

End Function

Public Function SetLocalVariableFunction(TheName, TheVariable)

SetLocalVariable TheName, TheVariable
SetLocalVariableFunction = True

End Function

Public Function SQLResult(SQLStatement As String)

'If InStr(SQLStatement, ">Settings") <> 0 Then MsgBox "": Exit Function
On Error GoTo SQLResultError
SetMyDB
Dim myset As DAO.Recordset
Dim qd As QueryDef
QueryName = "NewQuery"
Set qd = mydb.CreateQueryDef("New Query", SQLStatement)
Dim MySearch As DAO.Recordset
Set MySearch = qd.OpenRecordset(dbOpenSnapshot, dbSeeChanges)
If MySearch.RecordCount = 0 Then
Else
    MySearch.MoveFirst
    SQLResult = MySearch.Fields(0).Value
End If
mydb.Querydefs.Delete qd.Name

Exit Function

SQLResultError:
Resume ResumeSQLResultError
SQLResult = ""
ResumeSQLResultError:
End Function

Public Function SQLUpdate(FieldName, TableName, theKey, TheValue As String)

On Error GoTo Error
SetMyDB
Dim MySearch As DAO.Recordset
Set MySearch = mydb.OpenRecordset("Select '" & FieldName & "' from '" & TableName & "' where key = " & theKey)
If MySearch.RecordCount = 0 Then
Else
    For i = 0 To MySearch.Fields.Count
        If MySearch.Fields(i).Name = FieldName Then
            MySearch.Edit
            MySearch.Fields(i).Value = TheValue
            MySearch.Update
        End If
    Next i
End If
Exit Function

Error:
    'MsgBox Err.Description
Resume resumeerror
resumeerror:

End Function

Public Function GotoLastForm()

On Error GoTo AppError
AppName = "Apps"
If NNEN(LocalVariable(AppName)) = "open" Then
    myappID = "Apps"
Else
    Dim s
    Set fs = CreateObject("Scripting.FileSystemObject")
    Set F = fs.GetFile("C:\Apps\" & AppName & ".mdb")
    s = F.Size
    AppName = "C:\Apps\" & AppName & ".mdb"
    On Error Resume Next
    myappID = Shell("C:\Program Files\Microsoft Office\Office\MSAccess.exe " & AppName, 1)
    myappID = Shell("C:\Program Files (x86)\Microsoft Office\Office\MSAccess.exe " & AppName, 1)
    myappID = Shell("C:\Program Files\Microsoft Office\Office11\MSAccess.exe " & AppName, 1)
    myappID = Shell("C:\Program Files (x86)\Microsoft Office\Office11\MSAccess.exe " & AppName, 1)
End If
On Error Resume Next
AppActivate myappID
Exit Function

AppError:
    MsgBox Err.Description
Resume ResumeAppError
ResumeAppError:

End Function

Public Function GotoParts()

DoCmd.OpenForm "PartsList", acNormal

End Function

Public Function GotoCNC()

DoCmd.OpenForm "CNC", acNormal

End Function

Public Function GotoLists()

DoCmd.OpenForm "ProductListMaster", acNormal

End Function

Public Sub Pause(ThePause)

TheTime = Timer
Do Until TheTime < Timer - ThePause
Loop

End Sub

Public Function NullControl()

Screen.ActiveControl = Null
SaveRecord

End Function

Public Function DeleteControl()

Screen.ActiveControl = Null
Screen.ActiveControl.Requery
SaveRecord

End Function

Public Function FaxReport()


End Function

Public Function CustomerData(theKey)

On Error Resume Next
SetMyDB
Dim myset As DAO.Recordset
Set myset = mydb.OpenRecordset("Select * from [>Resources] where key = " & theKey, dbOpenDynaset, dbSeeChanges)
If myset.RecordCount <> 0 Then
    theaddress = myset!TheName & Chr$(13) & Chr$(10) & ResourceAddress(myset!CompanyName, myset!Address, myset!State, myset!Zip) & Chr$(13) & Chr$(10)
    If NNEN(myset!Field3) <> "" Then
        theaddress = theaddress & Chr$(13) & Chr$(10) & "Fax " & myset!Field3
    End If
    If NNEN(myset!AreaCode) <> "" Or NNEN(myset!Field2) <> "" Then
        theaddress = theaddress & Chr$(13) & Chr$(10) & myset!AreaCode & " " & myset!Field2
    End If
    CustomerData = theaddress
End If

End Function

Public Function ResourceNameAddress(theKey)

On Error Resume Next
SetMyDB
Dim myset As DAO.Recordset
Set myset = mydb.OpenRecordset("Select * from [>Resources] where key = " & theKey, dbOpenDynaset, dbSeeChanges)
If myset.RecordCount <> 0 Then
    If InStr(myset!Category, "Customer") <> 0 Then
        theaddress = ResourceID(myset!TheName) & Chr$(13) & Chr$(10) & ResourceAddress(myset!CompanyName, myset!Address, myset!State, myset!Zip) & Chr$(13) & Chr$(10)
    Else
        theaddress = ResourceAddress(myset!CompanyName, myset!Address, myset!State, myset!Zip) & Chr$(13) & Chr$(10)
    End If
    ResourceNameAddress = theaddress
End If

End Function

Public Function ResourceFirstNameAddress(theKey)

On Error Resume Next
SetMyDB
Dim myset As DAO.Recordset
Set myset = mydb.OpenRecordset("Select * from [>Resources] where key = " & theKey, dbOpenDynaset, dbSeeChanges)
If myset.RecordCount <> 0 Then
    If InStr(myset!Category, "Customer") <> 0 Then
        TheName = myset!TheName
        If InStr(TheName, Chr$(13)) <> 0 Then
            TheName = Left(TheName, InStr(TheName, Chr$(13)) - 1)
        End If
        theaddress = ResourceID(TheName) & Chr$(13) & Chr$(10) & ResourceAddress(myset!CompanyName, myset!Address, myset!State, myset!Zip) & Chr$(13) & Chr$(10)
    Else
        theaddress = ResourceAddress(myset!CompanyName, myset!Address, myset!State, myset!Zip) & Chr$(13) & Chr$(10)
    End If
    ResourceFirstNameAddress = theaddress
End If

End Function

Public Function ResourceFax(theKey)

On Error Resume Next
SetMyDB
Dim myset As DAO.Recordset
Set myset = mydb.OpenRecordset("Select * from [>Resources] where key = " & theKey, dbOpenDynaset, dbSeeChanges)
If myset.RecordCount <> 0 Then
    If NNEN(myset!Field3) <> "" Then
        theaddress = myset!Field3
    End If
    ResourceFax = theaddress
End If

End Function

Public Function Resourceemail(theKey)

On Error Resume Next
SetMyDB
Dim myset As DAO.Recordset
Set myset = mydb.OpenRecordset("Select * from [email] where Resourcekey = " & theKey)
If myset.RecordCount <> 0 Then
    If NNEN(myset!ContactName) <> "" Then
        theaddress = myset!Contactnamme & " "
    End If
    If NNEN(myset!eMail) <> "" Then
        theaddress = myset!eMail & " "
    End If
    If NNEN(myset!Position) <> "" Then
        theaddress = myset!Position
    End If
    Resourceemail = theaddress
End If

End Function

Public Function Resourceweb(theKey)

On Error Resume Next
SetMyDB
Dim myset As DAO.Recordset
Set myset = mydb.OpenRecordset("Select * from [>Resources] where key = " & theKey, dbOpenDynaset, dbSeeChanges)
If myset.RecordCount <> 0 Then
    If NNEN(myset!Web) <> "" Then
        theaddress = myset!Web
    End If
    Resourceweb = theaddress
End If

End Function

Public Function JobData(theKey)

On Error Resume Next
SetMyDB
Dim myset As DAO.Recordset, mytable As DAO.Recordset
Set myset = mydb.OpenRecordset("Select * from [>Jobs] where key = " & theKey)
If myset.RecordCount <> 0 Then
    If NNEN(myset!Remarks) <> "" Then theaddress = myset!Remarks
    If NNEZ(myset!ManagedBy) <> 0 Then
        If NNEN(theaddress) <> "" Then theaddress = theaddress & Chr$(13) & Chr$(10) & Chr$(13) & Chr$(10)
        theaddress = theaddress & "Project Manager: " & SQLResult("Select ADPName from [MIS Personnel] Where Key = " & myset!ManagedBy)
    End If
    If NNEZ(myset!SpecifiedBy) <> 0 Then
        If NNEN(theaddress) <> "" Then theaddress = theaddress & Chr$(13) & Chr$(10) & Chr$(13) & Chr$(10)
        theaddress = theaddress & "Specifier: " & SQLResult("Select ADPName from [MIS Personnel] Where Key = " & myset!SpecifiedBy)
    End If
    Set mytable = mydb.OpenRecordset("Select * from [>Resources] where key = " & NNEZ(myset!Architect), dbOpenDynaset, dbSeeChanges)
    If mytable.RecordCount <> 0 Then
        If NNEN(theaddress) <> "" Then theaddress = theaddress & Chr$(13) & Chr$(10) & Chr$(13) & Chr$(10)
        theaddress = theaddress & "Architect:" & Chr$(13) & Chr$(10) & mytable!ID & Chr$(13) & Chr$(10) & ResourceAddress(mytable!CompanyName, mytable!Address, mytable!State, mytable!Zip) & Chr$(13) & Chr$(10)
        If NNEN(mytable!Field3) <> "" Then
            theaddress = theaddress & Chr$(13) & Chr$(10) & "Fax " & mytable!Field3
        End If
        If NNEN(mytable!AreaCode) <> "" Or NNEN(mytable!Field2) <> "" Then
            theaddress = theaddress & Chr$(13) & Chr$(10) & mytable!AreaCode & " " & mytable!Field2
        End If
    End If
    Set mytable = mydb.OpenRecordset("Select * from [>Resources] where key = " & NNEZ(myset!Contractor), dbOpenDynaset, dbSeeChanges)
    If mytable.RecordCount <> 0 Then
        If NNEN(theaddress) <> "" Then theaddress = theaddress & Chr$(13) & Chr$(10) & Chr$(13) & Chr$(10)
        theaddress = theaddress & "Contractor:" & Chr$(13) & Chr$(10) & mytable!ID & Chr$(13) & Chr$(10) & ResourceAddress(mytable!CompanyName, mytable!Address, mytable!State, mytable!Zip) & Chr$(13) & Chr$(10)
        If NNEN(mytable!Field3) <> "" Then
            theaddress = theaddress & Chr$(13) & Chr$(10) & "Fax " & mytable!Field3
        End If
        If NNEN(mytable!AreaCode) <> "" Or NNEN(mytable!Field2) <> "" Then
            theaddress = theaddress & Chr$(13) & Chr$(10) & mytable!AreaCode & " " & mytable!Field2
        End If
    End If
    JobData = theaddress
End If

End Function

Public Function LineFeed()

LineFeed = Chr$(13) & Chr$(10)

End Function

Public Function SetScratchPad(TheString)

On Error Resume Next
SetScratchPad = True
SetLocalVariable "ScratchPad", TheString
SaveRecord

End Function

Public Function NNE1(TheNumber)

If IsNull(TheNumber) Or TheNumber = "" Or NNEZ(TheNumber = 0) Then NNE1 = 1 Else NNE1 = TheNumber

End Function

Public Function ResourceAddressPhoneFax(String1, String2, String3, String4, String5, String6, String7)

TheString1 = ResourceAddressPhone(String1, String2, String3, String4, String5, String6)
If NNEN(String7) <> "" Then TheString2 = Chr$(13) & Chr$(10) & "Fax: " & String7
ResourceAddressPhoneFax = TheString1 & TheString2

End Function

Public Function ResourcePhoneFax(String4, String5, String6)

TheString1 = ResourcePhone(String4, String5)
If NNEN(String6) <> "" Then TheString2 = Chr$(13) & Chr$(10) & "Fax: " & String6
ResourcePhoneFax = TheString1 & TheString2

End Function

Private Function Archived(Archive As Boolean)

If Archive Then
    MsgBox "This transaction cannot be changed because it is archived."
    If Password("Password") Then
    Else
        Archived = True
    End If
End If

End Function

Public Function ArchivedDate(TheDate, Archive As Boolean) As Boolean

ArchivedDate = False
If NNEZ(TheDate) = 0 Then
    'TheDate = Date
    'ArchivedDate = True
    'UndoRecord
ElseIf TheDate <> 0 Then
    GetSettings
    TheCloseYear = "1/1/" & Variable("PandL_Close_Year")
    If Year(TheDate) < SQLResult("Select FY9 from [MIS Accounts] where Number = 101") Then
        MsgBox "Transaction dates in or before " & Year(Settings!ArchiveDate) & " are archived."
        ArchivedDate = True
        UndoRecord
    ElseIf Year(TheDate) < Year(Date) Then
        If Month(TheDate) > 1 Then
            If MessageOKCancel("The date you entered is in a prior year that is not yet archived. Are you sure you want to proceed?") Then
                ArchivedDate = True
                UndoRecord
            Else
                If Month(Date) <> 1 Or Day(Date) > 15 Then
                    MsgBox "Transactions later than January 15 require a password"
                    If Not Password("Account") Then
                        ArchivedDate = True
                        UndoRecord
                    End If
                End If
            End If
        End If
        'monthly closing
    Else
        If InStr(Screen.ActiveForm.Name, "Balance") Then
        Else
            TheCloseDate = VariableCategory("PandL_Close_Date") & "/" & Variable("PandL_Close_Date")
            If Year(TheDate) > Year(TheCloseYear) Then
            ElseIf Month(TheDate) > Val(VariableCategory("PandL_Close_Date")) Then
            ElseIf Month(TheDate) < Val(VariableCategory("PandL_Close_Date")) Then
                 MsgBox "The date you entered is in a period that was closed on " & TheCloseDate
                ArchivedDate = True
                UndoRecord
            ElseIf Day(TheDate) <= Val(Variable("PandL_Close_Date")) Then
                MsgBox "The date you entered is in a period that was closed on " & TheCloseDate
                ArchivedDate = True
                UndoRecord
            End If
        End If
    End If
End If

End Function

Public Function VariableCategory(TheName)

GetSettings
Settings.FindFirst " [MenuText] = '" & TheName & "' "
If Settings.NoMatch Then
    SetVariable TheName, ""
    VariableCategory = ""
Else
    VariableCategory = NNEN(Settings!MenuCategory)
End If
GetSettings

End Function

Public Function NoQuotes(TheString) As String

TheID = ""
For i = 1 To Len(NNEN(TheString))
    If Asc(Mid(TheString, i, 1)) <> "34" Then TheID = TheID & Mid(TheString, i, 1)
Next i
NoQuotes = TheID

End Function

Public Function InQuotes(TheString) As String

On Error Resume Next
TheID = ""
LastChar = Len(TheString)
For i = 1 To LastChar
    If Asc(Mid(TheString, i, 1)) <> "34" Then
        TheID = TheID & Mid(TheString, i, 1)
    End If
Next i
InQuotes = Chr$(34) & TheID & Chr$(34)

End Function

Public Function ReportDimension(TheNumber As Double)

Dim DecimalPlaces As Integer
Dim TheFraction As Integer
Dim TheMeasurement As String
TheMeasurement = Forms!PartsList.Measurement
DecimalPlaces = 0
TheFraction = 0
If InStr(TheMeasurement, "1/2") Then TheFraction = 2
If InStr(TheMeasurement, "1/4") Then TheFraction = 4
If InStr(TheMeasurement, "1/8") Then TheFraction = 8
If InStr(TheMeasurement, "1/16") Then TheFraction = 16
If InStr(TheMeasurement, "1/32") Then TheFraction = 32
If InStr(TheMeasurement, "1/64") Then TheFraction = 64
If InStr(TheMeasurement, ".1") Then DecimalPlaces = 1
If InStr(TheMeasurement, ".01") Then DecimalPlaces = 2
If InStr(TheMeasurement, ".001") Then DecimalPlaces = 3
If InStr(TheMeasurement, "millimeter") <> 0 Or InStr(TheMeasurement, "mm") <> 0 Then
    ReportDimension = ConvertedNumber(TheNumber, TheMeasurement, DecimalPlaces, 0)
ElseIf InStr(TheMeasurement, "fraction") <> 0 Or InStr(TheMeasurement, "/") <> 0 Then
    ReportDimension = ConvertedNumber(TheNumber, TheMeasurement, 0, TheFraction)
Else
    ReportDimension = ConvertedNumber(TheNumber, TheMeasurement, DecimalPlaces, 0)
End If
'ReportDimension = Format(ReportDimension, "#,###.#;(0); ;""")

End Function

Public Sub QueryFilter(TheFilter, QueryName)

'MsgBox TheFilter & " " & QueryName
MsgBox mydb.Querydefs.Count
For i = 1 To mydb.Querydefs.Count
    If mydb.Querydefs(i).Name = QueryName Then
        'MsgBox MyDB.QueryDefs(I).Properties.Count
        For ii = 0 To mydb.Querydefs(i).Parameters.Count - 1
            MsgBox mydb.Querydefs(i).Parameters(ii).Name
        Next ii
    End If
Next i

End Sub
Public Function PLRef1()

'ThePLRef1 = PLRef1
If [Forms].[productlistmaster].[ProductListControl].[SelectReference1] Then
    PLRef1 = [Forms].[productlistmaster].[ProductListControl].[Reference1Select]
Else
    PLRef1 = "[Reference1]"
End If

End Function


Public Function ReplaceQuotation(StartString, TheString, TheText)

TheFirst = InStr(1, TheString, StartString)
If TheFirst = 0 Then
    ReplaceQuotation = TheString
Else
    TheFirst = InStr(TheFirst, TheString, Chr$(34))
    TheLast = InStr(TheFirst + 1, TheString, Chr$(34))
    If TheFirst = 0 Or TheLast = 0 Then
        ReplaceQuotation = TheString
    Else
        ReplaceQuotation = Left(TheString, TheFirst) & TheText & Right(TheString, Len(TheString) - TheLast + 1)
    End If
End If

End Function

Public Function IsNumeric(TheCharacter)

If Val(TheCharacter) < 43 Then
ElseIf Val(TheCharacter) > 57 Then
ElseIf Val(TheCharacter) = 47 Then
Else
    IsNumeric = True
End If

End Function

Public Function ReplaceValue(StartString, TheString, TheText)

TheFirst = InStr(1, TheString, StartString)
TheLast = 0
If TheFirst = 0 Then
    ReplaceValue = TheString
Else
    TheFirst = TheFirst + Len(StartString)
    For i = TheFirst To Len(TheString)
        If IsNumeric(Asc(Mid(TheString, i, 1))) Then
        Else
            TheLast = i
            Exit For
        End If
    Next
    If TheFirst = 0 Or TheLast = 0 Then
        ReplaceValue = TheString
    Else
        ReplaceValue = Left(TheString, TheFirst - 1) & TheText & Mid(TheString, TheLast, Len(TheString) - TheLast)
    End If
End If

End Function

Public Function ReplaceText(StartString, TheString, TheText)

MyString = TheString
TheFirst = InStr(1, MyString, StartString)
If TheFirst <> 0 Then
    MyString = Left(MyString, TheFirst - 1) & TheText & Mid(MyString, TheFirst + Len(StartString))
End If
ReplaceText = MyString

End Function

Public Function CRLF()

CRLF = Chr$(13) & Chr$(10)

End Function

Public Function GetQuotation(StartString, TheString)

TheFirst = InStr(1, TheString, StartString)
If TheFirst = 0 Then Exit Function
TheFirst = InStr(TheFirst, TheString, Chr$(34))
TheLast = InStr(TheFirst + 1, TheString, Chr$(34))
GetQuotation = Mid(TheString, TheFirst + 1, TheLast - TheFirst - 1)

End Function

Public Function SetTableData(TheFieldName As String, TheTableName As String, TheTableKey As Long, TheFieldData As Variant) As Boolean

'This routine will save data to a table
'1) Paste the following six lines of code into your application
'2) Delete the apostrophes
'3) Fill in the four variables
'Dim TheFieldName As String, TheTableName As String, TheTableKey As Long, TheTableData As Variant
'TheFieldNameVariable = YourField'example:Screen.ActiveControl.ControlName
'TheTableNameVariable = YourTable
'TheTableKeyVariable = YourKey'example:Key
'TheFieldDataVariable = YourData'example:Screen.ActiveControl
'SetTableData TheFieldNameVariable, TheTableNameVariable, TheTableKeyVariable, TheFieldDataVariable
On Error GoTo SetTableDataError
Dim myset As DAO.Recordset
SetMyDB
Set myset = mydb.OpenRecordset("SELECT * from [" & TheTableName & "] WHERE [Key] = " & TheTableKey)
If myset.RecordCount = 0 Then
    MsgBox "Record number " & TheTableKey & " not found."
Else
    For i = 0 To myset.Fields.Count - 1
        If InStr(myset(i).Name, "_") Then
        ElseIf myset(i).Name = "Key" Then
        ElseIf myset(i).Name = TheFieldName Then
            myset.Edit
            myset(i) = TheFieldData
            myset.Update
            foundField = True
            SetTableData = True
            Exit For
        End If
    Next i
    If Not foundField Then MsgBox "Field named " & TheFieldName & " not found in " & TheTableName & " table."
End If

Exit Function

SetTableDataError:
MsgBox Err.Description
Resume ResumeSetTableDataError
ResumeSetTableDataError:
    
End Function

Public Function DuplicateRecord(TheTableName As String, TheTableKey As Long) As Boolean

'This routine will duplicate a record
'1) Paste the following four lines of code into your application
'2) Delete the apostrophes
'3) Fill in the two variables
'Dim TheTableName As String, TheTableKey As Long
'TheTableNameVariable = YourTable
'TheTableKeyVariable = YourKey'example:Key
'DuplicateRecord TheTableNameVariable, TheTableKeyVariable
On Error GoTo DuplicateRecordError
Dim myset As DAO.Recordset, mytable As DAO.Recordset
SetMyDB
Set myset = mydb.OpenRecordset("SELECT * from [" & TheTableName & "] WHERE [Key] = " & TheTableKey)
If myset.RecordCount = 0 Then
    MsgBox "Record number " & TheTableKey & " not found."
Else
    Set mytable = mydb.OpenRecordset("SELECT * from [" & TheTableName & "] WHERE [Key] = " & TheTableKey)
    mytable.AddNew
    mytable.Edit
    For i = 0 To myset.Fields.Count - 1
        If InStr(myset(i).Name, "_") Then
        ElseIf myset(i).Name = "Key" Then
        Else
            mytable(i) = myset(i)
        End If
    Next i
    mytable.Update
End If

Exit Function

DuplicateRecordError:
MsgBox Err.Description
Resume ResumeDuplicateRecordError
ResumeDuplicateRecordError:
    
End Function

Public Function SynchronizeApplication()

On Error GoTo Error
If Not MessageOKCancel("Synchronize application with " & ServerPath & "?") Then
g_ConnectRemotely = True
    If ConnectedToServer = 0 Then
        MsgBox "Not connected to server"
        Exit Function
    End If
    SetLocalVariable "UpdateApp", g_TheAppName
    Pause 3
    theappname = "C:\Apps\UpdateApp.mdb"
    On Error Resume Next
    myappID = Shell("C:\Program Files\Microsoft Office\Office\MSAccess.exe " & theappname, 1)
    myappID = Shell("C:\Program Files (x86)\Microsoft Office\Office\MSAccess.exe " & theappname, 1)
    myappID = Shell("C:\Program Files\Microsoft Office\Office11\MSAccess.exe " & theappname, 1)
    myappID = Shell("C:\Program Files (x86)\Microsoft Office\Office11\MSAccess.exe " & theappname, 1)
    AppActivate myappID
    Quit
End If

Exit Function

Error:
    EchoOn
    MsgBox "An error occurred while synchronizing application. " & Err.Description
Resume resumeerror
resumeerror:

End Function

Public Function IsPartner(theKey)

If NNEN(SQLResult("Select [Text2] from [MIS Personnel] Where [Key] = " & theKey)) = "Partner" Then
    IsPartner = True
Else
    IsPartner = False
End If

End Function

Public Function UserIsPartner()

If NNEN(SQLResult("Select [Text2] from [MIS Personnel] Where [Text3] = '" & TheUsername & "'")) = "Partner" Then
    UserIsPartner = SQLResult("Select [Employee] from [MIS Personnel] Where [Text3] = '" & TheUsername & "'")
Else
    UserIsPartner = Forms!Sales!Partner
End If

End Function

Public Function UserKey()

'UserKey = SQLResult("Select [Key] from [MIS Personnel] Where [Text3] = 'Rich'")
UserKey = SQLResult("Select [Key] from [MIS Personnel] Where [Text3] = '" & TheUsername & "'")

End Function

Public Function UserIsManager()

If NNEN(SQLResult("Select [Text2] from [MIS Personnel] Where [Text3] = '" & TheUsername & "'")) = "Project Manager" Then
    UserIsManager = SQLResult("Select [Employee] from [MIS Personnel] Where [Text3] = '" & TheUsername & "'")
Else
    UserIsManager = Forms!Sales!Manager
End If

End Function

Public Function UserIsGeneralManager() As Boolean

If NNEN(SQLResult("Select [Text2] from [MIS Personnel] Where [Text3] = '" & TheUsername & "'")) = "General Manager" Then
    UserIsGeneralManager = True
Else
    UserIsGeneralManager = False
End If

End Function

Public Function UserIsOffice() As Boolean

If NNEN(SQLResult("Select [Text2] from [MIS Personnel] Where [Text3] = '" & TheUsername & "'")) = "Office" Then
    UserIsOffice = True
Else
    UserIsOffice = False
End If

End Function

Public Function UserCurrentlyManager()

UserCurrentlyManager = False
If NNEN(SQLResult("Select [Text2] from [MIS Personnel] Where [Text3] = '" & TheUsername & "'")) = "Project Manager" Then
    UserCurrentlyManager = True
End If

End Function

Public Function UserCurrentlyPartner()

UserCurrentlyPartner = False
If NNEN(SQLResult("Select [Text2] from [MIS Personnel] Where [Text3] = '" & TheUsername & "'")) = "Partner" Then
    UserCurrentlyPartner = True
'ElseIf TheUsername = "Bill" Then
    'UserCurrentlyPartner = True
End If

End Function

Public Function UserCurrentlyMarketing()

UserCurrentlyMarketing = False
If NNEN(SQLResult("Select [Text2] from [MIS Personnel] Where [Text3] = '" & TheUsername & "'")) = "Marketing" Then
    UserCurrentlyMarketing = True
End If

End Function

Public Function DayOfYear(TheDateString As Date)

For i = 1 To 12
    If i = Month(TheDateString) Then
        TheDays = TheDays + Day(TheDateString)
        Exit For
    End If
    If i = 1 Then
        TheDays = TheDays + 31
    ElseIf i = 2 Then
        TheDays = TheDays + 28
    ElseIf i = 3 Then
        TheDays = TheDays + 31
    ElseIf i = 4 Then
        TheDays = TheDays + 30
    ElseIf i = 5 Then
        TheDays = TheDays + 31
    ElseIf i = 6 Then
        TheDays = TheDays + 30
    ElseIf i = 7 Then
        TheDays = TheDays + 31
    ElseIf i = 8 Then
        TheDays = TheDays + 31
    ElseIf i = 9 Then
        TheDays = TheDays + 30
    ElseIf i = 10 Then
        TheDays = TheDays + 31
    ElseIf i = 11 Then
        TheDays = TheDays + 30
    End If
Next i
DayOfYear = TheDays
End Function

Public Function TheQuarter(TheDate)

If Month(TheDate) <= 3 Then
    TheQuarter = "3/31/" & Year(TheDate)
ElseIf Month(TheDate) <= 6 Then
    TheQuarter = "6/30/" & Year(TheDate)
ElseIf Month(TheDate) <= 9 Then
    TheQuarter = "9/30/" & Year(TheDate)
Else
    TheQuarter = "12/31/" & Year(TheDate)
End If

End Function

Public Function TheMonth(TheDate)
'TheMonth = TheQuarter(TheDate)
'Exit Function
If Month(TheDate) = 1 Then
    TheMonth = "1/31/" & Year(TheDate)
ElseIf Month(TheDate) = 2 Then
    TheMonth = "2/28/" & Year(TheDate)
ElseIf Month(TheDate) = 3 Then
    TheMonth = "3/31/" & Year(TheDate)
ElseIf Month(TheDate) = 4 Then
    TheMonth = "4/30/" & Year(TheDate)
ElseIf Month(TheDate) = 5 Then
    TheMonth = "5/31/" & Year(TheDate)
ElseIf Month(TheDate) = 6 Then
    TheMonth = "6/30/" & Year(TheDate)
ElseIf Month(TheDate) = 7 Then
    TheMonth = "7/31/" & Year(TheDate)
ElseIf Month(TheDate) = 8 Then
    TheMonth = "8/31/" & Year(TheDate)
ElseIf Month(TheDate) = 9 Then
    TheMonth = "9/30/" & Year(TheDate)
ElseIf Month(TheDate) = 10 Then
    TheMonth = "10/31/" & Year(TheDate)
ElseIf Month(TheDate) = 11 Then
    TheMonth = "11/30/" & Year(TheDate)
ElseIf Month(TheDate) = 12 Then
    TheMonth = "12/31/" & Year(TheDate)
End If

End Function

Public Sub CreateLocalTables()

'On Error GoTo 0
SetMyDB
Dim mytable As TableDef, ProjectSchedule As DAO.Recordset, workflow As DAO.Recordset


For i = 0 To mydb.TableDefs.Count - 1
    If mydb.TableDefs(i).Name = "VOJCGoal" Then FoundTable = True
Next i
If Not FoundTable Then
    Set mytable = mydb.CreateTableDef("VOJCGoal")
    With mytable
    .Fields.Append .CreateField("TheDay", dbLong)
    .Fields.Append .CreateField("VOJC", dbLong)
    .Fields.Append .CreateField("VOJCGoal", dbLong)
    .Fields.Append .CreateField("VOJCCurrent", dbLong)
    End With
    mydb.TableDefs.Append mytable
End If
FoundTable = False
For i = 0 To mydb.TableDefs.Count - 1
    If mydb.TableDefs(i).Name = "EstimateTrend" Then FoundTable = True
Next i
If Not FoundTable Then
    Set mytable = mydb.CreateTableDef("EstimateTrend")
    With mytable
    .Fields.Append .CreateField("TrendDate", dbDate)
    .Fields.Append .CreateField("Trend1Amount", dbCurrency)
    .Fields.Append .CreateField("Trend2Amount", dbCurrency)
    .Fields.Append .CreateField("Trend3Amount", dbCurrency)
    .Fields.Append .CreateField("Trend4Amount", dbCurrency)
    .Fields.Append .CreateField("Trend1Job", dbText)
    .Fields.Append .CreateField("Trend2Job", dbText)
    .Fields.Append .CreateField("Trend3Job", dbText)
    .Fields.Append .CreateField("Trend4Job", dbText)
    End With
    mydb.TableDefs.Append mytable
End If
FoundTable = False
For i = 0 To mydb.TableDefs.Count - 1
    If mydb.TableDefs(i).Name = "BillableDesign" Then FoundTable = True
Next i
If Not FoundTable Then
    Set mytable = mydb.CreateTableDef("BillableDesign")
    With mytable
    .Fields.Append .CreateField("Date", dbDate)
    .Fields.Append .CreateField("Hours", dbSingle)
    .Fields.Append .CreateField("Job", dbLong)
    .Fields.Append .CreateField("Employee", dbText)
    .Fields.Append .CreateField("Weekof", dbText)
    .Fields.Append .CreateField("Void", dbBoolean)
    End With
    mydb.TableDefs.Append mytable
End If
FoundTable = False
For i = 0 To mydb.TableDefs.Count - 1
    If mydb.TableDefs(i).Name = "Charts" Then FoundTable = True
Next i
If Not FoundTable Then
    Set mytable = mydb.CreateTableDef("Charts")
    With mytable
    .Fields.Append .CreateField("Counter", dbSingle)
    .Fields.Append .CreateField("Value1", dbCurrency)
    .Fields.Append .CreateField("Value2", dbCurrency)
    .Fields.Append .CreateField("Date1", dbDate)
    .Fields.Append .CreateField("Date2", dbDate)
    .Fields.Append .CreateField("Text1", dbText)
    .Fields.Append .CreateField("Text2", dbText)
    End With
    mydb.TableDefs.Append mytable
End If


End Sub

Public Sub RestartApplication()

SetLocalVariable "KRH_Restarting", True
SetLocalVariable "KRH_Closing", True
On Error Resume Next
myappID = Shell("C:\Program Files\Microsoft Office\Office\MSAccess.exe " & g_AppName, 1)
myappID = Shell("C:\Program Files (x86)\Microsoft Office\Office\MSAccess.exe " & g_AppName, 1)
myappID = Shell("C:\Program Files\Microsoft Office\Office11\MSAccess.exe " & g_AppName, 1)
myappID = Shell("C:\Program Files (x86)\Microsoft Office\Office11\MSAccess.exe " & g_AppName, 1)
AppActivate myappID
Quit

End Sub

Public Sub RestartApp()

'SetLocalVariable "KRH_Restarting", True
'SetLocalVariable "KRH_Closing", True
On Error Resume Next
myappID = Shell("C:\Program Files\Microsoft Office\Office\MSAccess.exe C:\Access\" & g_ThisForm & ".mdb", 1)
myappID = Shell("C:\Program Files (x86)\Microsoft Office\Office\MSAccess.exe C:\Access\" & g_ThisForm & ".mdb", 1)
myappID = Shell("C:\Program Files\Microsoft Office\Office11\MSAccess.exe C:\Access\" & g_ThisForm & ".mdb", 1)
myappID = Shell("C:\Program Files (x86)\Microsoft Office\Office11\MSAccess.exe C:\Access\" & g_ThisForm & ".mdb", 1)
AppActivate myappID
Quit

End Sub

Public Function VerifyVariable(ThePrompt, TheVariableName)

VerifyVariable = ""
TheVariableValue = Variable(TheVariableName)
If TheVariableValue = "" Then
    MsgBox "Variable " & TheVariableName & " not found."
    Exit Function
Else
    TheResponse = NNEN(InputBox(Chr$(13) & Chr$(13) & Chr$(13) & Chr$(13) & ThePrompt, "Variable", TheVariableValue))
    If TheResponse = "" Then
        Exit Function
    ElseIf TheResponse <> TheVariableValue Then
        If MessageOKCancel("Update variable " & TheVariableName & " from " & TheVariableValue & " to " & TheResponse & "?") Then
            Exit Function
        Else
            SetVariable TheVariableName, TheResponse
        End If
    Else
    End If
    VerifyVariable = TheResponse
End If

End Function

Public Function ScheduleRemotely()

g_ConnectRemotely = True
If ConnectedToServer <> 0 Then
    'Forms!Sales!ScheduleButton.Visible = True
    'Forms!Sales!ScheduleLabel.Visible = True
Else
    MsgBox "A connection to the server could not be established"
End If

End Function

Public Function ParsedDate(TheNote) As Date


M = 1
Do Until Mid(TheNote, M, 1) = " "
    TheDate = TheDate & Mid(TheNote, M, 1)
    M = M + 1
    If M = Len(TheNote) + 1 Then Exit Do
Loop
ParsedDate = Format(TheDate, "mm/dd/yy")

End Function

Public Function SelectList()

'Form_ProductList.ListSources
On Error GoTo selectlisterror
If NNEZ(LocalVariable("NoListChoice")) <> 0 Then
    MsgBox "To change Product List source you must restart KRH"
    Exit Function
End If
ListSource = LocalVariable("ScratchPad")
Set dbs = CurrentDb
Set db = CurrentDb
If InStr(ListSource, "Revit") <> 0 Then
'locate Revit tables
    foundRevit = 0
    countTables = 0
    Set mytable = db.OpenRecordset("Select * from [>AttachRevitLists] Order by [TableName]")
    mytable.MoveFirst
    Do Until mytable.EOF
        countTables = countTables + 1
        TableName = mytable!TableName
        Set tdfs = dbs.TableDefs
        For i = 0 To tdfs.Count - 1
            If tdfs(i).Name = TableName Then
                foundRevit = foundRevit + 1
            End If
        Next i
        mytable.MoveNext
    Loop
    If countTables <> foundRevit Then 'Revit tables not named as dbo_
        foundRevit = 0
        Set tdfs = dbs.TableDefs
        For i = 0 To tdfs.Count - 1
            If tdfs(i).Name = ">Revit Products" Then
                foundRevit = 1
            End If
        Next i
        If foundRevit = 0 Then
            MsgBox "All necessary Revit tables not found"
            Exit Function
        Else
            MsgBox "Revit tables already attached"
            Exit Function
        End If
    Else 'delete KRH tables
            'attempt to connect to server
        'ConnectToDatabase
        StatusBarMessage "Connecting to SQL Server"
        Dim wrkODBC As Workspace
        Dim conPubs As Connection
        Set wrkODBC = CreateWorkspace("NewODBCWorkspace", "admin", "", dbUseODBC)
        Set conPubs = wrkODBC.OpenConnection("lists", dbDriverNoPrompt, , "ODBC;DATABASE=lists;DSN=lists")

        DoEvents
        StatusBarMessage "Attaching Revit tables"
        
        'rename MIS tables
        Set mytable = dbs.OpenRecordset("Select * from [>AttachKRHLists] Order by [TableName]")
            mytable.MoveFirst
            Do Until mytable.EOF
                DatabaseName = mytable!Path
                TableName = mytable!TableName
                Set tdfs = dbs.TableDefs
                For i = 0 To tdfs.Count - 1
                    If tdfs(i).Name = DatabaseName Then
                        tdfs(i).Name = TableName
                    End If
                Next i
            mytable.MoveNext
        Loop

        'rename Revit tables
        Set mytable = dbs.OpenRecordset("Select * from [>AttachRevitLists] Order by [TableName]")
        mytable.MoveFirst
        Do Until mytable.EOF
            DatabaseName = mytable!Path
            TableName = mytable!TableName
            Set tdfs = dbs.TableDefs
            For i = 0 To tdfs.Count - 1
                If tdfs(i).Name = TableName Then
                    tdfs(i).Name = DatabaseName
                End If
            Next i
            mytable.MoveNext
        Loop
        SetLocalVariable "Revit_List", "Revit"
        SetLocalVariable "Revit_Restart", "Yes"
        Form_ProductList.ProductListName_AfterUpdate
        SetLocalVariable "Revit_Restart", "No"
        MenuCheck 9, 1
        MenuUnCheck 9, 0
    End If
End If

If InStr(ListSource, "KRH") <> 0 Then
'locate Revit tables
        foundRevit = 0
        Set tdfs = dbs.TableDefs
        For i = 0 To tdfs.Count - 1
            If tdfs(i).Name = ">Revit Products" Then
                foundRevit = 1
            End If
        Next i
        If foundRevit = 1 Then 'rename Revit tables
            Set mytable = dbs.OpenRecordset("Select * from [>AttachRevitLists] Order by [TableName]")
            mytable.MoveFirst
            Do Until mytable.EOF
                DatabaseName = mytable!Path
                TableName = mytable!TableName
                Set tdfs = dbs.TableDefs
                For i = 0 To tdfs.Count - 1
                    If tdfs(i).Name = DatabaseName Then
                        tdfs(i).Name = TableName
                    End If
                Next i
                mytable.MoveNext
            Loop
        
        'rename MIS tables
        Set mytable = dbs.OpenRecordset("Select * from [>AttachKRHLists] Order by [TableName]")
            mytable.MoveFirst
            Do Until mytable.EOF
                DatabaseName = mytable!Path
                TableName = mytable!TableName
                Set tdfs = dbs.TableDefs
                For i = 0 To tdfs.Count - 1
                    If tdfs(i).Name = TableName Then
                        tdfs(i).Name = DatabaseName
                    End If
                Next i
            mytable.MoveNext
        Loop
        
        Else
            MsgBox "KRH tables already attached"
            Exit Function
        End If
'reattach tables
    'Set mytable = dbs.OpenRecordset("Select * from [>AttachKRHLists] Order by [TableName]")
        'mytable.MoveFirst
        'Do Until mytable.EOF
            'DatabaseName = WorkingDirectory & mytable!Path
            'TableName = mytable!TableName
            'DoCmd.TransferDatabase acLink, "Microsoft Access", DatabaseName, acTable, TableName, TableName, False
        'mytable.MoveNext
    'Loop
        SetLocalVariable "Revit_List", ""
        SetLocalVariable "Revit_Restart", "Yes"
        Form_ProductList.ProductListName_AfterUpdate
        SetLocalVariable "Revit_Restart", "No"
        MenuCheck 9, 0
        MenuUnCheck 9, 1
End If

Exit Function

selectlisterror:
MsgBox "Error connecting to server: " & Err.Description
Resume resumeselectlisterror:
resumeselectlisterror:

End Function

Public Function RevitUpdateProducts()

ErrorLogClear
SaveRecord
On Error GoTo reviterror
If NNEN(LocalVariable("Revit_List")) <> "" Then
    If MessageOKCancel("Product List will be closed and set to KRH Lists. Continue?") Then Exit Function
End If
DoCmd.Close acForm, "ProductListMaster"
AutoAttach.AttachDatabase
ConnectToDatabase
Set dbs = CurrentDb
'If NNEN(LocalVariable("Revit_List")) <> "" Then
    'MsgBox "To update the Revit Products Database KRH Product Lists must be selected in Product List form during the update process."
    'Exit Function
'End If
Dim krhproducts As DAO.Recordset, revitproducts As DAO.Recordset
Set krhproducts = dbs.OpenRecordset("select* from[>Products] where ProductType = 'Product' or ProductType = 'Option' ", dbOpenDynaset)
Set revitproducts = dbs.OpenRecordset("select * from [dbo_RevitProducts];", dbOpenDynaset, dbSeeChanges)
krhproducts.MoveLast
TheCount = krhproducts.RecordCount
If revitproducts.RecordCount = 0 Then
    revitrecordcount = 0
Else
    revitproducts.MoveLast
    revitrecordcount = revitproducts.RecordCount
End If
If TheCount > revitrecordcount Then
    MsgBox "The Revit Products database needs to be at least " & TheCount & " records. Add " & TheCount - revitrecordcount & " records."
    Exit Function
End If
krhproducts.MoveFirst
revitproducts.MoveFirst
DoEvents
StatusBarMessage "Verifying Revit products "
Do Until krhproducts.EOF
    If NNEN(krhproducts!Description) = "" Then
    ElseIf Left(krhproducts!ProductType, 1) = "z" Then
    ElseIf krhproducts!UnlistedProduct Then
    Else
        'If NNEZ(revitproducts!KRHRecord) <> krhproducts!Key Then
        'ElseIf NNEZ(revitproducts!ProductDescription) <> krhproducts!Description Then
        'ElseIf NNEZ(revitproducts!ProductType) <> krhproducts!ProductType Then
        'ElseIf NNEZ(revitproducts!ProductCategory) <> krhproducts!Category Then
        'ElseIf NNEZ(revitproducts!RevitHelp) <> krhproducts!Note Then
        'ElseIf NNEZ(revitproducts!RevitCondition) <> krhproducts!Script Then
        'Else
            'GoTo nextrecord
        'End If
        StatusBarMessage "Updating Revit products " & krhproducts!Description
        revitproducts.Edit
        revitproducts!KRHRecord = krhproducts!Key
        revitproducts!ProductDescription = krhproducts!Description
        revitproducts!ProductType = krhproducts!ProductType
        revitproducts!ProductCategory = krhproducts!Category
        revitproductsrevitcondition = NNEN(krhproducts!Script)
        If Left(NNEN(krhproducts!DrawingNote), 1) = "[" And Right(NNEN(krhproducts!DrawingNote), 1) = "]" Then
            If NNEN(krhproducts!Script) = "" Then revitproductsrevitcondition = "[" & krhproducts!Description & "]"
            revitproductsrevitcondition = revitproductsrevitcondition & "[value=" & Right(krhproducts!DrawingNote, Len(krhproducts!DrawingNote) - 1)
        End If
        If Left(NNEN(krhproducts!Script), 3) = "Not" Then
            revitproductsrevitcondition = "[" & krhproducts!Description & "] And " & revitproductsrevitcondition
        End If
        
        For i = 1 To Len(revitproductsrevitcondition)
            If Mid(revitproductsrevitcondition, i, 1) = Chr$(10) Then Mid(revitproductsrevitcondition, i, 1) = Chr$(32)
            If Mid(revitproductsrevitcondition, i, 1) = Chr$(13) Then Mid(revitproductsrevitcondition, i, 1) = Chr$(32)
        Next i
checkSpace:
        foundspace = False
        For i = 1 To Len(revitproductsrevitcondition)
            If Mid(revitproductsrevitcondition, i, 1) = Chr$(32) And foundspace Then
                revitproductsrevitcondition = Left(revitproductsrevitcondition, i - 1) & Right(revitproductsrevitcondition, Len(revitproductsrevitcondition) - i)
                GoTo checkSpace 'Mid(revitproductsrevitcondition, i, 1) = Chr$(32)
            End If
            If Mid(revitproductsrevitcondition, i, 1) = Chr$(32) Then foundspace = True Else foundspace = False
        Next i
        If NNEN(revitproductsrevitcondition) <> "" Then
            If revitproductsrevitcondition <> NNEN(revitproducts!RevitCondition) Then
                ErrorLogEntry "Changed condition: " & krhproducts!ID & " " & revitproductsrevitcondition
            End If
        End If
        revitproducts!RevitCondition = revitproductsrevitcondition
        revitproducts!RevitHelp = NNEN(krhproducts!Note)
        revitproducts!ID = NNEN(krhproducts!ID)
        revitproducts.Update
        revitproducts.MoveNext
    End If
    krhproducts.MoveNext
nextrecord:
Loop
DoEvents
StatusBarMessage "Clearing unused Revit records "
revitproducts.MoveNext
Do Until revitproducts.EOF
    If revitproducts!KRHRecord <> 0 Then
        StatusBarMessage "Clearing Revit record " & revitproducts!Key
        revitproducts.Edit
        revitproducts!KRHRecord = 0
        revitproducts!ProductDescription = ""
        revitproducts!ProductType = ""
        revitproducts!ProductCategory = ""
        revitproducts!RevitCondition = ""
        revitproducts!RevitHelp = ""
        revitproducts!ID = ""
        revitproducts.Update
    End If
    revitproducts.MoveNext
Loop
'MsgBox "Updated successfully"
ErrorLogEntry "Updated Products Database"
OpenLog

Exit Function
        
reviterror:
    MsgBox "Error: " & Err.Description
    Resume resumereviterror
resumereviterror:

End Function

Public Function RevitViewProducts()

If NNEN(LocalVariable("Revit_List")) <> "" Then
    If MessageOKCancel("Product List will be closed and set to KRH Lists. Continue?") Then Exit Function
End If

DoCmd.Close acForm, "ProductListMaster"
AutoAttach.AttachDatabase
TheTableName = "dbo_RevitProducts"
DoCmd.OpenTable TheTableName, acViewNormal, acEdit

End Function



Public Function ConnectToDatabase()

Open "C:\Database\Revit\Revision.txt" For Input As #2
Input #2, theRevision
Close #2
If theRevision = "test" Then Exit Function

    Dim dbs As Database
    Set dbs = CurrentDb()
    TheDatabase = "Lists.mdb"
    NetworkPath = LocalVariable("Form_Synchronization_NetworkPath")
    StatusBarMessage "Checking connection to " & NetworkPath
    Set dbs = DBEngine(0).OpenDatabase(NetworkPath & TheDatabase)

End Function


Public Function RevitCheck()

If g_databaseChoice = "" Then
    SetLocalVariable "NoListChoice", 0
Else 'no choice of list
    If g_databaseChoice = "Revit" Then
        'SetLocalVariable "Revit_Restart", "Yes"
        SetLocalVariable "Revit_List", "Revit"
        MsgBox "Your application is setup for Revit Product Lists"
    Else
        MsgBox "Your application is setup for KRH Product Lists"
    End If
    SetLocalVariable "NoListChoice", 1
End If

End Function

Public Function SageID(TheID)

theSageID = ""
allowedChar = "1234567890aAbBcCdDeEfFgGhHiIjJkKlLmMnNoOpPqQrRsStTuUvVwWxXyYzZ"
For i = 1 To Len(TheID)
    For ii = 1 To Len(allowedChar)
        If Mid(TheID, i, 1) = Mid(allowedChar, ii, 1) Then
            theSageID = theSageID & UCase(Mid(TheID, i, 1))
            Exit For
        End If
    Next ii
Next i
SageID = NNEN(Left(theSageID, 10))

End Function


Public Function WebHelp(TheString As String)

On Error GoTo HelpError
SetVariable "User " & TheUsername & "_WebHelp_" & g_ThisForm, Str(Date)
If TheString = "All" Then
    Forms!Mainmenu!HelpButton.HyperlinkAddress = "http://www.471pageStreet.com/KRH/"
ElseIf TheString = "Sales" Then
    Forms!Sales!HelpButton.HyperlinkAddress = "http://www.471pageStreet.com/KRH/sales.html"
ElseIf TheString = "Resource" Then
    Forms!Resources!HelpButton.HyperlinkAddress = "http://www.471pageStreet.com/KRH/resources.html"
ElseIf TheString = "Parts" Then
    Forms!PartsList!HelpButton.HyperlinkAddress = "http://www.471pageStreet.com/KRH/parts.html"
ElseIf TheString = "CNC" Then
    Forms!CNC!HelpButton.HyperlinkAddress = "http://www.471pageStreet.com/KRH/cnc.html"
End If

Exit Function

HelpError:
MsgBox Err.Description
Resume ResumeHelpError
ResumeHelpError:

End Function

Public Function PreviousDay(TheDate As Date)

PreviousDay = TheDate - 1

End Function

Public Function GetPLName(theKey)

On Error Resume Next
SetMyDB
Dim mytable As DAO.Recordset
Set mytable = mydb.OpenRecordset("Select ProductList from [>Product Lists] where key=" & theKey, sbopensnapshot, dbSeeChanges)
GetPLName = mytable!ProductList

End Function

Public Sub SetLog(TheMessage)

On Error GoTo SetLogError
SetMyDB
Dim SQLLog As DAO.Recordset
Set SQLLog = mydb.OpenRecordset("Select * from [SQL Log] where Form='" & Screen.ActiveForm.Name & "' and Message= '" & TheMessage & "' and UserName= '" & TheUsername & "'", dbOpenDynaset, dbSeeChanges)
If SQLLog.RecordCount = 0 Then
    SQLLog.AddNew
Else
    SQLLog.Edit
End If
SQLLog!UserName = TheUsername
SQLLog!EntryDate = Now
SQLLog!Message = TheMessage
SQLLog!Frequency = NNEZ(SQLLog!Frequency) + 1
SQLLog!Form = Screen.ActiveForm.Name
SQLLog.Update

Exit Sub
SetLogError:
    MsgBox Err.Description
    Resume ResumeSetLogError
ResumeSetLogError:

End Sub