Option Compare Database
Option Explicit

Public Const ExpMissing As String = "1900-01-01", ExpOptional As String = "1900-01-02", ExpNA As String = "1900-01-03", ExpCompleted = "1900-01-04", ExpPending = "1900-01-05"

Public TILLDataBase As Database, TILLDBErrorMessage As Variant, ChangeCounter As Boolean, DisplayCommentInstructions As Boolean, SysCmdResult As Variant, NumCommentsRecorded As Integer, NumClientChangesMade As Integer, NumFamilyChangesMade As Integer
Public Criteria As Variant, SelectedDepartment As Variant, Wait As Integer
Public ExpMissingCalculated As Date, ExpOptionalCalculated As Date, ExpNACalculated As Date
Public rstSource As Recordset, rstDest As Recordset, ClientChangesMade As Boolean, FamilyChangesMade As Boolean, ExpirationsLoadError As Boolean

Public Trig_Staff_BBP_Red As Integer, Trig_Staff_BBP_Green As Integer, Trig_Staff_CPR_Red As Integer, Trig_Staff_CPR_Green As Integer
Public Trig_Staff_DL_Red  As Integer, Trig_Staff_DL_Green  As Integer, Trig_Staff_FA_Red  As Integer, Trig_Staff_FA_Green  As Integer
Public Trig_Staff_SC_Red  As Integer, Trig_Staff_SC_Green  As Integer, Trig_Staff_TB_Red  As Integer, Trig_Staff_TB_Green  As Integer
Public Trig_Staff_WV_Red  As Integer, Trig_Staff_WV_Green  As Integer, Trig_Staff_MAP_Red As Integer, Trig_Staff_MAP_Green As Integer
Public Trig_Staff_EVL_Red As Integer, Trig_Staff_EVL_Green As Integer, Trig_Staff_3MO_Red As Integer, Trig_Staff_3MO_Green As Integer
Public Trig_Staff_SUP_Red As Integer, Trig_Staff_SUP_Green As Integer, Trig_Staff_PL_Red  As Integer, Trig_Staff_PL_Green  As Integer
Public Trig_Staff_BIP_Red As Integer, Trig_Staff_BIP_Green As Integer

Public Trig_Res_LVC_Red   As Integer, Trig_Res_LVC_Green   As Integer, Trig_Res_MRFD_Red  As Integer, Trig_Res_MRFD_Green  As Integer
Public Trig_Res_HPR_Red   As Integer, Trig_Res_HPR_Green   As Integer, Trig_Res_HSPE_Red  As Integer, Trig_Res_HSPE_Green  As Integer
Public Trig_Res_MAP_Red   As Integer, Trig_Res_MAP_Green   As Integer, Trig_Res_HROTS_Red As Integer, Trig_Res_HROTS_Green As Integer
Public Trig_Res_HROTI_Red As Integer, Trig_Res_HROTI_Green As Integer, Trig_Res_FSOTS_Red As Integer, Trig_Res_FSOTS_Green As Integer
Public Trig_Res_FSOTI_Red As Integer, Trig_Res_FSOTI_Green As Integer

Public Trig_Day_LVC_Red   As Integer, Trig_Day_LVC_Green   As Integer, Trig_Day_STP_Red   As Integer, Trig_Day_STP_Green   As Integer
Public Trig_Day_APRS_Red  As Integer, Trig_Day_APRS_Green  As Integer, Trig_Day_QSR_Red   As Integer, Trig_Day_QSR_Green   As Integer
Public Trig_Day_HROTS_Red As Integer, Trig_Day_HROTS_Green As Integer, Trig_Day_HROTI_Red As Integer, Trig_Day_HROTI_Green As Integer
Public Trig_Day_FSOTS_Red As Integer, Trig_Day_FSOTS_Green As Integer, Trig_Day_FSOTI_Red As Integer, Trig_Day_FSOTI_Green As Integer

Public Trig_Indiv_ISP_Red  As Integer, Trig_Indiv_ISP_Green  As Integer, Trig_Indiv_PSDue_Green  As Integer, Trig_Indiv_CFS_Red    As Integer, Trig_Indiv_CFS_Green  As Integer
Public Trig_Indiv_BMMX_Red As Integer, Trig_Indiv_BMMX_Green As Integer, Trig_Indiv_BMMH_Red     As Integer, Trig_Indiv_BMMH_Green As Integer
Public Trig_Indiv_BMMS_Red As Integer, Trig_Indiv_BMMS_Green As Integer, Trig_Indiv_SPDX_Red     As Integer, Trig_Indiv_SPDX_Green As Integer
Public Trig_Indiv_SPDH_Red As Integer, Trig_Indiv_SPDH_Green As Integer, Trig_Indiv_SPDS_Red     As Integer, Trig_Indiv_SPDS_Green As Integer
Public Trig_Indiv_SPDA_Red As Integer, Trig_Indiv_SPDA_Green As Integer

Public Function IsTableQuery(TName As String) As Boolean
On Error Resume Next
    Dim Db As Database, Found As Boolean, Test As String
    Const NAME_NOT_IN_COLLECTION = 3265

    Found = False
    Set Db = CurrentDb()
    ' See if the name is in the Tables collection.
    Test = Db.TableDefs(TName).Name
    If Err <> NAME_NOT_IN_COLLECTION Then Found = True
    ' Reset the error variable.
    Err = 0
    ' See if the name is in the Queries collection.
    Test = Db.QueryDefs(TName$).Name
    If Err <> NAME_NOT_IN_COLLECTION Then Found = True
    Db.Close
    IsTableQuery = Found
End Function

Public Sub DropTempTables()
On Error GoTo ShowMeError
    If IsTableQuery("temptbl7") Then TILLDataBase.Execute "DROP TABLE temptbl7", dbSeeChanges
    If IsTableQuery("temptbl6") Then TILLDataBase.Execute "DROP TABLE temptbl6", dbSeeChanges
    If IsTableQuery("temptbl5") Then TILLDataBase.Execute "DROP TABLE temptbl5", dbSeeChanges
    If IsTableQuery("temptbl4") Then TILLDataBase.Execute "DROP TABLE temptbl4", dbSeeChanges
    If IsTableQuery("temptbl3") Then TILLDataBase.Execute "DROP TABLE temptbl3", dbSeeChanges
    If IsTableQuery("temptbl2") Then TILLDataBase.Execute "DROP TABLE temptbl2", dbSeeChanges
    If IsTableQuery("temptbl1") Then TILLDataBase.Execute "DROP TABLE temptbl1", dbSeeChanges
    If IsTableQuery("temptbl0") Then TILLDataBase.Execute "DROP TABLE temptbl0", dbSeeChanges
    If IsTableQuery("temptbl") Then TILLDataBase.Execute "DROP TABLE temptbl", dbSeeChanges
    Exit Sub
ShowMeError:
    Err.Source = "PublicSubroutines" & "(Line #" & Str(Err.Erl) & ")": TILLDBErrorMessage = "Error # " & Str(Err.Number) & " was generated by " & Err.Source & Chr(13) & Err.Description
    MsgBox TILLDBErrorMessage, vbOKOnly, "Error", Err.HelpFile, Err.HelpContext
End Sub

Public Function LengthN(N As Integer, DateField As Variant)
    If Len(DateField) < N Then LengthN = False Else LengthN = True
End Function

Public Function BriefDelay(Optional Secs As Integer = 1) As Boolean
On Error GoTo ShowMeError
    Dim Start As Variant
    
    BriefDelay = True
    Start = Timer
    Do While Timer < Start + Secs: DoEvents: Loop
    Exit Function
ShowMeError:
    Err.Source = "PublicSubroutines" & "(Line #" & Str(Err.Erl) & ")": TILLDBErrorMessage = "Error # " & Str(Err.Number) & " was generated by " & Err.Source & Chr(13) & Err.Description
    MsgBox TILLDBErrorMessage, vbOKOnly, "Error", Err.HelpFile, Err.HelpContext
End Function

Public Sub LoopUntilClosed(strName As String, ObjectType As Integer)
On Error GoTo ShowMeError
    Do While IsObjectOpen(strName, ObjectType): DoEvents: Loop
    Exit Sub
ShowMeError:
    Err.Source = "PublicSubroutines" & "(Line #" & Str(Err.Erl) & ")": TILLDBErrorMessage = "Error # " & Str(Err.Number) & " was generated by " & Err.Source & Chr(13) & Err.Description
    MsgBox TILLDBErrorMessage, vbOKOnly, "Error", Err.HelpFile, Err.HelpContext
End Sub

Public Function IsObjectOpen(strName As String, Optional intObjectType As Integer = acForm) As Boolean
' intObjectType can be: acTable (value 0), acQuery (value 1), acForm (value 2) Default, acReport (value 3), acMacro (value 4), acModule (value 5)
' Returns True if strName is open, False otherwise.
On Error Resume Next
    IsObjectOpen = (SysCmd(acSysCmdGetObjectState, intObjectType, strName) <> 0)
    If Err <> 0 Then IsObjectOpen = False
End Function

Public Sub SpecialNames(Name As String)
' Hyphenated.
    If InStr(1, Name, "-", vbTextCompare) > 0 Then Name = Left(Name, InStr(1, Name, "-", vbTextCompare)) & Mid(Name, InStr(1, Name, "-", vbTextCompare) + 1, 255)
' MacSomeone and McSomeone.
    If Left(Name, 2) = "Mc" Then Name = "Mc" & StrConv(Mid(Name, 3, 1), vbUpperCase) & Mid(Name, 4, 255)
    If Left(Name, 3) = "Mac" Then Name = "Mac" & StrConv(Mid(Name, 4, 1), vbUpperCase) & Mid(Name, 5, 255)
' O'Someone
    If Left(Name, 2) = "O'" Then Name = "O'" & StrConv(Mid(Name, 3, 1), vbUpperCase) & Mid(Name, 4, 255)
End Sub

Public Sub SetExpFieldProps(F As Label, Optional Criteria As String, Optional CalcField As Boolean = False, Optional CalcCriteria As Date)
    If CalcField Then
        Select Case CalcCriteria
            Case ExpMissingCalculated
                F.Visible = True: F.Caption = "Missing": F.ForeColor = RGB(255, 0, 0): F.FontWeight = 700: F.BorderStyle = 1: F.BorderColor = RGB(255, 0, 0)
            Case ExpOptionalCalculated
                F.Visible = True: F.Caption = "Optional": F.ForeColor = RGB(0, 0, 0): F.FontWeight = 400: F.BorderStyle = 0: F.BorderColor = RGB(0, 0, 0)
            Case ExpNACalculated
                F.Visible = True: F.Caption = "N/A": F.ForeColor = RGB(0, 0, 0): F.FontWeight = 400: F.BorderStyle = 0: F.BorderColor = RGB(0, 0, 0)
            Case Else
        End Select
    Else
        Select Case Criteria
            Case ExpMissing
                F.Visible = True: F.Caption = "Missing": F.ForeColor = RGB(255, 0, 0): F.FontWeight = 700: F.BorderStyle = 1: F.BorderColor = RGB(255, 0, 0)
            Case ExpPending
                F.Visible = True: F.Caption = "Pending": F.ForeColor = RGB(255, 0, 0): F.FontWeight = 700: F.BorderStyle = 1: F.BorderColor = RGB(255, 0, 0)
            Case ExpOptional
                F.Visible = True: F.Caption = "Optional": F.ForeColor = RGB(0, 0, 0): F.FontWeight = 400: F.BorderStyle = 0: F.BorderColor = RGB(0, 0, 0)
            Case ExpNA
                F.Visible = True: F.Caption = "N/A": F.ForeColor = RGB(0, 0, 0): F.FontWeight = 400: F.BorderStyle = 0: F.BorderColor = RGB(0, 0, 0)
            Case ExpCompleted
                F.Visible = True: F.Caption = "Completed": F.ForeColor = RGB(0, 0, 0): F.FontWeight = 400: F.BorderStyle = 0: F.BorderColor = RGB(0, 0, 0)
            Case Else
        End Select
    End If
End Sub

Public Sub FieldChanged(ChangeFlag As Boolean, DataField As Object)
    If ChangeFlag Then
        DataField.BackStyle = 1: DataField.BackColor = RGB(0, 255, 0): DataField.ForeColor = RGB(0, 0, 0)
    Else
        DataField.BackStyle = 0: DataField.ForeColor = RGB(255, 242, 0)
    End If
End Sub

Public Sub InitExpTriggers()
    Trig_Staff_BBP_Red = DLookup("Red", "catExpirationTriggers", "FieldName='BBP'")
    Trig_Staff_BBP_Green = DLookup("Green", "catExpirationTriggers", "FieldName='BBP'")

    Trig_Staff_CPR_Red = DLookup("Red", "catExpirationTriggers", "FieldName='CPR'")
    Trig_Staff_CPR_Green = DLookup("Green", "catExpirationTriggers", "FieldName='CPR'")

    Trig_Staff_DL_Red = DLookup("Red", "catExpirationTriggers", "FieldName='DriversLicense'")
    Trig_Staff_DL_Green = DLookup("Green", "catExpirationTriggers", "FieldName='DriversLicense'")

    Trig_Staff_FA_Red = DLookup("Red", "catExpirationTriggers", "FieldName='FirstAid'")
    Trig_Staff_FA_Green = DLookup("Green", "catExpirationTriggers", "FieldName='FirstAid'")

    Trig_Staff_SC_Red = DLookup("Red", "catExpirationTriggers", "FieldName='SafetyCares'")
    Trig_Staff_SC_Green = DLookup("Green", "catExpirationTriggers", "FieldName='SafetyCares'")

    Trig_Staff_TB_Red = DLookup("Red", "catExpirationTriggers", "FieldName='TB'")
    Trig_Staff_TB_Green = DLookup("Green", "catExpirationTriggers", "FieldName='TB'")

    Trig_Staff_WV_Red = DLookup("Red", "catExpirationTriggers", "FieldName='WorkplaceViolence'")
    Trig_Staff_WV_Green = DLookup("Green", "catExpirationTriggers", "FieldName='WorkplaceViolence'")

    Trig_Staff_PL_Red = DLookup("Red", "catExpirationTriggers", "FieldName='ProfLic'")
    Trig_Staff_PL_Green = DLookup("Green", "catExpirationTriggers", "FieldName='ProfLic'")

    Trig_Staff_MAP_Red = DLookup("Red", "catExpirationTriggers", "FieldName='MAPCert'")
    Trig_Staff_MAP_Green = DLookup("Green", "catExpirationTriggers", "FieldName='MAPCert'")

    Trig_Staff_EVL_Red = DLookup("Red", "catExpirationTriggers", "FieldName='EvalDueBy'")
    Trig_Staff_EVL_Green = DLookup("Green", "catExpirationTriggers", "FieldName='EvalDueBy'")

    Trig_Staff_3MO_Red = DLookup("Red", "catExpirationTriggers", "FieldName='3MoEval'")
    Trig_Staff_3MO_Green = 0

    Trig_Staff_SUP_Red = DLookup("Red", "catExpirationTriggers", "FieldName='LastSupervision'")
    Trig_Staff_SUP_Green = 0
    
    Trig_Staff_BIP_Red = DLookup("Red", "catExpirationTriggers", "FieldName='BackInjuryPrevention'")
    Trig_Staff_BIP_Green = DLookup("Green", "catExpirationTriggers", "FieldName='BackInjuryPrevention'")
    
    Trig_Res_LVC_Red = DLookup("Red", "catExpirationTriggers", "Program='Res' AND FieldName='LastVehicleChecklistCompleted'")
    Trig_Res_LVC_Green = 0

    Trig_Res_MRFD_Red = DLookup("Red", "catExpirationTriggers", "Program='Res' AND FieldName='MostRecentAsleepFireDrill'")
    Trig_Res_MRFD_Green = DLookup("Green", "catExpirationTriggers", "Program='Res' AND FieldName='MostRecentAsleepFireDrill'")

    Trig_Res_HPR_Red = DLookup("Red", "catExpirationTriggers", "Program='Res' AND FieldName='HousePlansReviewedByStaffBefore'")
    Trig_Res_HPR_Green = DLookup("Green", "catExpirationTriggers", "Program='Res' AND FieldName='HousePlansReviewedByStaffBefore'")
    
    Trig_Res_HSPE_Red = DLookup("Red", "catExpirationTriggers", "Program='Res' AND FieldName='HouseSafetyPlanExpires'")
    Trig_Res_HSPE_Green = DLookup("Green", "catExpirationTriggers", "Program='Res' AND FieldName='HouseSafetyPlanExpires'")

    Trig_Res_MAP_Red = DLookup("Red", "catExpirationTriggers", "Program='Res' AND FieldName='MAPChecklistCompleted'")
    Trig_Res_MAP_Green = 0

    Trig_Res_HROTS_Red = DLookup("Red", "catExpirationTriggers", "Program='Res' AND FieldName='HROTrainsStaffBefore'")
    Trig_Res_HROTS_Green = DLookup("Green", "catExpirationTriggers", "Program='Res' AND FieldName='HROTrainsStaffBefore'")

    Trig_Res_HROTI_Red = DLookup("Red", "catExpirationTriggers", "Program='Res' AND FieldName='HROTrainsIndividualsBefore'")
    Trig_Res_HROTI_Green = DLookup("Green", "catExpirationTriggers", "Program='Res' AND FieldName='HROTrainsIndividualsBefore'")

    Trig_Res_FSOTS_Red = DLookup("Red", "catExpirationTriggers", "Program='Res' AND FieldName='FSOTrainsStaffBefore'")
    Trig_Res_FSOTS_Green = DLookup("Green", "catExpirationTriggers", "Program='Res' AND FieldName='FSOTrainsStaffBefore'")

    Trig_Res_FSOTI_Red = DLookup("Red", "catExpirationTriggers", "Program='Res' AND FieldName='FSOTrainsIndividualsBefore'")
    Trig_Res_FSOTI_Green = DLookup("Green", "catExpirationTriggers", "Program='Res' AND FieldName='FSOTrainsIndividualsBefore'")
    
    Trig_Day_LVC_Red = DLookup("Red", "catExpirationTriggers", "Program='Day' AND FieldName='LastVehicleChecklistCompleted'")
    Trig_Day_LVC_Green = 0
    
    Trig_Day_STP_Red = DLookup("Red", "catExpirationTriggers", "Program='Day' AND FieldName='DAYStaffTrainedInPrivacyBefore'")
    Trig_Day_STP_Green = DLookup("Green", "catExpirationTriggers", "Program='Day' AND FieldName='DAYStaffTrainedInPrivacyBefore'")

    Trig_Day_APRS_Red = DLookup("Red", "catExpirationTriggers", "Program='Day' AND FieldName='DAYAllPlansReviewedByStaffBefore'")
    Trig_Day_APRS_Green = DLookup("Green", "catExpirationTriggers", "Program='Day' AND FieldName='DAYAllPlansReviewedByStaffBefore'")

    Trig_Day_QSR_Red = DLookup("Red", "catExpirationTriggers", "Program='Day' AND FieldName='DAYQtrlySafetyChecklistDueBy'")
    Trig_Day_QSR_Green = DLookup("Green", "catExpirationTriggers", "Program='Day' AND FieldName='DAYQtrlySafetyChecklistDueBy'")

    Trig_Day_HROTS_Red = DLookup("Red", "catExpirationTriggers", "Program='Day' AND FieldName='HROTrainsStaffBefore'")
    Trig_Day_HROTS_Green = DLookup("Green", "catExpirationTriggers", "Program='Day' AND FieldName='HROTrainsStaffBefore'")

    Trig_Day_HROTI_Red = DLookup("Red", "catExpirationTriggers", "Program='Day' AND FieldName='HROTrainsIndividualsBefore'")
    Trig_Day_HROTI_Green = DLookup("Green", "catExpirationTriggers", "Program='Day' AND FieldName='HROTrainsIndividualsBefore'")

    Trig_Day_FSOTS_Red = DLookup("Red", "catExpirationTriggers", "Program='Day' AND FieldName='FSOTrainsStaffBefore'")
    Trig_Day_FSOTS_Green = DLookup("Green", "catExpirationTriggers", "Program='Day' AND FieldName='FSOTrainsStaffBefore'")
    
    Trig_Day_FSOTI_Red = DLookup("Red", "catExpirationTriggers", "Program='Day' AND FieldName='FSOTrainsIndividualsBefore'")
    Trig_Day_FSOTI_Green = DLookup("Green", "catExpirationTriggers", "Program='Day' AND FieldName='FSOTrainsIndividualsBefore'")

    Trig_Indiv_ISP_Red = DLookup("Red", "catExpirationTriggers", "Section='Individuals' AND FieldName='DateISP'")
    Trig_Indiv_ISP_Green = DLookup("Green", "catExpirationTriggers", "Section='Individuals' AND FieldName='DateISP'")
    
    Trig_Indiv_PSDue_Green = DLookup("Green", "catExpirationTriggers", "Section='Individuals' AND FieldName='PSDue'")
    
    Trig_Indiv_CFS_Red = DLookup("Red", "catExpirationTriggers", "Section='Individuals' AND FieldName='DateConsentFormsSigned'")
    Trig_Indiv_CFS_Green = DLookup("Green", "catExpirationTriggers", "Section='Individuals' AND FieldName='DateConsentFormsSigned'")
    
    Trig_Indiv_BMMX_Red = DLookup("Red", "catExpirationTriggers", "Section='Individuals' AND FieldName='DateBMMExpires'")
    Trig_Indiv_BMMX_Green = DLookup("Green", "catExpirationTriggers", "Section='Individuals' AND FieldName='DateBMMExpires'")
    
    Trig_Indiv_BMMH_Red = DLookup("Red", "catExpirationTriggers", "Section='Individuals' AND FieldName='DateBMMAccessSignedHRC'")
    Trig_Indiv_BMMH_Green = 0
    
    Trig_Indiv_BMMS_Red = DLookup("Red", "catExpirationTriggers", "Section='Individuals' AND FieldName='DateBMMAccessSigned'")
    Trig_Indiv_BMMS_Green = 0
    
    Trig_Indiv_SPDX_Red = DLookup("Red", "catExpirationTriggers", "Section='Individuals' AND FieldName='DateSPDAuthExpires'")
    Trig_Indiv_SPDX_Green = DLookup("Green", "catExpirationTriggers", "Section='Individuals' AND FieldName='DateSPDAuthExpires'")

'   Trig_Indiv_SPDH_Red = DLookup("Red", "catExpirationTriggers", "Section='Individuals' AND FieldName='DateSignaturesDueBy'")
'   Trig_Indiv_SPDH_Green = 0

'   Trig_Indiv_SPDS_Red = DLookup("Red", "catExpirationTriggers", "Section='Individuals' AND FieldName='AllSPDSignaturesReceived'")
'   Trig_Indiv_SPDS_Green = 0
    
    Trig_Indiv_SPDA_Red = DLookup("Red", "catExpirationTriggers", "Section='Individuals' AND FieldName='DateSignaturesDueBy'")
    Trig_Indiv_SPDA_Green = DLookup("Green", "catExpirationTriggers", "Section='Individuals' AND FieldName='DateSignaturesDueBy'")
End Sub